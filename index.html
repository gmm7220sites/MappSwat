<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Personal SWAT (V4 - Gesti√≥n Inteligente)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' },
                        guinda: {
                            50: '#fdf2f2',
                            100: '#fde8e8',
                            500: '#9f1239', 
                            600: '#881337', 
                            700: '#800020', 
                            800: '#4c0519',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html.dark { color-scheme: dark; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }
        html.dark body {
            background-color: #0f172a;
            color: #cbd5e1;
        }

        /* --- ESTILOS DE FILA (LISTADO) --- */
        .slot-row {
            transition: all 0.2s ease;
            border-bottom: 1px solid #e2e8f0;
            border-left: 4px solid transparent; 
        }
        html.dark .slot-row {
            border-bottom-color: #334155;
        }
        .slot-row:last-child {
            border-bottom: none;
        }
        
        /* Puestos Resaltados */
        .slot-label-col {
            background-color: #f1f5f9;
            border-right: 1px solid #e2e8f0;
        }
        html.dark .slot-label-col {
            background-color: #1e293b;
            border-right-color: #334155;
        }

        /* Estado Vacante */
        .slot-empty-row {
            opacity: 0.8;
            border-left: 4px solid #cbd5e1; 
        }
        html.dark .slot-empty-row {
            border-left-color: #475569;
        }
        .slot-empty-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
            opacity: 1;
            border-left-color: #3b82f6;
        }

        /* Estado Ocupado */
        .slot-filled-row {
            background-color: white;
            border-left: 4px solid #22c55e;
        }
        html.dark .slot-filled-row {
            background-color: transparent;
            border-left-color: #16a34a;
        }
        .slot-filled-row:hover {
            background-color: #f8fafc;
        }
        html.dark .slot-filled-row:hover {
            background-color: #1e293b;
        }

        /* Cacheo */
        .cacheo-row {
            background-color: #eff6ff;
        }
        html.dark .cacheo-row {
            background-color: rgba(30, 58, 138, 0.15);
        }

        /* --- CONFLICTOS --- */
        .conflict-overlap { border-left-color: #f59e0b !important; background-color: #fffbeb !important; }
        html.dark .conflict-overlap { background-color: #451a03 !important; border-left-color: #f59e0b !important; }

        .conflict-repeat { border-left-color: #ef4444 !important; background-color: #fef2f2 !important; }
        html.dark .conflict-repeat { background-color: #450a0a !important; border-left-color: #ef4444 !important; }

        .conflict-role { border-left-color: #3b82f6 !important; background-color: #eff6ff !important; }
        html.dark .conflict-role { background-color: #172554 !important; border-left-color: #3b82f6 !important; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }

        /* --- MEN√ö LATERAL --- */
        #menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 2000; width: 50px; height: 50px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        html.dark #menu-toggle { background-color: rgba(30, 41, 59, 0.8); }
        #menu-toggle:hover { transform: scale(1.1); }

        #side-nav { 
            position: fixed; top: 0; left: 0; height: 100%; width: 250px; padding: 80px 0 20px; 
            background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 5px 0 25px rgba(0,0,0,0.05);
            z-index: 1999; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        html.dark #side-nav { background-color: rgba(15, 23, 42, 0.4); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        #side-nav.open { transform: translateX(0); }
        
        #side-nav .nav-button { 
            display: block; width: calc(100% - 24px); margin: 4px 12px; padding: 12px 16px; 
            border-radius: 8px; font-weight: 600; text-align: left; transition: all 0.2s; color: #475569; cursor: pointer; 
        }
        html.dark #side-nav .nav-button { color: #cbd5e1; }
        
        #side-nav .nav-button:hover:not(.active) { background-color: rgba(128, 0, 32, 0.08); color: #800020; }
        html.dark #side-nav .nav-button:hover:not(.active) { background-color: rgba(255, 255, 255, 0.1); color: #f1f5f9; }

        #side-nav .nav-button.active { background-color: #800020; color: white; box-shadow: 0 4px 10px rgba(128, 0, 32, 0.3); }
        html.dark #side-nav .nav-button.active { background-color: #9f1239; color: white; }

        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fefefe; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 12px; color: #1e293b; max-height: 90vh; display: flex; flex-direction: column; }
        html.dark .modal-content { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }

        .card-action-btn { padding: 4px; border-radius: 6px; transition: all 0.2s; opacity: 0.7; }
        .card-action-btn:hover { background-color: rgba(0,0,0,0.05); opacity: 1; transform: scale(1.1); }
        html.dark .card-action-btn:hover { background-color: rgba(255,255,255,0.1); }

        #loader { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; align-items: center; justify-content: center; }
        html.dark #loader { background-color: rgba(15, 23, 42, 0.8); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: none; align-items: center; justify-content: center; background-color: rgba(248, 250, 252, 0.7); backdrop-filter: blur(8px); }
        html.dark #login-overlay { background-color: rgba(15, 23, 42, 0.7); }
        
        /* Animaciones */
        @keyframes blink { 50% { opacity: 0.3; } }
        .notification-bell { animation: blink 1.5s infinite; cursor: help; color: #f59e0b; margin-left: 8px; }
        
        /* Indicador Circular */
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        html.dark .circle-bg { stroke: #334155; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .percentage-text { fill: #666; font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }
        html.dark .percentage-text { fill: #cbd5e1; }
        
        .icon-btn { background-color: #f1f5f9; border-radius: 9999px; padding: 0.5rem; transition: all 0.2s ease; cursor: pointer; }
        .icon-btn:hover { background-color: #e2e8f0; transform: scale(1.1); }
        html.dark .icon-btn { background-color: #334155; }
        html.dark .icon-btn:hover { background-color: #475569; }
        
        #search-panel { position: fixed; bottom: 80px; right: 20px; width: 300px; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); padding: 16px; z-index: 1000; transform: translateY(20px) scale(0.95); opacity: 0; transition: all 0.3s ease; pointer-events: none; }
        #search-panel.open { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        html.dark #search-panel { background-color: rgba(30, 41, 59, 0.9); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-3xl font-bold text-center text-slate-800 dark:text-white mb-6">Swat Security</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-slate-700 dark:text-slate-300 font-semibold mb-2">Usuario</label>
                    <input type="text" id="username" class="w-full p-3 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label class="block text-slate-700 dark:text-slate-300 font-semibold mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full p-3 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-lg font-bold text-slate-700 dark:text-slate-300">Cargando Sistema...</p>
        </div>
    </div>
    
    <!-- NOTIFICACIONES TOAST -->
    <div id="status-message-container" class="fixed top-4 right-4 z-[4000] flex flex-col gap-2 pointer-events-none"></div>

    <!-- NAVEGACI√ìN -->
    <button id="menu-toggle">
        <svg class="w-6 h-6 text-slate-800 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>
    <nav id="side-nav">
        <div class="px-6 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">AdminPanel</h2>
        </div>
        <button id="btn-mapeo" class="nav-button active">Mapeo Semanal</button>
        <button id="btn-gestion" class="nav-button">Gesti√≥n Locales/Personal</button>
        <button id="btn-programacion" class="nav-button">Programaci√≥n Individual</button>
        <button id="btn-tarifario" class="nav-button">Tarifario</button>
        <button id="btn-planillas" class="nav-button">Planillas</button>
        <button id="btn-historial" class="nav-button">Historial</button>
        <div class="mt-auto px-6 pb-6 pt-10">
             <button id="btn-logout" class="text-red-500 font-medium hover:text-red-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                Cerrar Sesi√≥n
             </button>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container mx-auto p-4 md:p-8 w-full main-content max-w-[1600px]"> 
        <header class="text-center mb-8 relative">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Mapeo Semanal</h1>
            <div class="absolute top-0 right-0 flex items-center gap-4">
                <div id="system-status-container" title="Estado del sistema">
                    <svg id="system-status-icon" class="h-6 w-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <main>
            <!-- 1. SECCI√ìN MAPEO -->
            <section id="section-mapeo">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <div class="flex flex-col lg:flex-row items-center gap-4 mb-6">
                        <div class="flex items-center gap-2">
                            <label class="font-semibold text-slate-700 dark:text-slate-300">Semana:</label>
                            <input type="week" id="semana-mapeo" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div class="flex-grow"></div>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button id="btn-copy-previous-week" class="bg-sky-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-sky-600 shadow-sm text-sm">Copiar Sem. Ant.</button>
                            <button id="btn-limpiar-mapeo" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 shadow-sm text-sm">Limpiar</button>
                            <button id="btn-descargar-excel" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 shadow-sm text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Excel
                            </button>
                            <button id="btn-copy-all-schedule" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 shadow-sm text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copiar Texto
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6" id="mapeo-container">
                        <!-- Tarjetas de Mapeo aqu√≠ -->
                    </div>
                </div>

                <!-- Bot√≥n Flotante y Panel de B√∫squeda -->
                <div id="search-fab" class="fixed bottom-6 right-6 z-50">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110">
                         <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
                <div id="search-panel">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-slate-700">Filtro R√°pido</label>
                        <button id="close-search-panel" class="text-slate-400 hover:text-red-500">&times;</button>
                    </div>
                    <input type="text" id="filtro-local-busqueda" placeholder="Buscar Local o Personal..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
            </section>

            <!-- 2. SECCI√ìN GESTI√ìN -->
            <section id="section-gestion" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Locales -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Locales</h2>
                        <form id="form-locales" class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input type="text" id="nuevo-local" placeholder="Nombre del nuevo local" class="flex-grow p-2 border rounded-md dark:bg-slate-700 dark:text-white" required>
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Agregar</button>
                        </form>
                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr><th class="p-3 text-slate-700 dark:text-slate-200">Local</th><th class="p-3 text-right text-slate-700 dark:text-slate-200">Acciones</th></tr>
                                </thead>
                                <tbody id="tabla-locales"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Personal -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Personal</h2>
                            <div class="flex gap-2">
                                <button id="btn-exportar-bd-personal" class="bg-emerald-500 text-white font-bold py-1 px-3 rounded text-sm hover:bg-emerald-600">Exportar</button>
                                <button onclick="document.getElementById('import-personal-input').click()" class="bg-sky-500 text-white font-bold py-1 px-3 rounded text-sm hover:bg-sky-600">Importar</button>
                                <input type="file" id="import-personal-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                        </div>
                        <button id="btn-abrir-modal-personal" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 mb-6">Agregar Personal Nuevo</button>
                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr><th class="p-3">ID</th><th class="p-3">Nombre</th><th class="p-3">Tel√©fono</th></tr>
                                </thead>
                                <tbody id="tabla-personal"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. SECCI√ìN PROGRAMACI√ìN -->
            <section id="section-programacion" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label class="font-semibold dark:text-white">Semana:</label>
                        <input type="week" id="semana-programacion" class="p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                        <input type="text" id="busqueda-programacion" placeholder="Filtrar por nombre..." class="flex-grow p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                    </div>
                    <div id="programacion-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </section>

            <!-- 4. SECCI√ìN TARIFARIO -->
            <section id="section-tarifario" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold dark:text-white">Tarifario Individual (S/)</h2>
                            <p class="text-sm text-slate-500">Auto-guardado habilitado.</p>
                        </div>
                         <div class="flex items-center gap-2">
                            <button id="btn-exportar-tarifario" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded hover:bg-emerald-600 text-sm">Exportar</button>
                            <button onclick="document.getElementById('import-tarifario-input').click()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded hover:bg-sky-600 text-sm">Importar</button>
                            <input type="file" id="import-tarifario-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                        <input type="text" id="busqueda-tarifario" placeholder="Buscar..." class="w-full md:w-64 p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                    </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 dark:bg-slate-700">
                                <tr>
                                    <th class="p-3 font-semibold dark:text-white">Nombre Completo</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü§µ TERNO</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü•ã T√ÅCTICA</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü§ù APOYO</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-tarifario"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 5. SECCI√ìN PLANILLAS -->
            <section id="section-planillas" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label class="font-semibold dark:text-white">Semana:</label>
                        <input type="week" id="semana-planillas" class="p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                        <div class="flex-grow"></div>
                        <button id="btn-exportar-planilla" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-600">Descargar Planilla</button>
                    </div>
                    <div id="planillas-container" class="space-y-8"></div>
                </div>
            </section>
            
            <!-- 6. SECCI√ìN HISTORIAL -->
            <section id="section-historial" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 dark:text-white">Historial de Mapeos Guardados</h2>
                    <div id="historial-container" class="overflow-x-auto"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- === MODALES === -->

    <!-- Modal Selecci√≥n Global -->
    <div id="global-selection-modal" class="modal">
        <div class="modal-content w-full max-w-md h-[80vh] bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-2xl flex flex-col">
            <div class="p-4 border-b dark:border-slate-700 flex items-center justify-between bg-white dark:bg-slate-800 z-10 shrink-0">
                <div><h3 class="text-lg font-bold text-slate-800 dark:text-white">Asignar Personal</h3><p id="modal-slot-info" class="text-xs text-slate-500">...</p></div>
                <button id="close-global-modal" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-900/50 shrink-0">
                <input type="text" id="modal-search" placeholder="Buscar por nombre..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:text-white">
                <button id="btn-unassign-slot" class="mt-2 w-full py-2 text-xs font-semibold text-red-500 hover:bg-red-50 border border-red-200 rounded-lg">Quitar Asignaci√≥n (Dejar Vac√≠o)</button>
            </div>
            <div id="modal-list-container" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Personal -->
    <div id="personal-modal" class="modal">
        <div class="modal-content !max-w-3xl dark:bg-slate-800 dark:border-slate-700">
            <h3 id="personal-modal-title" class="text-2xl font-bold mb-4 dark:text-white">Gesti√≥n Personal</h3>
            <form id="form-personal" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="personal-id">
                <div><label class="text-sm dark:text-slate-300">N¬∫ Empleado</label><input type="text" id="numero_empleado" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Nombre</label><input type="text" id="nombre" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" required></div>
                <div><label class="text-sm dark:text-slate-300">Apellidos</label><input type="text" id="apellido" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Tel√©fono</label><input type="tel" id="telefono" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Disponibilidad</label><select id="disponibilidad" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"><option value="disponible">Disponible</option><option value="no-disponible">No Disponible</option></select></div>
                
                <div class="md:col-span-2 grid grid-cols-3 gap-2">
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 1</label><select id="local1" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 2</label><select id="local2" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 3</label><select id="local3" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                </div>

                <div class="md:col-span-2 flex justify-end gap-3 mt-4">
                    <button type="button" id="close-personal-modal" class="bg-slate-300 py-2 px-4 rounded hover:bg-slate-400">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Vista R√°pida Personal -->
    <div id="view-personal-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <div class="flex justify-between items-start">
                <h3 id="view-personal-name" class="text-2xl font-bold mb-4 dark:text-white"></h3>
                <button type="button" id="close-view-personal-modal" class="text-3xl font-bold text-slate-500">&times;</button>
            </div>
            <div id="view-personal-details" class="text-sm dark:text-slate-300 space-y-2 mb-6"></div>
            <div class="flex justify-end gap-4">
                <button type="button" id="btn-eliminar-personal-view" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600">Eliminar</button>
                <button type="button" id="btn-editar-personal-view" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded hover:bg-yellow-600">Editar</button>
            </div>
        </div>
    </div>

    <!-- Modal Config Horarios -->
    <div id="schedule-config-modal" class="modal">
        <div class="modal-content !max-w-4xl max-h-[90vh] flex flex-col dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4 p-4 border-b dark:border-slate-700">
                <h3 class="text-2xl font-bold dark:text-white">Horarios: <span id="schedule-config-local-name" class="text-blue-600"></span></h3>
                <button id="close-schedule-config-modal" class="text-3xl text-slate-500">&times;</button>
            </div>
            <div id="schedule-config-container" class="space-y-6 flex-grow overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900"></div>
            <div class="mt-auto p-4 border-t flex justify-end items-center gap-4 bg-white dark:bg-slate-800 rounded-b-xl">
                 <button type="button" id="btn-limpiar-horarios-local" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 mr-auto">Resetear Local</button>
                 <button type="button" id="btn-guardar-horarios" class="bg-green-600 text-white font-bold py-2 px-5 rounded hover:bg-green-700 shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <p id="confirmation-modal-text" class="mb-6 text-lg dark:text-white"></p>
            <div class="flex justify-end gap-4">
                <button id="confirmation-modal-cancel" class="bg-slate-300 py-2 px-4 rounded hover:bg-slate-400">Cancelar</button>
                <button id="confirmation-modal-confirm" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Edici√≥n Local -->
    <div id="edit-local-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <h3 class="text-2xl font-bold mb-4 dark:text-white">Editar Local</h3>
            <form id="form-edit-local" class="flex flex-col gap-4">
                <input type="hidden" id="edit-local-id">
                <input type="text" id="edit-local-name" placeholder="Nombre" class="p-2 border rounded dark:bg-slate-700 dark:text-white" required>
                <div class="flex items-center gap-4">
                    <label class="dark:text-white">Color:</label>
                    <input type="color" id="edit-local-color" class="h-10 w-10">
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded">Guardar</button>
                    <button type="button" id="close-local-modal" class="flex-1 bg-slate-300 py-2 px-4 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTACIONES FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, updateDoc, deleteField, serverTimestamp, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
        import { getDatabase, ref, set, onDisconnect, serverTimestamp as rtdbTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";

        // 2. CONFIGURACI√ìN
        const firebaseConfig = { apiKey: "AIzaSyBwtZ8Kdvw4LJyu3t0QeaBgq6_0Z_9jrvw", authDomain: "swattmapee.firebaseapp.com", databaseURL: "https://swattmapee-default-rtdb.firebaseio.com", projectId: "swattmapee", storageBucket: "swattmapee.appspot.com", messagingSenderId: "522791414169", appId: "1:522791414169:web:7c2d3c567fbd1d5703cb08" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const appId = "mapeo-app-v2";
        const basePath = `artifacts/${appId}/public/data`;
        const collections = {
            personal: collection(db, `${basePath}/personal`),
            locales: collection(db, `${basePath}/locales`),
            mapeoConfig: collection(db, `${basePath}/mapeoConfig`),
            asignaciones: collection(db, `${basePath}/asignaciones`),
            historial: collection(db, `${basePath}/historial`),
            tarifarios: collection(db, `${basePath}/tarifarios`),
            status: collection(db, `${basePath}/status`)
        };

        // 3. ESTADO GLOBAL
        const diasSemana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        const vestimentaEmojis = { 'Ropa T√°ctica': 'ü•ã', 'Terno': 'ü§µ' };
        let state = { personal: [], locales: [], mapeoConfig: {}, asignaciones: {}, historial: {}, tarifarios: {}, selectedWeek: '' };
        let listeners = { asignaciones: null };
        let tempScheduleConfig = {}; 
        let currentSlotId = null;
        let currentlyEditingLocal = null;
        
        // Estado de conflictos
        let conflictMap = {
            overlap: new Set(), // Amarillo
            repeat: new Set(),  // Rojo
            role: new Set()     // Azul
        };

        // 4. FUNCIONES DE UTILIDAD
        const getEl = (id) => document.getElementById(id);
        const showToast = (msg, type = 'success') => {
            const container = getEl('status-message-container');
            const div = document.createElement('div');
            div.className = `${type==='success'?'bg-green-600':'bg-red-600'} text-white px-4 py-3 rounded shadow-lg animate-bounce pointer-events-auto cursor-pointer`;
            div.textContent = msg;
            div.onclick = () => div.remove();
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        };
        const getFullName = (p) => p ? `${p.nombre || ''} ${p.apellido || ''}`.trim() : 'N/A';
        const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
        
        const timeToMin = (timeStr) => {
            if(!timeStr) return -1;
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);
            if(period === 'PM' && hours !== 12) hours += 12;
            if(period === 'AM' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        };

        // Copiado Seguro
        const copiarTextoSeguro = async (texto) => {
            try {
                await navigator.clipboard.writeText(texto);
                showToast("¬°Copiado al portapapeles!");
            } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = texto;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("¬°Copiado (m√©todo alt.)!");
                } catch (err2) {
                    showToast("Error al copiar", "error");
                }
                document.body.removeChild(textArea);
            }
        };

        // 5. RENDERIZADO
        function renderLocalesSelects() {
            const opts = `<option value="">Ninguno</option>` + state.locales.map(l => `<option value="${l.nombre}">${l.nombre.toUpperCase()}</option>`).join('');
            ['local1', 'local2', 'local3'].forEach(id => getEl(id).innerHTML = opts);
        }

        function createSlot(slotId, tipo, horario, idx) {
            const week = state.selectedWeek;
            const pid = state.asignaciones[week]?.[slotId];
            const div = document.createElement('div');
            
            const tipoLabelMap = {
                'puestos':'Puesto', 'cacheos':'Cacheo', 'cacheoIngreso':'Ingreso', 'cacheoSalida':'Salida',
                'turno1': '1er Turno', 'turno2': '2do Turno', 'turno3': '3er Turno', 'porteria': 'Porter√≠a'
            };
            const tipoLabel = tipoLabelMap[tipo] || tipo;
            
            let baseClass = "slot-empty-row";
            let content = "";
            let bgClass = ""; 

            if (pid) {
                baseClass = "slot-filled-row";
                
                if (conflictMap.overlap.has(slotId)) bgClass = "conflict-overlap";
                else if (conflictMap.role.has(slotId)) bgClass = "conflict-role";
                else if (conflictMap.repeat.has(slotId)) bgClass = "conflict-repeat";
                
                if (!bgClass && ['cacheos','cacheoIngreso','cacheoSalida'].includes(tipo)) {
                    bgClass = "cacheo-row";
                }

                const p = state.personal.find(x => x.id === pid);
                const vest = state.asignaciones[week]?.[`${slotId}-vestimenta`] || 'Ropa T√°ctica';
                const conf = state.asignaciones[week]?.[`${slotId}-confirmed`];
                
                content = `
                    <div class="slot-label-col w-28 shrink-0 flex flex-col justify-center p-2">
                        <span class="text-[10px] font-bold uppercase">${tipoLabel} #${idx}</span>
                        <div class="text-[9px] text-slate-500">${horario}</div>
                    </div>
                    <div class="flex-grow p-2 font-semibold text-sm truncate dark:text-slate-100">${getFullName(p)}</div>
                    <div class="flex gap-1 shrink-0 p-2">
                        <button class="vestimenta-btn text-lg hover:bg-slate-200 rounded px-1" data-slot="${slotId}" title="Cambiar Vestimenta">${vestimentaEmojis[vest]}</button>
                        <button class="conf-btn text-lg hover:bg-slate-200 rounded px-1" data-slot="${slotId}" title="Confirmar">${conf ? '‚úÖ' : '‚¨ú'}</button>
                    </div>`;
            } else {
                if (['cacheos','cacheoIngreso','cacheoSalida'].includes(tipo)) bgClass = "cacheo-row";
                content = `
                    <div class="slot-label-col w-28 shrink-0 flex flex-col justify-center p-2 opacity-50">
                        <span class="text-[10px] font-bold uppercase">${tipoLabel} #${idx}</span>
                        <div class="text-[9px] text-slate-500">${horario}</div>
                    </div>
                    <div class="flex-grow flex items-center gap-2 text-slate-400 group-hover:text-blue-500 p-2">
                        <span class="text-xs font-medium">Asignar</span>
                    </div>`;
            }
            
            div.className = `slot-row flex items-center cursor-pointer group ${baseClass} ${bgClass}`;
            div.innerHTML = content;
            div.dataset.slotId = slotId;
            return div;
        }

        function calculateConflicts() {
            conflictMap.overlap.clear();
            conflictMap.repeat.clear();
            conflictMap.role.clear();

            const week = state.selectedWeek;
            const weekAsig = state.asignaciones[week] || {};
            const shiftsByPerson = {};

            Object.entries(weekAsig).forEach(([slotId, pid]) => {
                if(!pid || typeof pid !== 'string' || !slotId.includes('-') || slotId.endsWith('vestimenta') || slotId.endsWith('confirmed')) return;
                
                const [local, dia, tipo] = slotId.split('-');
                const conf = state.mapeoConfig[local]?.[dia];
                
                if(!conf) return;
                
                const hIn = conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`];
                const hOut = conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`];
                
                if(!hIn || !hOut) return;

                const start = timeToMin(hIn);
                let end = timeToMin(hOut);
                if (end < start) end += 24*60; 

                const dayOffset = diasSemana.indexOf(dia) * 1440;
                
                if(!shiftsByPerson[pid]) shiftsByPerson[pid] = [];
                shiftsByPerson[pid].push({
                    slotId,
                    dia,
                    tipo,
                    globalStart: start + dayOffset,
                    globalEnd: end + dayOffset
                });
            });

            Object.values(shiftsByPerson).forEach(shifts => {
                const shiftsByDay = {};
                shifts.forEach(s => {
                    if(!shiftsByDay[s.dia]) shiftsByDay[s.dia] = [];
                    shiftsByDay[s.dia].push(s);
                });

                Object.values(shiftsByDay).forEach(dayShifts => {
                    const hasPuesto = dayShifts.some(s => s.tipo === 'puestos');
                    const hasCacheo = dayShifts.some(s => ['cacheos','cacheoIngreso','cacheoSalida'].includes(s.tipo));
                    
                    if(hasPuesto && hasCacheo) {
                        dayShifts.forEach(s => conflictMap.role.add(s.slotId));
                    }
                    if(dayShifts.length > 1) {
                        dayShifts.forEach(s => conflictMap.repeat.add(s.slotId));
                    }
                });

                for(let i=0; i<shifts.length; i++) {
                    for(let j=i+1; j<shifts.length; j++) {
                        const s1 = shifts[i];
                        const s2 = shifts[j];
                        if(s1.globalStart < s2.globalEnd && s2.globalStart < s1.globalEnd) {
                            conflictMap.overlap.add(s1.slotId);
                            conflictMap.overlap.add(s2.slotId);
                            conflictMap.repeat.delete(s1.slotId);
                            conflictMap.repeat.delete(s2.slotId);
                        }
                    }
                }
            });
        }

        function renderMapeo() {
            calculateConflicts();

            const container = getEl('mapeo-container');
            container.innerHTML = '';
            const week = state.selectedWeek;
            if (!week) return;

            const term = getEl('filtro-local-busqueda').value.toLowerCase();
            const filteredLocales = state.locales.filter(l => l.nombre.toLowerCase().includes(term));

            filteredLocales.forEach(local => {
                const config = state.mapeoConfig[local.nombre] || {};
                let hasSlots = false;
                let totalSlots = 0;
                let filledSlots = 0;
                
                const allTypes = ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'];

                diasSemana.forEach(d => {
                    allTypes.forEach(t => {
                        const count = parseInt(config[d]?.[t] || 0);
                        if(count > 0) {
                            hasSlots = true;
                            totalSlots += count;
                            for(let i=1; i<=count; i++) {
                                if(state.asignaciones[week]?.[`${local.nombre}-${d}-${t}-${i}`]) {
                                    filledSlots++;
                                }
                            }
                        }
                    });
                });

                if (!hasSlots) return;

                const percent = totalSlots > 0 ? Math.round((filledSlots / totalSlots) * 100) : 0;
                let strokeColor = "#ef4444"; 
                if(percent >= 50) strokeColor = "#f59e0b"; 
                if(percent >= 100) strokeColor = "#22c55e"; 

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-850 rounded-xl shadow-md border-t-4 border-slate-200 flex flex-col h-full";
                card.style.borderTopColor = local.color || '#cbd5e1';
                
                let bodyHtml = `<div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-lg dark:text-white">${local.nombre.toUpperCase()}</h3>
                        <div class="relative w-10 h-10">
                            <svg class="circular-chart" viewBox="0 0 36 36">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke="${strokeColor}" stroke-dasharray="${percent}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <span class="percentage-text absolute inset-0 flex items-center justify-center text-[10px] font-bold dark:text-white">${percent}%</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <button class="btn-vestimenta-local text-slate-400 hover:text-purple-500" data-local="${local.nombre}" title="Cambiar Vestimenta a Todos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                         </button>
                         <button class="btn-copy-local text-slate-400 hover:text-blue-500" data-local="${local.nombre}" title="Copiar"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg></button>
                         <button class="btn-config-local text-slate-400 hover:text-blue-500" data-nombre="${local.nombre}" title="Configurar"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.44-.165a2.25 2.25 0 012.22 0l.44.165c.55.219 1.02.684 1.11 1.226l.098.588a2.25 2.25 0 002.25 2.25h.588c.542 0 1.007.368 1.226.918l.165.441a2.25 2.25 0 01-2.22 0l-.441-.165c-.55-.219-1.02-.684-1.11-1.226l-.098-.588a2.25 2.25 0 00-2.25-2.25v.588c0 .542-.368 1.007-.918 1.226l-.441.165a2.25 2.25 0 01-2.22 0l-.441-.165c-.55-.219-1.02-.684-1.11-1.226l-.098-.588a2.25 2.25 0 00-2.25-2.25h-.588c-.542 0-1.007-.368-1.226-.918l-.165-.441a2.25 2.25 0 010 2.22l.165-.441c.219-.55.684 1.02 1.226-1.11h.588a2.25 2.25 0 002.25-2.25v-.588zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z"/></svg></button>
                    </div>
                </div><div class="p-2 space-y-2">`;
                
                const bodyDiv = document.createElement('div');
                bodyDiv.innerHTML = bodyHtml;
                const contentDiv = bodyDiv.lastElementChild;

                diasSemana.forEach(dia => {
                    const dConf = config[dia] || {};
                    const activeTypes = allTypes.filter(t => parseInt(dConf[t] || 0) > 0);
                    if (activeTypes.length === 0) return;
                    
                    const diaBlock = document.createElement('div');
                    diaBlock.innerHTML = `<h4 class="text-xs font-bold uppercase bg-slate-100 dark:bg-slate-700 p-1 rounded mb-1 dark:text-slate-300">${dia}</h4>`;
                    const slotsList = document.createElement('div');
                    
                    activeTypes.forEach(tipo => {
                        const count = parseInt(dConf[tipo]);
                        const hIn = dConf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] || '';
                        const hOut = dConf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`] || '';
                        const horario = hIn && hOut ? `${hIn}-${hOut}` : '';
                        
                        for(let i=1; i<=count; i++) {
                            slotsList.appendChild(createSlot(`${local.nombre}-${dia}-${tipo}-${i}`, tipo, horario, i));
                        }
                    });
                    diaBlock.appendChild(slotsList);
                    contentDiv.appendChild(diaBlock);
                });
                
                card.appendChild(bodyDiv);
                card.lastElementChild.appendChild(contentDiv);
                container.appendChild(card);
            });
        }

        function renderConfigModal(localNombre) {
            const container = getEl('schedule-config-container');
            container.innerHTML = '';
            const localConf = tempScheduleConfig;
            
            diasSemana.forEach(dia => {
                if(!localConf[dia]) localConf[dia] = {};
                const div = document.createElement('div');
                div.className = "p-4 bg-white dark:bg-slate-700 rounded border dark:border-slate-600";
                
                let html = `<h4 class="font-bold mb-2 capitalize dark:text-white">${dia}</h4>`;
                
                // Nuevos tipos incluidos aqu√≠
                ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'].forEach(tipo => {
                    const cKey = `hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}`;
                    const cant = localConf[dia][tipo] || 0;
                    const ent = localConf[dia][cKey+'Entrada'] || '08:00 AM';
                    const sal = localConf[dia][cKey+'Salida'] || '08:00 PM';
                    
                    // Nombres amigables
                    const labelMap = {
                        'puestos': 'Puestos', 'cacheos': 'Cacheos', 'cacheoIngreso': 'C. Ingreso', 'cacheoSalida': 'C. Salida',
                        'turno1': '1er Turno', 'turno2': '2do Turno', 'turno3': '3er Turno', 'porteria': 'Porter√≠a'
                    };

                    html += `
                    <div class="grid grid-cols-4 gap-2 items-center mb-2">
                        <label class="text-xs font-medium dark:text-slate-300">${labelMap[tipo]}</label>
                        <input type="number" min="0" class="p-1 border rounded text-center config-input" data-dia="${dia}" data-tipo="${tipo}" value="${cant}">
                        <input type="text" class="p-1 border rounded text-center text-xs config-time" data-dia="${dia}" data-key="${cKey}Entrada" value="${ent}">
                        <input type="text" class="p-1 border rounded text-center text-xs config-time" data-dia="${dia}" data-key="${cKey}Salida" value="${sal}">
                    </div>`;
                });
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        // --- SISTEMA DE ESTADO / PING ---
        function setupSystemStatus() {
            const statusRef = doc(collections.status, 'ping');
            onSnapshot(statusRef, (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.timestamp) {
                        const latency = Date.now() - data.timestamp.toMillis();
                        updateStatusIcon(latency);
                    }
                }
            });
            setInterval(() => {
                setDoc(statusRef, { timestamp: serverTimestamp() })
                    .catch(err => console.warn("Ping fallido (offline)", err));
            }, 10000);
        }

        function updateStatusIcon(latency) {
            const icon = getEl('system-status-icon');
            icon.classList.remove('text-slate-300', 'text-green-500', 'text-yellow-500', 'text-red-500');
            if (latency < 800) {
                icon.classList.add('text-green-500'); 
                icon.parentElement.title = `Conexi√≥n: Excelente (${latency}ms)`;
            } else if (latency < 2000) {
                icon.classList.add('text-yellow-500');
                icon.parentElement.title = `Conexi√≥n: Regular (${latency}ms)`;
            } else {
                icon.classList.add('text-red-500');
                icon.parentElement.title = `Conexi√≥n: Lenta (${latency}ms)`;
            }
        }

        // 6. EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', async () => {
            getEl('loader').style.display = 'flex';
            
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Error Auth", e);
                showToast("Error de conexi√≥n", "error");
            }

            const now = new Date();
            const w = `${now.getFullYear()}-W${String(getWeekNumber(now)).padStart(2,'0')}`;
            state.selectedWeek = w;
            
            ['semana-mapeo','semana-programacion','semana-planillas'].forEach(id => {
                const el = getEl(id);
                if(el) el.value = w;
            });
            
            setupListeners();
            setupUIListeners();
            setupSystemStatus();
            
            getEl('login-overlay').style.display = 'flex';
            getEl('loader').style.display = 'none';
        });

        function setupListeners() {
            onSnapshot(query(collections.locales), snap => {
                state.locales = snap.docs.map(d => ({id:d.id, ...d.data()}))
                    .sort((a,b) => a.nombre.localeCompare(b.nombre)); // ORDEN ALFAB√âTICO
                renderLocalesSelects();
                renderTable('tabla-locales', state.locales, (l) => `
                    <td class="p-3 font-medium flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color:${l.color}"></span>${l.nombre.toUpperCase()}</td>
                    <td class="p-3 text-right">
                        <button class="text-indigo-500 hover:text-indigo-700 font-medium mr-2 btn-config-local-gestion" data-nombre="${l.nombre}">Horarios</button>
                        <button class="text-blue-500 mr-2 btn-edit-local" data-id="${l.id}">Editar</button>
                        <button class="text-red-500 btn-del-local" data-id="${l.id}">Eliminar</button>
                    </td>`);
                renderMapeo();
            });

            onSnapshot(query(collections.personal), snap => {
                state.personal = snap.docs.map(d => ({id:d.id, ...d.data()}))
                    .sort((a, b) => {
                        // ORDEN NUM√âRICO (ID) o ALFAB√âTICO (NOMBRE)
                        const numA = parseInt(a.numero_empleado) || 999999;
                        const numB = parseInt(b.numero_empleado) || 999999;
                        if (numA !== numB) return numA - numB;
                        return (a.nombre || '').localeCompare(b.nombre || '');
                    });
                renderTable('tabla-personal', state.personal, (p) => `
                    <td class="p-3">${p.numero_empleado||'-'}</td>
                    <td class="p-3 font-medium cursor-pointer text-blue-600 hover:underline" onclick="window.verPersonal('${p.id}')">${getFullName(p)}</td>
                    <td class="p-3">${p.telefono||'-'}</td>`);
                if(getEl('loader').style.display === 'flex') getEl('loader').style.display = 'none';
            });

            onSnapshot(query(collections.mapeoConfig), snap => {
                state.mapeoConfig = {};
                snap.docs.forEach(d => state.mapeoConfig[d.id] = d.data());
                renderMapeo();
            });

            onSnapshot(query(collections.historial), snap => {
                const hContainer = getEl('historial-container');
                hContainer.innerHTML = '';
                snap.docs.forEach(d => {
                    const btn = document.createElement('div');
                    btn.className = "p-3 bg-white dark:bg-slate-700 border mb-2 rounded flex justify-between";
                    btn.innerHTML = `<span>Semana ${d.id}</span> <button class="text-blue-500 font-bold" onclick="window.loadHist('${d.id}')">Cargar</button>`;
                    hContainer.appendChild(btn);
                });
            });

            onSnapshot(query(collections.tarifarios), snap => {
                state.tarifarios = {};
                snap.docs.forEach(d => state.tarifarios[d.id] = d.data());
                renderTarifarioTable();
            });
            
            watchWeek(state.selectedWeek);
        }

        function watchWeek(week) {
            if(!week) return;
            if(listeners.asignaciones) listeners.asignaciones(); 
            listeners.asignaciones = onSnapshot(doc(collections.asignaciones, week), snap => {
                state.asignaciones[week] = snap.exists() ? snap.data() : {};
                renderMapeo();
                renderProgramacion();
                renderPlanillas();
            });
        }

        function setupUIListeners() {
            getEl('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if(getEl('username').value === 'adminswat' && getEl('password').value === 'adminswat') {
                    getEl('login-overlay').style.display = 'none';
                    setupListeners();
                } else {
                    getEl('login-error').textContent = "Credenciales incorrectas";
                }
            });
            getEl('btn-logout').onclick = () => {
                location.reload();
            };

            ['semana-mapeo', 'semana-programacion', 'semana-planillas'].forEach(id => {
                getEl(id).addEventListener('change', (e) => {
                    state.selectedWeek = e.target.value;
                    ['semana-mapeo', 'semana-programacion', 'semana-planillas'].forEach(i => getEl(i).value = state.selectedWeek);
                    watchWeek(state.selectedWeek);
                });
            });

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    const sec = e.target.id.replace('btn-', 'section-');
                    getEl(sec).classList.remove('hidden');
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    getEl('side-nav').classList.remove('open');
                    
                    if(sec === 'section-tarifario') renderTarifarioTable();
                    if(sec === 'section-programacion') renderProgramacion();
                    if(sec === 'section-planillas') renderPlanillas();
                });
            });

            const nav = getEl('side-nav');
            const toggle = getEl('menu-toggle');
            let navTimeout;
            
            const openMenu = () => { clearTimeout(navTimeout); nav.classList.add('open'); };
            const closeMenu = () => { navTimeout = setTimeout(() => nav.classList.remove('open'), 300); };
            
            toggle.addEventListener('mouseenter', openMenu);
            nav.addEventListener('mouseenter', openMenu);
            nav.addEventListener('mouseleave', closeMenu);
            toggle.onclick = () => nav.classList.toggle('open'); 

            getEl('search-fab').onclick = () => getEl('search-panel').classList.toggle('open');
            getEl('close-search-panel').onclick = () => getEl('search-panel').classList.remove('open');
            getEl('filtro-local-busqueda').addEventListener('input', renderMapeo);

            getEl('mapeo-container').addEventListener('click', async (e) => {
                const slotRow = e.target.closest('.slot-row');
                if(slotRow && !e.target.closest('button')) {
                    currentSlotId = slotRow.dataset.slotId;
                    renderModalPersonalList();
                    getEl('global-selection-modal').style.display = 'block';
                    getEl('modal-search').value = '';
                    getEl('modal-search').focus();
                }

                const btnVest = e.target.closest('.vestimenta-btn');
                if(btnVest) {
                    const sid = btnVest.dataset.slot;
                    const cur = state.asignaciones[state.selectedWeek][`${sid}-vestimenta`] || 'Ropa T√°ctica';
                    const next = cur === 'Ropa T√°ctica' ? 'Terno' : 'Ropa T√°ctica';
                    await setDoc(doc(collections.asignaciones, state.selectedWeek), { [`${sid}-vestimenta`]: next }, {merge:true});
                }
                
                const btnConf = e.target.closest('.conf-btn');
                if(btnConf) {
                    const sid = btnConf.dataset.slot;
                    const cur = state.asignaciones[state.selectedWeek][`${sid}-confirmed`];
                    await setDoc(doc(collections.asignaciones, state.selectedWeek), { [`${sid}-confirmed`]: !cur }, {merge:true});
                }

                const btnConfig = e.target.closest('.btn-config-local');
                if(btnConfig) {
                    currentlyEditingLocal = btnConfig.dataset.nombre;
                    getEl('schedule-config-local-name').textContent = currentlyEditingLocal;
                    tempScheduleConfig = JSON.parse(JSON.stringify(state.mapeoConfig[currentlyEditingLocal] || {}));
                    renderConfigModal(currentlyEditingLocal);
                    getEl('schedule-config-modal').style.display = 'flex';
                }
                
                const btnCopy = e.target.closest('.btn-copy-local');
                if(btnCopy) {
                    const local = btnCopy.dataset.local;
                    generateTextSchedule(local);
                }

                const btnVestAll = e.target.closest('.btn-vestimenta-local');
                if(btnVestAll) {
                    if(!confirm("¬øCambiar vestimenta de TODOS en este local?")) return;
                    const localName = btnVestAll.dataset.local;
                    const weekData = state.asignaciones[state.selectedWeek];
                    const batchUpdate = {};
                    
                    Object.keys(weekData).forEach(key => {
                        if(key.startsWith(localName + '-') && !key.endsWith('vestimenta') && !key.endsWith('confirmed')) {
                            const curVest = weekData[`${key}-vestimenta`] || 'Ropa T√°ctica';
                            const newVest = curVest === 'Ropa T√°ctica' ? 'Terno' : 'Ropa T√°ctica';
                            batchUpdate[`${key}-vestimenta`] = newVest;
                        }
                    });
                    
                    if(Object.keys(batchUpdate).length > 0) {
                        await setDoc(doc(collections.asignaciones, state.selectedWeek), batchUpdate, {merge:true});
                        showToast("Vestimenta actualizada");
                    } else {
                        showToast("No hay personal asignado", "error");
                    }
                }
            });

            getEl('programacion-container').addEventListener('click', async (e) => {
                const btnCopy = e.target.closest('.btn-copy-individual');
                if(btnCopy) {
                    const pid = btnCopy.dataset.personId;
                    const p = state.personal.find(x => x.id === pid);
                    const weekAsig = state.asignaciones[state.selectedWeek] || {};
                    const shifts = Object.entries(weekAsig)
                        .filter(([k, v]) => v === pid && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed'))
                        .map(([k]) => {
                            const [local, dia, tipo] = k.split('-');
                            const conf = state.mapeoConfig[local]?.[dia];
                            const vestimenta = weekAsig[`${k}-vestimenta`] || 'Ropa T√°ctica';
                            const hOut = conf?.[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`] || '';
                            return { 
                                dia: capitalize(dia), 
                                local, 
                                horaSalida: hOut,
                                vestimenta,
                                order: diasSemana.indexOf(dia) 
                            };
                        })
                        .sort((a,b) => a.order - b.order);

                    if(shifts.length === 0) return showToast("Sin turnos para copiar", "error");

                    let text = `¬°Hola ${p.nombre}! Tu programaci√≥n es la siguiente:\n\n`;
                    shifts.forEach(s => {
                        text += `* ${s.dia} en ${s.local.toUpperCase()}: ${s.horaSalida} Vestimenta: ${s.vestimenta}.\n`;
                    });
                    text += `\nMANDAME TU CONFIRMACI√ìN ‚úÖ`;
                    
                    copiarTextoSeguro(text);
                }

                const btnConf = e.target.closest('.btn-confirm-individual');
                if(btnConf) {
                    if(!confirm("¬øConfirmar todos los turnos de esta persona?")) return;
                    
                    const pid = btnConf.dataset.personId;
                    const weekAsig = state.asignaciones[state.selectedWeek] || {};
                    const batchData = {};
                    
                    Object.entries(weekAsig)
                        .filter(([k, v]) => v === pid && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed'))
                        .forEach(([k]) => {
                            batchData[`${k}-confirmed`] = true;
                        });
                    
                    if(Object.keys(batchData).length > 0) {
                        await setDoc(doc(collections.asignaciones, state.selectedWeek), batchData, {merge:true});
                        showToast("Turnos confirmados");
                    }
                }
            });

            getEl('modal-search').addEventListener('input', renderModalPersonalList);
            getEl('btn-unassign-slot').onclick = async () => {
                if(currentSlotId) {
                    await updateDoc(doc(collections.asignaciones, state.selectedWeek), {
                        [currentSlotId]: deleteField(),
                        [`${currentSlotId}-vestimenta`]: deleteField(),
                        [`${currentSlotId}-confirmed`]: deleteField()
                    });
                    getEl('global-selection-modal').style.display = 'none';
                }
            };
            getEl('close-global-modal').onclick = () => getEl('global-selection-modal').style.display = 'none';

            getEl('schedule-config-container').addEventListener('input', (e) => {
                if(e.target.matches('input')) {
                    const { dia, tipo, key } = e.target.dataset;
                    if(!tempScheduleConfig[dia]) tempScheduleConfig[dia] = {};
                    if(key) tempScheduleConfig[dia][key] = e.target.value;
                    else tempScheduleConfig[dia][tipo] = e.target.value;
                }
            });
            getEl('btn-guardar-horarios').onclick = async () => {
                if(currentlyEditingLocal) {
                    await setDoc(doc(collections.mapeoConfig, currentlyEditingLocal), tempScheduleConfig);
                    getEl('schedule-config-modal').style.display = 'none';
                    showToast("Horarios guardados");
                }
            };
            getEl('btn-limpiar-horarios-local').onclick = async () => {
                if(confirm("¬øBorrar configuraci√≥n de este local?")) {
                    tempScheduleConfig = {};
                    renderConfigModal(currentlyEditingLocal);
                }
            };
            getEl('close-schedule-config-modal').onclick = () => getEl('schedule-config-modal').style.display = 'none';

            getEl('form-locales').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = getEl('nuevo-local').value.toUpperCase();
                await addDoc(collections.locales, { nombre, color: '#3b82f6' });
                getEl('nuevo-local').value = '';
                showToast("Local agregado");
            });
            getEl('tabla-locales').addEventListener('click', async (e) => {
                if(e.target.classList.contains('btn-del-local')) {
                    if(confirm("¬øEliminar local?")) await deleteDoc(doc(collections.locales, e.target.dataset.id));
                }
                if(e.target.classList.contains('btn-edit-local')) {
                    const l = state.locales.find(x => x.id === e.target.dataset.id);
                    getEl('edit-local-id').value = l.id;
                    getEl('edit-local-name').value = l.nombre;
                    getEl('edit-local-color').value = l.color;
                    getEl('edit-local-modal').style.display = 'block';
                }
                if(e.target.classList.contains('btn-config-local-gestion')) {
                    currentlyEditingLocal = e.target.dataset.nombre;
                    getEl('schedule-config-local-name').textContent = currentlyEditingLocal;
                    tempScheduleConfig = JSON.parse(JSON.stringify(state.mapeoConfig[currentlyEditingLocal] || {}));
                    renderConfigModal(currentlyEditingLocal);
                    getEl('schedule-config-modal').style.display = 'flex';
                }
            });
            getEl('form-edit-local').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = getEl('edit-local-id').value;
                const nombre = getEl('edit-local-name').value.toUpperCase();
                await updateDoc(doc(collections.locales, id), {
                    nombre: nombre,
                    color: getEl('edit-local-color').value
                });
                getEl('edit-local-modal').style.display = 'none';
            });
            getEl('close-local-modal').onclick = () => getEl('edit-local-modal').style.display = 'none';

            const formP = getEl('form-personal');
            getEl('btn-abrir-modal-personal').onclick = () => {
                formP.reset();
                getEl('personal-id').value = '';
                
                // AUTO-ASIGNAR N¬∫ EMPLEADO
                const maxId = state.personal.reduce((max, p) => Math.max(max, parseInt(p.numero_empleado) || 0), 0);
                getEl('numero_empleado').value = maxId + 1;
                
                getEl('personal-modal').style.display = 'block';
            };
            formP.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    numero_empleado: getEl('numero_empleado').value,
                    nombre: getEl('nombre').value,
                    apellido: getEl('apellido').value,
                    telefono: getEl('telefono').value,
                    disponibilidad: getEl('disponibilidad').value,
                    local1: getEl('local1').value,
                    local2: getEl('local2').value,
                    local3: getEl('local3').value
                };
                const id = getEl('personal-id').value;
                if(id) await updateDoc(doc(collections.personal, id), data);
                else await addDoc(collections.personal, data);
                getEl('personal-modal').style.display = 'none';
                showToast("Personal guardado");
            });
            getEl('close-personal-modal').onclick = () => getEl('personal-modal').style.display = 'none';
            getEl('close-view-personal-modal').onclick = () => getEl('view-personal-modal').style.display = 'none';
            
            getEl('btn-editar-personal-view').onclick = () => {
                const id = getEl('btn-editar-personal-view').dataset.id;
                const p = state.personal.find(x => x.id === id);
                if(p) {
                    getEl('personal-id').value = p.id;
                    getEl('numero_empleado').value = p.numero_empleado || '';
                    getEl('nombre').value = p.nombre || '';
                    getEl('apellido').value = p.apellido || '';
                    getEl('telefono').value = p.telefono || '';
                    getEl('disponibilidad').value = p.disponibilidad || 'disponible';
                    getEl('local1').value = p.local1 || '';
                    getEl('local2').value = p.local2 || '';
                    getEl('local3').value = p.local3 || '';
                    getEl('view-personal-modal').style.display = 'none';
                    getEl('personal-modal').style.display = 'block';
                }
            };
            getEl('btn-eliminar-personal-view').onclick = async () => {
                if(confirm("¬øEliminar personal?")) {
                    const id = getEl('btn-eliminar-personal-view').dataset.id;
                    await deleteDoc(doc(collections.personal, id));
                    getEl('view-personal-modal').style.display = 'none';
                }
            };

            getEl('btn-copy-previous-week').onclick = async () => {
                if(!confirm("¬øSobrescribir esta semana con la anterior?")) return;
                const curr = state.selectedWeek;
                const [y, w] = curr.split('-W').map(Number);
                let prevW = w - 1; let prevY = y;
                if(prevW < 1) { prevW = 52; prevY--; }
                const prevKey = `${prevY}-W${String(prevW).padStart(2,'0')}`;
                
                const prevDocSnap = await getDoc(doc(collections.asignaciones, prevKey));
                if (prevDocSnap.exists()) {
                    const prevData = prevDocSnap.data();
                    await setDoc(doc(collections.asignaciones, curr), prevData);
                    showToast("Copiado exitosamente");
                } else {
                    showToast("No hay datos en la semana anterior", "error");
                }
            };
            
            getEl('btn-limpiar-mapeo').onclick = async () => {
                if(confirm("¬øBorrar TODAS las asignaciones de esta semana?")) {
                    await setDoc(doc(collections.asignaciones, state.selectedWeek), {});
                    showToast("Mapeo limpiado");
                }
            };

            getEl('btn-copy-all-schedule').onclick = () => generateTextSchedule(null); 
            
            getEl('btn-descargar-excel').onclick = () => {
                const rows = [];
                rows.push(["Local", "D√≠a", "Puesto", "Personal", "Entrada", "Salida"]);
                
                const w = state.selectedWeek;
                const asig = state.asignaciones[w] || {};
                
                state.locales.forEach(l => {
                    diasSemana.forEach(d => {
                        const conf = state.mapeoConfig[l.nombre]?.[d];
                        if(!conf) return;
                        ['puestos','cacheos'].forEach(t => {
                            const cant = parseInt(conf[t] || 0);
                            for(let i=1; i<=cant; i++) {
                                const sid = `${l.nombre}-${d}-${t}-${i}`;
                                const pid = asig[sid];
                                const pName = pid ? getFullName(state.personal.find(x=>x.id===pid)) : 'VACANTE';
                                rows.push([l.nombre, d, `${t} ${i}`, pName, conf[`hora${t}Entrada`]||'', conf[`hora${t}Salida`]||'']);
                            }
                        });
                    });
                });
                
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Programacion");
                XLSX.writeFile(wb, `Mapeo_${w}.xlsx`);
            };

            getEl('tabla-tarifario').addEventListener('change', async (e) => {
                if(e.target.matches('input')) {
                    const uid = e.target.dataset.uid;
                    const field = e.target.dataset.field;
                    const val = e.target.value;
                    await setDoc(doc(collections.tarifarios, uid), { [field]: val }, { merge: true });
                }
            });

            getEl('busqueda-programacion').addEventListener('input', renderProgramacion);
            getEl('busqueda-tarifario').addEventListener('input', renderTarifarioTable);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function renderTable(id, data, rowFn) {
            const tbody = getEl(id);
            tbody.innerHTML = data.map(item => `<tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition">${rowFn(item)}</tr>`).join('');
        }

        function renderModalPersonalList() {
            const container = getEl('modal-list-container');
            const term = getEl('modal-search').value.toLowerCase();
            const filtered = state.personal.filter(p => getFullName(p).toLowerCase().includes(term));
            
            const occupiedIds = new Set(Object.values(state.asignaciones[state.selectedWeek] || {}).filter(v => typeof v === 'string'));
            
            container.innerHTML = filtered.map(p => {
                const isOccupied = occupiedIds.has(p.id);
                const isCurrent = state.asignaciones[state.selectedWeek]?.[currentSlotId] === p.id;
                return `
                <div class="p-3 border-b dark:border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 ${isCurrent ? 'bg-blue-50 dark:bg-blue-900/30' : ''}" onclick="window.selectPersonal('${p.id}')">
                    <div>
                        <div class="font-medium dark:text-white">${getFullName(p)}</div>
                        <div class="text-xs text-slate-500">${p.numero_empleado || 'S/N'}</div>
                    </div>
                    ${isOccupied && !isCurrent ? '<span class="text-xs text-orange-500 font-bold">OCUPADO</span>' : ''}
                    ${isCurrent ? '<span class="text-green-500 font-bold">‚úî</span>' : ''}
                </div>`;
            }).join('');
        }

        function renderProgramacion() {
            calculateConflicts();

            const container = getEl('programacion-container');
            const term = getEl('busqueda-programacion').value.toLowerCase();
            const weekAsig = state.asignaciones[state.selectedWeek] || {};
            
            const relevantPersonal = state.personal.filter(p => {
                const nameMatch = getFullName(p).toLowerCase().includes(term);
                const hasShift = Object.values(weekAsig).includes(p.id);
                return term ? nameMatch : hasShift;
            });
            
            container.innerHTML = relevantPersonal.map(p => {
                const shifts = Object.entries(weekAsig)
                    .filter(([k, v]) => v === p.id && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed'))
                    .map(([k]) => {
                        const [local, dia, tipo] = k.split('-');
                        const conf = state.mapeoConfig[local]?.[dia];
                        const horario = conf ? (conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] + ' - ' + conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`]) : '??';
                        
                        const isConfirmed = weekAsig[`${k}-confirmed`];
                        const vestimenta = weekAsig[`${k}-vestimenta`] || 'Ropa T√°ctica';
                        
                        return { local, dia, tipo, horario, isConfirmed, vestimenta, slotId: k };
                    });
                
                if(shifts.length === 0) return '';
                
                const allConfirmed = shifts.every(s => s.isConfirmed);
                const borderClass = allConfirmed 
                    ? "border-green-500 border-2 shadow-green-100 shadow-lg scale-[1.01]" 
                    : "border-slate-200 dark:border-slate-600";

                return `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md border transition-all duration-300 ${borderClass} flex flex-col h-full relative overflow-hidden">
                    
                    ${allConfirmed ? '<div class="absolute top-0 right-0 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">COMPLETO</div>' : ''}

                    <div class="flex justify-between items-center mb-4 mt-1">
                        <h4 class="font-bold text-lg dark:text-white truncate pr-2">${getFullName(p)}</h4>
                        ${allConfirmed ? '<span class="text-green-500 text-2xl">‚úÖ</span>' : ''}
                    </div>

                    <div class="space-y-2 flex-grow">
                        ${shifts.map(s => {
                            let rowBg = "bg-slate-50 dark:bg-slate-700";
                            let borderL = "border-l-4 border-transparent";
                            
                            if (conflictMap.overlap.has(s.slotId)) {
                                rowBg = "conflict-overlap";
                                borderL = "border-l-4 border-yellow-500";
                            } else if (conflictMap.role.has(s.slotId)) {
                                rowBg = "conflict-role";
                                borderL = "border-l-4 border-blue-500";
                            } else if (conflictMap.repeat.has(s.slotId)) {
                                rowBg = "conflict-repeat";
                                borderL = "border-l-4 border-red-500";
                            }

                            return `
                            <div class="text-sm flex justify-between items-center p-2 rounded-lg ${rowBg} ${borderL} transition-colors hover:shadow-sm">
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold capitalize text-blue-600 dark:text-blue-400">${s.dia}</span>
                                        <span class="text-xs text-slate-400 font-mono">${s.horario}</span>
                                    </div>
                                    <span class="dark:text-slate-200 font-medium text-xs mt-0.5">${s.local}</span>
                                </div>
                                <div class="flex items-center gap-3 bg-white/50 dark:bg-black/20 p-1 rounded-md">
                                    <span title="${s.vestimenta}">${vestimentaEmojis[s.vestimenta]}</span>
                                    <span class="${s.isConfirmed ? 'text-green-600' : 'text-slate-300'} text-lg leading-none">
                                        ${s.isConfirmed ? '‚óè' : '‚óã'}
                                    </span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    
                    <div class="mt-5 pt-3 border-t dark:border-slate-700 flex justify-end gap-2">
                        <button class="flex-1 flex items-center justify-center gap-2 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 px-3 py-2 rounded-lg text-sm font-bold transition btn-confirm-individual border border-emerald-200 dark:border-emerald-800" data-person-id="${p.id}" title="Confirmar todos sus turnos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            Confirmar
                        </button>
                        <button class="flex-1 flex items-center justify-center gap-2 bg-blue-50 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/50 px-3 py-2 rounded-lg text-sm font-bold transition btn-copy-individual border border-blue-200 dark:border-blue-800" data-person-id="${p.id}" title="Copiar mensaje WhatsApp">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                            </svg>
                            Copiar
                        </button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderTarifarioTable() {
            const term = getEl('busqueda-tarifario').value.toLowerCase();
            const filtered = state.personal.filter(p => getFullName(p).toLowerCase().includes(term));
            const tbody = getEl('tabla-tarifario');
            
            tbody.innerHTML = filtered.map(p => {
                const t = state.tarifarios[p.id] || {};
                return `
                <tr class="border-b dark:border-slate-700">
                    <td class="p-3 font-medium dark:text-slate-200">${getFullName(p)}</td>
                    <td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Terno||0}" data-uid="${p.id}" data-field="Terno"></td>
                    <td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Tactica||0}" data-uid="${p.id}" data-field="Tactica"></td>
                    <td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Apoyo||0}" data-uid="${p.id}" data-field="Apoyo"></td>
                </tr>`;
            }).join('');
        }

        function renderPlanillas() {
            const container = getEl('planillas-container');
            container.innerHTML = `<div class="p-8 text-center text-slate-500">M√≥dulo de Planillas activo. Seleccione Exportar para generar reporte detallado.</div>`;
        }

        function generateTextSchedule(filterLocal) {
            let text = `*PROGRAMACI√ìN SEMANA ${state.selectedWeek}*\n\n`;
            const asig = state.asignaciones[state.selectedWeek] || {};
            
            const locales = filterLocal ? state.locales.filter(l => l.nombre === filterLocal) : state.locales;
            
            locales.forEach(l => {
                text += `üìç *${l.nombre.toUpperCase()}*\n`;
                diasSemana.forEach(d => {
                    const shifts = [];
                    const conf = state.mapeoConfig[l.nombre]?.[d];
                    if(!conf) return;
                    
                    ['puestos','cacheos'].forEach(t => {
                        const cant = parseInt(conf[t] || 0);
                        for(let i=1; i<=cant; i++) {
                            const sid = `${l.nombre}-${d}-${t}-${i}`;
                            const pid = asig[sid];
                            if(pid) {
                                const p = state.personal.find(x=>x.id===pid);
                                const h = `${conf[`hora${t}Entrada`]}-${conf[`hora${t}Salida`]}`;
                                shifts.push(`   ‚Ä¢ ${t} ${i}: ${getFullName(p)} (${h})`);
                            }
                        }
                    });
                    
                    if(shifts.length > 0) {
                        text += `üìÖ ${d.toUpperCase()}:\n${shifts.join('\n')}\n`;
                    }
                });
                text += '\n------------------\n';
            });
            
            copiarTextoSeguro(text);
        }

        window.verPersonal = (id) => {
            const p = state.personal.find(x => x.id === id);
            if(!p) return;
            getEl('view-personal-name').textContent = getFullName(p);
            getEl('view-personal-details').innerHTML = `
                <p><strong>Tel√©fono:</strong> ${p.telefono || '-'}</p>
                <p><strong>DNI/Legajo:</strong> ${p.numero_empleado || '-'}</p>
                <p><strong>Locales Pref:</strong> ${[p.local1, p.local2, p.local3].filter(Boolean).join(', ')}</p>
            `;
            getEl('btn-editar-personal-view').dataset.id = id;
            getEl('btn-eliminar-personal-view').dataset.id = id;
            getEl('view-personal-modal').style.display = 'block';
        };
        
        window.selectPersonal = async (pid) => {
            if(!currentSlotId) return;
            await setDoc(doc(collections.asignaciones, state.selectedWeek), { [currentSlotId]: pid }, { merge: true });
            getEl('global-selection-modal').style.display = 'none';
        };

        window.loadHist = (weekId) => {
            if(confirm("¬øCargar esta configuraci√≥n hist√≥rica?")) {
                state.selectedWeek = weekId;
                getEl('semana-mapeo').value = weekId;
                watchWeek(weekId);
                alert("Visualizando datos hist√≥ricos. Tenga cuidado al guardar cambios.");
            }
        };

    </script>
</body>
</html>