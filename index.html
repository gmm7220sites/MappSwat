<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Personal SWAT (V6 - Final Dashboard)</title>
    
    <!-- IMPLEMENTACI√ìN DEL ICONO -->
    <link rel="icon" href="logo swat.ico" type="image/x-icon">
    <link rel="shortcut icon" href="logo swat.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' },
                        guinda: {
                            50: '#fdf2f2',
                            100: '#fde8e8',
                            500: '#9f1239', 
                            600: '#881337', 
                            700: '#800020', 
                            800: '#4c0519',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- CORRECCI√ìN CHART.JS (VERSI√ìN UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html.dark { color-scheme: dark; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }
        html.dark body {
            background-color: #0f172a;
            color: #cbd5e1;
        }

        /* --- ESTILOS DE FILA (LISTADO) --- */
        .slot-row {
            transition: all 0.2s ease;
            border-bottom: 1px solid #e2e8f0;
            border-left: 4px solid transparent; 
        }
        html.dark .slot-row {
            border-bottom-color: #334155;
        }
        .slot-row:last-child {
            border-bottom: none;
        }
        
        /* Puestos Resaltados */
        .slot-label-col {
            background-color: #f1f5f9;
            border-right: 1px solid #e2e8f0;
        }
        html.dark .slot-label-col {
            background-color: #1e293b;
            border-right-color: #334155;
        }

        /* Estado Vacante */
        .slot-empty-row {
            opacity: 0.8;
            border-left: 4px solid #cbd5e1; 
        }
        html.dark .slot-empty-row {
            border-left-color: #475569;
        }
        .slot-empty-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
            opacity: 1;
            border-left-color: #3b82f6;
        }

        /* Estado Ocupado */
        .slot-filled-row {
            background-color: white;
            border-left: 4px solid #22c55e;
        }
        html.dark .slot-filled-row {
            background-color: transparent;
            border-left-color: #16a34a;
        }
        .slot-filled-row:hover {
            background-color: #f8fafc;
        }
        html.dark .slot-filled-row:hover {
            background-color: #1e293b;
        }

        /* Cacheo */
        .cacheo-row {
            background-color: #eff6ff;
        }
        html.dark .cacheo-row {
            background-color: rgba(30, 58, 138, 0.15);
        }

        /* --- CONFLICTOS --- */
        .conflict-overlap { border-left-color: #f59e0b !important; background-color: #fffbeb !important; }
        html.dark .conflict-overlap { background-color: #451a03 !important; border-left-color: #f59e0b !important; }

        .conflict-repeat { border-left-color: #ef4444 !important; background-color: #fef2f2 !important; }
        html.dark .conflict-repeat { background-color: #450a0a !important; border-left-color: #ef4444 !important; }

        .conflict-role { border-left-color: #3b82f6 !important; background-color: #eff6ff !important; }
        html.dark .conflict-role { background-color: #172554 !important; border-left-color: #3b82f6 !important; }

        /* --- URGENCIAS Y ALARMAS --- */
        @keyframes pulse-red {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite;
            color: #ef4444;
        }
        
        .urgent-card {
            border: 2px solid #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        html.dark .urgent-card {
            background-color: #450a0a !important;
            border-color: #ef4444 !important;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }

        /* --- MEN√ö LATERAL --- */
        #menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 2000; width: 50px; height: 50px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        html.dark #menu-toggle { background-color: rgba(30, 41, 59, 0.8); }
        #menu-toggle:hover { transform: scale(1.1); }

        #side-nav { 
            position: fixed; top: 0; left: 0; height: 100%; width: 250px; padding: 80px 0 20px; 
            background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 5px 0 25px rgba(0,0,0,0.05);
            z-index: 1999; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        html.dark #side-nav { background-color: rgba(15, 23, 42, 0.4); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        #side-nav.open { transform: translateX(0); }
        
        #side-nav .nav-button { 
            display: block; width: calc(100% - 24px); margin: 4px 12px; padding: 12px 16px; 
            border-radius: 8px; font-weight: 600; text-align: left; transition: all 0.2s; color: #475569; cursor: pointer; 
        }
        html.dark #side-nav .nav-button { color: #cbd5e1; }
        
        #side-nav .nav-button:hover:not(.active) { background-color: rgba(128, 0, 32, 0.08); color: #800020; }
        html.dark #side-nav .nav-button:hover:not(.active) { background-color: rgba(255, 255, 255, 0.1); color: #f1f5f9; }

        #side-nav .nav-button.active { background-color: #800020; color: white; box-shadow: 0 4px 10px rgba(128, 0, 32, 0.3); }
        html.dark #side-nav .nav-button.active { background-color: #9f1239; color: white; }

        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fefefe; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 12px; color: #1e293b; max-height: 90vh; display: flex; flex-direction: column; }
        html.dark .modal-content { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }

        .card-action-btn { padding: 4px; border-radius: 6px; transition: all 0.2s; opacity: 0.7; }
        .card-action-btn:hover { background-color: rgba(0,0,0,0.05); opacity: 1; transform: scale(1.1); }
        html.dark .card-action-btn:hover { background-color: rgba(255,255,255,0.1); }

        #loader { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; align-items: center; justify-content: center; }
        html.dark #loader { background-color: rgba(15, 23, 42, 0.8); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: none; align-items: center; justify-content: center; background-color: rgba(248, 250, 252, 0.7); backdrop-filter: blur(8px); }
        html.dark #login-overlay { background-color: rgba(15, 23, 42, 0.7); }
        
        /* Animaciones */
        @keyframes blink { 50% { opacity: 0.3; } }
        .notification-bell { animation: blink 1.5s infinite; cursor: help; color: #f59e0b; margin-left: 8px; }
        
        /* Indicador Circular */
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
        html.dark .circle-bg { stroke: #334155; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .percentage-text { fill: #666; font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }
        html.dark .percentage-text { fill: #cbd5e1; }
        
        .icon-btn { background-color: #f1f5f9; border-radius: 9999px; padding: 0.5rem; transition: all 0.2s ease; cursor: pointer; }
        .icon-btn:hover { background-color: #e2e8f0; transform: scale(1.1); }
        html.dark .icon-btn { background-color: #334155; }
        html.dark .icon-btn:hover { background-color: #475569; }
        
        #search-panel { position: fixed; bottom: 80px; right: 20px; width: 300px; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); padding: 16px; z-index: 1000; transform: translateY(20px) scale(0.95); opacity: 0; transition: all 0.3s ease; pointer-events: none; }
        #search-panel.open { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        html.dark #search-panel { background-color: rgba(30, 41, 59, 0.9); }
        
        /* Estilos Calendario */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { min-height: 80px; padding: 4px; border: 1px solid #e2e8f0; background-color: white; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #f8fafc; }
        html.dark .calendar-day { background-color: #1e293b; border-color: #334155; }
        html.dark .calendar-day:hover { background-color: #334155; }
        .calendar-header { font-weight: bold; text-align: center; padding: 8px 0; font-size: 0.85rem; color: #64748b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-3xl font-bold text-center text-slate-800 dark:text-white mb-6">Swat Security</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-slate-700 dark:text-slate-300 font-semibold mb-2">Usuario</label>
                    <input type="text" id="username" class="w-full p-3 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-700 dark:text-slate-300 font-semibold mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full p-3 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                </div>
                <!-- CHECKBOX RECORDAR USUARIO -->
                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="remember-me" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="remember-me" class="text-slate-700 dark:text-slate-300 font-semibold text-sm">Recordar usuario</label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-lg font-bold text-slate-700 dark:text-slate-300">Cargando Sistema...</p>
        </div>
    </div>
    
    <!-- NOTIFICACIONES TOAST -->
    <div id="status-message-container" class="fixed top-4 right-4 z-[4000] flex flex-col gap-2 pointer-events-none"></div>

    <!-- NAVEGACI√ìN -->
    <button id="menu-toggle">
        <svg class="w-6 h-6 text-slate-800 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>
    <nav id="side-nav">
        <div class="px-6 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">AdminPanel</h2>
        </div>
        <button id="btn-mapeo" class="nav-button active">Mapeo Semanal</button>
        <button id="btn-gestion" class="nav-button">Gesti√≥n Locales/Personal</button>
        <button id="btn-programacion" class="nav-button">Programaci√≥n Individual</button>
        <button id="btn-tarifario" class="nav-button">Tarifario</button>
        <button id="btn-planillas" class="nav-button">Planillas</button>
        <button id="btn-historial" class="nav-button">Historial</button>
        <!-- NUEVO BOT√ìN DASHBOARD -->
        <button id="btn-dashboard-admin" class="nav-button">üìä Dashboard Gerencial</button>
        <div class="mt-auto px-6 pb-6 pt-10">
             <button id="btn-logout" class="text-red-500 font-medium hover:text-red-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                Cerrar Sesi√≥n
             </button>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container mx-auto p-4 md:p-8 w-full main-content max-w-[1600px]"> 
        <header class="text-center mb-8 relative">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Mapeo Semanal</h1>
            <div class="absolute top-0 right-0 flex items-center gap-3">
                
                <!-- BOT√ìN PERMISOS -->
                <button id="btn-permisos" type="button" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm hover:shadow-md hover:border-purple-400 dark:hover:border-purple-500 transition-all duration-300 group" title="Gesti√≥n de Permisos">
                    <svg class="w-5 h-5 text-slate-500 dark:text-slate-400 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm font-semibold text-slate-600 dark:text-slate-300 group-hover:text-purple-600 dark:group-hover:text-purple-400 hidden sm:block">Permisos</span>
                </button>

                <!-- BOT√ìN DASHBOARD MINIMALISTA -->
                <button id="btn-dashboard" type="button" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm hover:shadow-md hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-300 group" title="Ver Dashboard de Estado">
                    <svg class="w-5 h-5 text-slate-500 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="text-sm font-semibold text-slate-600 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 hidden sm:block">Estado</span>
                </button>

                <div id="system-status-container" title="Estado del sistema" class="p-2">
                    <svg id="system-status-icon" class="h-6 w-6 text-slate-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <main>
            <!-- 1. SECCI√ìN MAPEO -->
            <section id="section-mapeo">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <div class="flex flex-col lg:flex-row items-center gap-4 mb-6">
                        <div class="flex items-center gap-2">
                            <label class="font-semibold text-slate-700 dark:text-slate-300">Semana:</label>
                            <input type="week" id="semana-mapeo" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <div class="flex-grow"></div>
                        <div class="flex flex-wrap gap-2 justify-center items-center">
                            
                            <!-- BOT√ìN COPIAR TEXTO -->
                            <button id="btn-copy-all-schedule" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 shadow-sm text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copiar Texto
                            </button>

                            <!-- MEN√ö DESPLEGABLE HERRAMIENTAS -->
                            <div class="relative">
                                <button id="btn-tools-dropdown" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white font-bold py-2 px-4 rounded-md hover:bg-slate-300 dark:hover:bg-slate-600 shadow-sm flex items-center gap-2 border border-slate-300 dark:border-slate-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                    </svg>
                                    Herramientas
                                </button>
                                <!-- Contenido del Men√∫ -->
                                <div id="tools-dropdown-menu" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-xl z-50 border border-slate-200 dark:border-slate-600 overflow-hidden">
                                     <button id="btn-copy-previous-week" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3 transition-colors">
                                        <span class="text-sky-500">üìã</span> Copiar Sem. Ant.
                                     </button>
                                     <button id="btn-save-history" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3 transition-colors">
                                        <span class="text-teal-500">üíæ</span> Guardar Respaldo
                                     </button>
                                     <button id="btn-descargar-excel" class="w-full text-left px-4 py-3 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3 transition-colors">
                                        <span class="text-green-600">üìä</span> Excel
                                     </button>
                                     <div class="border-t border-slate-200 dark:border-slate-700 my-1"></div>
                                     <button id="btn-limpiar-mapeo" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3 transition-colors font-semibold">
                                        <span>üóëÔ∏è</span> Limpiar
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6" id="mapeo-container">
                        <!-- Tarjetas de Mapeo aqu√≠ -->
                    </div>
                </div>

                <!-- Bot√≥n Flotante y Panel de B√∫squeda -->
                <div id="search-fab" class="fixed bottom-6 right-6 z-50">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110">
                         <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                </div>
                <div id="search-panel">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-slate-700">Filtro R√°pido</label>
                        <button id="close-search-panel" class="text-slate-400 hover:text-red-500">&times;</button>
                    </div>
                    <input type="text" id="filtro-local-busqueda" placeholder="Buscar Local o Personal..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
            </section>

            <!-- 2. SECCI√ìN GESTI√ìN -->
            <section id="section-gestion" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Locales -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Locales</h2>
                        <form id="form-locales" class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input type="text" id="nuevo-local" placeholder="Nombre del nuevo local" class="flex-grow p-2 border rounded-md dark:bg-slate-700 dark:text-white" required>
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Agregar</button>
                        </form>
                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr><th class="p-3 text-slate-700 dark:text-slate-200">Local</th><th class="p-3 text-right text-slate-700 dark:text-slate-200">Acciones</th></tr>
                                </thead>
                                <tbody id="tabla-locales"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Personal -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Personal</h2>
                            <div class="flex gap-2">
                                <button id="btn-exportar-bd-personal" class="bg-emerald-500 text-white font-bold py-1 px-3 rounded text-sm hover:bg-emerald-600">Exportar</button>
                                <button onclick="document.getElementById('import-personal-input').click()" class="bg-sky-500 text-white font-bold py-1 px-3 rounded text-sm hover:bg-sky-600">Importar</button>
                                <input type="file" id="import-personal-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                        </div>
                        
                        <!-- BOT√ìN Y BUSCADOR MEJORADO -->
                        <button id="btn-abrir-modal-personal" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 mb-4 shadow-md transition-transform hover:scale-[1.02]">Agregar Personal Nuevo</button>
                        
                        <!-- NUEVO BUSCADOR GESTI√ìN -->
                        <div class="relative mb-4 group">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="text" id="gestion-personal-search" class="w-full py-2.5 pl-10 pr-4 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm" placeholder="üîç Buscar por Nombre o DNI...">
                        </div>

                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar border rounded-lg dark:border-slate-600">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0">
                                    <tr><th class="p-3">ID</th><th class="p-3">Nombre</th><th class="p-3">Tel√©fono</th></tr>
                                </thead>
                                <tbody id="tabla-personal"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. SECCI√ìN PROGRAMACI√ìN -->
            <section id="section-programacion" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label class="font-semibold dark:text-white">Semana:</label>
                        <input type="week" id="semana-programacion" class="p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                        <input type="text" id="busqueda-programacion" placeholder="Filtrar por nombre..." class="flex-grow p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                    </div>
                    <div id="programacion-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </section>

            <!-- 4. SECCI√ìN TARIFARIO -->
            <section id="section-tarifario" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold dark:text-white">Tarifario Individual (S/)</h2>
                            <p class="text-sm text-slate-500">Auto-guardado habilitado.</p>
                        </div>
                         <div class="flex items-center gap-2">
                            <button id="btn-exportar-tarifario" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded hover:bg-emerald-600 text-sm">Exportar</button>
                            <button onclick="document.getElementById('import-tarifario-input').click()" class="bg-sky-500 text-white font-bold py-2 px-4 rounded hover:bg-sky-600 text-sm">Importar</button>
                            <input type="file" id="import-tarifario-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                        <input type="text" id="busqueda-tarifario" placeholder="Buscar..." class="w-full md:w-64 p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                    </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 dark:bg-slate-700">
                                <tr>
                                    <th class="p-3 font-semibold dark:text-white">Nombre Completo</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü§µ TERNO</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü•ã T√ÅCTICA</th>
                                    <th class="p-3 font-semibold text-center dark:text-white">ü§ù APOYO</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-tarifario"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 5. SECCI√ìN PLANILLAS -->
            <section id="section-planillas" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div class="flex items-center gap-2">
                            <label class="font-semibold dark:text-white">Semana:</label>
                            <input type="week" id="semana-planillas" class="p-2 border rounded-md dark:bg-slate-700 dark:text-white">
                        </div>
                        <button id="btn-exportar-planilla" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-600 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Descargar Planilla
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left bg-white dark:bg-slate-700 rounded-lg shadow-sm">
                            <thead class="bg-slate-100 dark:bg-slate-600 border-b dark:border-slate-500">
                                <tr>
                                    <th class="p-4 font-semibold dark:text-white">Nombre</th>
                                    <th class="p-4 font-semibold text-center dark:text-white">Turnos Terno</th>
                                    <th class="p-4 font-semibold text-center dark:text-white">Turnos T√°ctica</th>
                                    <th class="p-4 font-semibold text-center dark:text-white">Turnos Apoyo</th>
                                    <th class="p-4 font-semibold text-right dark:text-white">Total a Pagar (S/)</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-planillas"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- 6. SECCI√ìN HISTORIAL -->
            <section id="section-historial" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 dark:text-white">Historial de Mapeos Guardados</h2>
                    <div id="historial-container" class="overflow-x-auto"></div>
                </div>
            </section>

            <!-- 7. SECCI√ìN DASHBOARD GERENCIAL -->
            <section id="section-dashboard-admin" class="hidden">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-6 border-l-4 border-indigo-600">
                    <h2 class="text-2xl font-bold dark:text-white">Resumen Ejecutivo</h2>
                    <p class="text-slate-500 dark:text-slate-400">An√°lisis financiero y operativo de la semana seleccionada.</p>
                </div>

                <!-- TARJETAS KPI -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border-t-4 border-emerald-500">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Costo Semanal (Est.)</p>
                        <h3 id="dash-costo" class="text-3xl font-black text-slate-800 dark:text-white mt-2">S/ 0.00</h3>
                        <p class="text-xs text-emerald-600 mt-1 font-semibold">Basado en tarifas asignadas</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Turnos Asignados</p>
                        <h3 id="dash-turnos" class="text-3xl font-black text-slate-800 dark:text-white mt-2">0</h3>
                        <p class="text-xs text-blue-600 mt-1 font-semibold">Total de servicios cubiertos</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Personal Activo</p>
                        <h3 id="dash-personal" class="text-3xl font-black text-slate-800 dark:text-white mt-2">0</h3>
                        <p class="text-xs text-purple-600 mt-1 font-semibold">Agentes trabajando</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Vacantes Libres</p>
                        <h3 id="dash-vacantes" class="text-3xl font-black text-slate-800 dark:text-white mt-2">0</h3>
                        <p class="text-xs text-red-600 mt-1 font-semibold">Puestos sin cubrir</p>
                    </div>
                </div>

                <!-- GR√ÅFICOS -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h4 class="font-bold text-lg mb-4 dark:text-white border-b pb-2 dark:border-slate-700">Operatividad por Local</h4>
                        <div class="h-64 relative w-full">
                            <canvas id="chart-turnos-local"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h4 class="font-bold text-lg mb-4 dark:text-white border-b pb-2 dark:border-slate-700">Distribuci√≥n de Costos</h4>
                        <div class="h-64 relative w-full flex justify-center">
                            <canvas id="chart-costos-tipo"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- === MODALES === -->

    <!-- Modal Selecci√≥n Global -->
    <div id="global-selection-modal" class="modal">
        <div class="modal-content w-full max-w-md h-[80vh] bg-white dark:bg-slate-800 rounded-xl overflow-hidden shadow-2xl flex flex-col">
            <!-- CABECERA MODIFICADA CON BOT√ìN DE SUGERENCIA -->
            <div class="p-4 border-b dark:border-slate-700 flex items-center justify-between bg-white dark:bg-slate-800 z-10 shrink-0">
                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Asignar Personal</h3>
                        <!-- BOT√ìN FOCO -->
                        <button id="btn-smart-suggest" type="button" class="text-yellow-500 hover:text-yellow-600 transition-all hover:scale-110" title="Sugerencia Inteligente">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                               <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                               <path d="M12 18a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm0 2a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/>
                           </svg>
                        </button>
                    </div>
                    <p id="modal-slot-info" class="text-xs text-slate-500">...</p>
                </div>
                <button id="close-global-modal" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-900/50 shrink-0">
                <input type="text" id="modal-search" placeholder="Buscar por nombre..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:text-white">
                <button id="btn-unassign-slot" class="mt-2 w-full py-2 text-xs font-semibold text-red-500 hover:bg-red-50 border border-red-200 rounded-lg">Quitar Asignaci√≥n (Dejar Vac√≠o)</button>
            </div>
            <div id="modal-list-container" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
        </div>
    </div>
    
    <!-- Modal Dashboard (Estado) -->
    <div id="dashboard-modal" class="modal">
        <div class="modal-content !max-w-4xl max-h-[85vh] dark:bg-slate-800 dark:border-slate-700 p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="text-2xl font-bold dark:text-white flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Dashboard de Estado
                </h3>
                <button id="close-dashboard-modal" class="text-3xl font-bold text-slate-500 hover:text-red-500">&times;</button>
            </div>
            <div id="dashboard-content" class="flex-grow overflow-hidden flex flex-col"></div>
        </div>
    </div>
    
    <!-- Modal Permisos -->
    <div id="permisos-modal" class="modal">
         <div class="modal-content !max-w-5xl max-h-[90vh] flex flex-col dark:bg-slate-800 dark:border-slate-700 p-6">
             <div class="flex justify-between items-center mb-4 shrink-0">
                 <h3 class="text-2xl font-bold dark:text-white flex items-center gap-2">
                     <span class="text-3xl">üìÖ</span> Calendario de Ausencias
                 </h3>
                 <button onclick="document.getElementById('permisos-modal').style.display='none'" class="text-3xl font-bold text-slate-500 hover:text-red-500">&times;</button>
             </div>
             
             <div class="flex gap-4 mb-4">
                 <button id="prev-month" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300 dark:bg-slate-700 dark:text-white">&lt;</button>
                 <span id="current-month-display" class="font-bold text-xl w-40 text-center dark:text-white"></span>
                 <button id="next-month" class="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300 dark:bg-slate-700 dark:text-white">&gt;</button>
             </div>
             
             <div class="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-slate-500 dark:text-slate-400">
                 <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div>
             </div>
             
             <div id="calendar-grid" class="calendar-grid flex-grow overflow-y-auto"></div>
             
             <div class="mt-4 flex gap-4 text-sm">
                 <div class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-400 rounded-full"></span> Permiso</div>
                 <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Baja M√©dica</div>
                 <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Vacaciones</div>
             </div>
         </div>
    </div>
    
    <!-- Modal Agregar Permiso (Sub-modal) -->
    <div id="add-permiso-modal" class="modal" style="z-index: 3100;">
        <div class="modal-content !max-w-md p-6 dark:bg-slate-800 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Registrar Ausencia</h3>
            <form id="form-permiso" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1 dark:text-slate-300">Personal</label>
                    <select id="permiso-personal" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" required></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium mb-1 dark:text-slate-300">Desde</label>
                        <input type="date" id="permiso-start" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" required>
                     </div>
                     <div>
                        <label class="block text-sm font-medium mb-1 dark:text-slate-300">Hasta</label>
                        <input type="date" id="permiso-end" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" required>
                     </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 dark:text-slate-300">Tipo</label>
                    <select id="permiso-type" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white">
                        <option value="permiso">Permiso Personal (Amarillo)</option>
                        <option value="baja">Baja M√©dica (Rojo)</option>
                        <option value="vacaciones">Vacaciones (Verde)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 dark:text-slate-300">Motivo</label>
                    <input type="text" id="permiso-reason" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" placeholder="Opcional">
                </div>
                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="document.getElementById('add-permiso-modal').style.display='none'" class="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agregar/Editar Personal -->
    <div id="personal-modal" class="modal">
        <div class="modal-content !max-w-3xl dark:bg-slate-800 dark:border-slate-700">
            <h3 id="personal-modal-title" class="text-2xl font-bold mb-4 dark:text-white">Gesti√≥n Personal</h3>
            <form id="form-personal" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="personal-id">
                <div><label class="text-sm dark:text-slate-300">N¬∫ Empleado</label><input type="text" id="numero_empleado" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Nombre</label><input type="text" id="nombre" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white" required></div>
                <div><label class="text-sm dark:text-slate-300">Apellidos</label><input type="text" id="apellido" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Tel√©fono</label><input type="tel" id="telefono" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"></div>
                <div><label class="text-sm dark:text-slate-300">Disponibilidad</label><select id="disponibilidad" class="w-full p-2 border rounded dark:bg-slate-700 dark:text-white"><option value="disponible">Disponible</option><option value="no-disponible">No Disponible</option></select></div>
                
                <div class="md:col-span-2 grid grid-cols-3 gap-2">
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 1</label><select id="local1" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 2</label><select id="local2" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                    <div><label class="text-xs dark:text-slate-400">Pref. Local 3</label><select id="local3" class="w-full p-1 border rounded text-sm dark:bg-slate-700 dark:text-white"><option value="">Ninguno</option></select></div>
                </div>

                <div class="md:col-span-2 flex justify-end gap-3 mt-4">
                    <button type="button" id="close-personal-modal" class="bg-slate-300 py-2 px-4 rounded hover:bg-slate-400">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Vista R√°pida Personal -->
    <div id="view-personal-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <div class="flex justify-between items-start">
                <h3 id="view-personal-name" class="text-2xl font-bold mb-4 dark:text-white"></h3>
                <button type="button" id="close-view-personal-modal" class="text-3xl font-bold text-slate-500">&times;</button>
            </div>
            <div id="view-personal-details" class="text-sm dark:text-slate-300 space-y-2 mb-6"></div>
            <div class="flex justify-end gap-4">
                <button type="button" id="btn-eliminar-personal-view" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600">Eliminar</button>
                <button type="button" id="btn-editar-personal-view" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded hover:bg-yellow-600">Editar</button>
            </div>
        </div>
    </div>

    <!-- Modal Config Horarios -->
    <div id="schedule-config-modal" class="modal">
        <div class="modal-content !max-w-4xl max-h-[90vh] flex flex-col dark:bg-slate-800">
            <div class="flex justify-between items-center mb-4 p-4 border-b dark:border-slate-700">
                <h3 class="text-2xl font-bold dark:text-white">Horarios: <span id="schedule-config-local-name" class="text-blue-600"></span></h3>
                <button id="close-schedule-config-modal" class="text-3xl text-slate-500">&times;</button>
            </div>
            <div id="schedule-config-container" class="space-y-6 flex-grow overflow-y-auto p-4 bg-slate-50 dark:bg-slate-900"></div>
            <div class="mt-auto p-4 border-t flex justify-end items-center gap-4 bg-white dark:bg-slate-800 rounded-b-xl">
                 <button type="button" id="btn-limpiar-horarios-local" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 mr-auto">Resetear Local</button>
                 <button type="button" id="btn-guardar-horarios" class="bg-green-600 text-white font-bold py-2 px-5 rounded hover:bg-green-700 shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <p id="confirmation-modal-text" class="mb-6 text-lg dark:text-white"></p>
            <div class="flex justify-end gap-4">
                <button id="confirmation-modal-cancel" class="bg-slate-300 py-2 px-4 rounded hover:bg-slate-400">Cancelar</button>
                <button id="confirmation-modal-confirm" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Edici√≥n Local -->
    <div id="edit-local-modal" class="modal">
        <div class="modal-content dark:bg-slate-800">
            <h3 class="text-2xl font-bold mb-4 dark:text-white">Editar Local</h3>
            <form id="form-edit-local" class="flex flex-col gap-4">
                <input type="hidden" id="edit-local-id">
                <input type="text" id="edit-local-name" placeholder="Nombre" class="p-2 border rounded dark:bg-slate-700 dark:text-white" required>
                <div class="flex items-center gap-4">
                    <label class="dark:text-white">Color:</label>
                    <input type="color" id="edit-local-color" class="h-10 w-10">
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded">Guardar</button>
                    <button type="button" id="close-local-modal" class="flex-1 bg-slate-300 py-2 px-4 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTACIONES FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, updateDoc, deleteField, serverTimestamp, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
        import { getDatabase, ref, set, onDisconnect, serverTimestamp as rtdbTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";

        // 2. CONFIGURACI√ìN
        const firebaseConfig = { apiKey: "AIzaSyBwtZ8Kdvw4LJyu3t0QeaBgq6_0Z_9jrvw", authDomain: "swattmapee.firebaseapp.com", databaseURL: "https://swattmapee-default-rtdb.firebaseio.com", projectId: "swattmapee", storageBucket: "swattmapee.appspot.com", messagingSenderId: "522791414169", appId: "1:522791414169:web:7c2d3c567fbd1d5703cb08" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const appId = "mapeo-app-v2";
        const basePath = `artifacts/${appId}/public/data`;
        const collections = {
            personal: collection(db, `${basePath}/personal`),
            locales: collection(db, `${basePath}/locales`),
            mapeoConfig: collection(db, `${basePath}/mapeoConfig`),
            asignaciones: collection(db, `${basePath}/asignaciones`),
            historial: collection(db, `${basePath}/historial`),
            tarifarios: collection(db, `${basePath}/tarifarios`),
            status: collection(db, `${basePath}/status`),
            permisos: collection(db, `${basePath}/permisos`)
        };

        // 3. ESTADO GLOBAL
        const diasSemana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        const vestimentaEmojis = { 'Ropa T√°ctica': 'ü•ã', 'Terno': 'ü§µ' };
        let state = { personal: [], locales: [], mapeoConfig: {}, asignaciones: {}, historial: {}, tarifarios: {}, permisos: [], selectedWeek: '' };
        
        // Variable para guardar los gr√°ficos del Dashboard Admin
        let adminCharts = { turnos: null, costos: null };

        let listeners = { asignaciones: null };
        let tempScheduleConfig = {}; 
        let currentSlotId = null;
        let currentlyEditingLocal = null;
        let currentCalendarDate = new Date();
        
        // Estado de conflictos
        let conflictMap = {
            overlap: new Set(), // Amarillo
            repeat: new Set(),  // Rojo
            role: new Set()     // Azul
        };
        
        // ... (Funciones de utilidad existentes: getEl, showToast, etc.) ...
        const getEl = (id) => document.getElementById(id);
        const showToast = (msg, type = 'success') => {
            const container = getEl('status-message-container');
            const div = document.createElement('div');
            div.className = `${type==='success'?'bg-green-600':'bg-red-600'} text-white px-4 py-3 rounded shadow-lg animate-bounce pointer-events-auto cursor-pointer`;
            div.textContent = msg;
            div.onclick = () => div.remove();
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        };
        const getFullName = (p) => p ? `${p.nombre || ''} ${p.apellido || ''}`.trim() : 'N/A';
        const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
        
        const timeToMin = (timeStr) => {
            if(!timeStr) return -1;
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);
            if(period === 'PM' && hours !== 12) hours += 12;
            if(period === 'AM' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        };

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function getDateOfISOWeek(w, y) {
            var simple = new Date(y, 0, 1 + (w - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function getShiftDate(weekStr, dayName, timeStr) {
            if(!weekStr || !dayName || !timeStr) return null;
            const [yearStr, weekNoStr] = weekStr.split('-W');
            const year = parseInt(yearStr);
            const weekNo = parseInt(weekNoStr);
            const date = getDateOfISOWeek(weekNo, year);
            const dayIndex = diasSemana.indexOf(dayName.toLowerCase());
            date.setDate(date.getDate() + dayIndex);
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);
            if(period === 'PM' && hours !== 12) hours += 12;
            if(period === 'AM' && hours === 12) hours = 0;
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        const copiarTextoSeguro = async (texto) => {
            try {
                await navigator.clipboard.writeText(texto);
                showToast("¬°Copiado al portapapeles!");
            } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = texto;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("¬°Copiado (m√©todo alt.)!");
                } catch (err2) {
                    showToast("Error al copiar", "error");
                }
                document.body.removeChild(textArea);
            }
        };

        // ... (Render Functions remain mostly same, adding new ones) ...

        function renderLocalesSelects() {
            const opts = `<option value="">Ninguno</option>` + state.locales.map(l => `<option value="${l.nombre}">${l.nombre.toUpperCase()}</option>`).join('');
            ['local1', 'local2', 'local3'].forEach(id => getEl(id).innerHTML = opts);
        }

        function createSlot(slotId, tipo, horario, idx) {
            const week = state.selectedWeek;
            const pid = state.asignaciones[week]?.[slotId];
            const div = document.createElement('div');
            
            const tipoLabelMap = { 'puestos':'Puesto', 'cacheos':'Cacheo', 'cacheoIngreso':'Ingreso', 'cacheoSalida':'Salida', 'turno1': '1er Turno', 'turno2': '2do Turno', 'turno3': '3er Turno', 'porteria': 'Porter√≠a' };
            const tipoLabel = tipoLabelMap[tipo] || tipo;
            let baseClass = "slot-empty-row", content = "", bgClass = ""; 

            if (pid) {
                baseClass = "slot-filled-row";
                if (conflictMap.role.has(slotId)) bgClass = "conflict-role"; 
                else if (conflictMap.repeat.has(slotId)) bgClass = "conflict-repeat"; 
                else if (conflictMap.overlap.has(slotId)) bgClass = "conflict-overlap"; 
                
                if (!bgClass && ['cacheos','cacheoIngreso','cacheoSalida'].includes(tipo)) bgClass = "cacheo-row";

                const p = state.personal.find(x => x.id === pid);
                const vest = state.asignaciones[week]?.[`${slotId}-vestimenta`] || 'Ropa T√°ctica';
                const conf = state.asignaciones[week]?.[`${slotId}-confirmed`];
                
                content = `<div class="slot-label-col w-28 shrink-0 flex flex-col justify-center p-2"><span class="text-[10px] font-bold uppercase">${tipoLabel} #${idx}</span><div class="text-[9px] text-slate-500">${horario}</div></div><div class="flex-grow p-2 font-semibold text-sm truncate dark:text-slate-100">${getFullName(p)}</div><div class="flex gap-1 shrink-0 p-2"><button class="vestimenta-btn text-lg hover:bg-slate-200 rounded px-1" data-slot="${slotId}" title="Cambiar Vestimenta">${vestimentaEmojis[vest]}</button><button class="conf-btn text-lg hover:bg-slate-200 rounded px-1" data-slot="${slotId}" title="Confirmar">${conf ? '‚úÖ' : '‚¨ú'}</button></div>`;
            } else {
                if (['cacheos','cacheoIngreso','cacheoSalida'].includes(tipo)) bgClass = "cacheo-row";
                content = `<div class="slot-label-col w-28 shrink-0 flex flex-col justify-center p-2 opacity-50"><span class="text-[10px] font-bold uppercase">${tipoLabel} #${idx}</span><div class="text-[9px] text-slate-500">${horario}</div></div><div class="flex-grow flex items-center gap-2 text-slate-400 group-hover:text-blue-500 p-2"><span class="text-xs font-medium">Asignar</span></div>`;
            }
            div.className = `slot-row flex items-center cursor-pointer group ${baseClass} ${bgClass}`;
            div.innerHTML = content;
            div.dataset.slotId = slotId;
            return div;
        }

        // ... (calculateConflicts, Dashboard Stats, etc.) ...
        function calculateConflicts() {
            conflictMap.overlap.clear(); conflictMap.repeat.clear(); conflictMap.role.clear();    
            const week = state.selectedWeek;
            const weekAsig = state.asignaciones[week] || {};
            const specialRoles = ['cacheos', 'cacheoIngreso', 'cacheoSalida', 'porteria'];
            const shiftsByPerson = {}; 

            Object.entries(weekAsig).forEach(([slotId, pid]) => {
                if(!pid || typeof pid !== 'string' || !slotId.includes('-') || slotId.endsWith('vestimenta') || slotId.endsWith('confirmed')) return;
                const parts = slotId.split('-'); const indexStr = parts.pop(); const tipo = parts.pop(); const dia = parts.pop(); const local = parts.join('-'); 
                const conf = state.mapeoConfig[local]?.[dia];
                if(!conf) return; 
                
                const keyNameIn = `hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`;
                const keyNameOut = `hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`;
                const hIn = conf[keyNameIn]; const hOut = conf[keyNameOut];
                if(!hIn || !hOut) return;

                const start = timeToMin(hIn); let end = timeToMin(hOut); if (end < start) end += 24*60; 
                const dayOffset = diasSemana.indexOf(dia) * 1440 * 2; 
                if(!shiftsByPerson[pid]) shiftsByPerson[pid] = [];
                shiftsByPerson[pid].push({ slotId, dia, local, tipo, start, end, absStart: start + dayOffset, absEnd: end + dayOffset });
            });

            Object.values(shiftsByPerson).forEach(shifts => {
                const shiftsByDay = {};
                shifts.forEach(s => { if(!shiftsByDay[s.dia]) shiftsByDay[s.dia] = []; shiftsByDay[s.dia].push(s); });
                Object.values(shiftsByDay).forEach(dayShifts => {
                    if (dayShifts.length < 2) return; 
                    for(let i=0; i<dayShifts.length; i++) {
                        for(let j=i+1; j<dayShifts.length; j++) {
                            const s1 = dayShifts[i]; const s2 = dayShifts[j];
                            const overlap = Math.min(s1.end, s2.end) - Math.max(s1.start, s2.start);
                            const isSpecial = specialRoles.includes(s1.tipo) || specialRoles.includes(s2.tipo);
                            const sameLocal = s1.local === s2.local;
                            if (isSpecial) { conflictMap.role.add(s1.slotId); conflictMap.role.add(s2.slotId); } 
                            else if (sameLocal || overlap > 120) { conflictMap.repeat.add(s1.slotId); conflictMap.repeat.add(s2.slotId); } 
                            else { conflictMap.overlap.add(s1.slotId); conflictMap.overlap.add(s2.slotId); }
                        }
                    }
                });
            });
        }

        function calculateDashboardStats() {
            const week = state.selectedWeek;
            const weekAsig = state.asignaciones[week] || {};
            const stats = { totalSlots: 0, filledSlots: 0, confirmedSlots: 0, byLocal: {}, urgent: [], critical: [] };
            const now = new Date();
            const specialRoles = ['cacheos', 'cacheoIngreso', 'cacheoSalida', 'porteria'];
            const specialLabels = { 'cacheos': 'Cacheo', 'cacheoIngreso': 'Ingreso', 'cacheoSalida': 'Salida', 'porteria': 'Porter√≠a' };

            state.locales.forEach(local => {
                stats.byLocal[local.nombre] = { total: 0, filled: 0, missingTypes: {}, unconfirmedCount: 0 };
                const config = state.mapeoConfig[local.nombre] || {};
                diasSemana.forEach(dia => {
                    const dConf = config[dia] || {};
                    const allTypes = ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'];
                    allTypes.forEach(tipo => {
                        const count = parseInt(dConf[tipo] || 0);
                        if(count > 0) {
                            stats.totalSlots += count;
                            stats.byLocal[local.nombre].total += count;
                            const hIn = dConf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`];
                            let shiftDate = null;
                            try { shiftDate = getShiftDate(week, dia, hIn); } catch(e) {}
                            for(let i=1; i<=count; i++) {
                                const sid = `${local.nombre}-${dia}-${tipo}-${i}`;
                                if(weekAsig[sid]) {
                                    stats.filledSlots++;
                                    stats.byLocal[local.nombre].filled++;
                                    if(weekAsig[`${sid}-confirmed`]) stats.confirmedSlots++;
                                    else {
                                        stats.byLocal[local.nombre].unconfirmedCount++;
                                        if(shiftDate) {
                                            const diffMs = shiftDate - now;
                                            const diffHrs = diffMs / (1000 * 60 * 60);
                                            if(diffHrs > 0 && diffHrs < 48) stats.urgent.push(`${local.nombre} (${capitalize(dia)} ${hIn}): Falta confirmar ${tipo}`);
                                        }
                                    }
                                } else {
                                    if(!stats.byLocal[local.nombre].missingTypes[tipo]) stats.byLocal[local.nombre].missingTypes[tipo] = 0;
                                    stats.byLocal[local.nombre].missingTypes[tipo]++;
                                    if(specialRoles.includes(tipo)) stats.critical.push(`${local.nombre} - ${capitalize(dia)}: Falta ${specialLabels[tipo]}`);
                                }
                            }
                        }
                    });
                });
            });
            return stats;
        }

        function updateDashboard() {
            try {
                const container = getEl('dashboard-content');
                if(!container) return;
                if(!state.locales || state.locales.length === 0) { container.innerHTML = '<p class="text-center text-slate-500">Cargando datos...</p>'; return; }
                const stats = calculateDashboardStats();
                const percentage = stats.totalSlots > 0 ? Math.round((stats.filledSlots / stats.totalSlots) * 100) : 0;
                const confirmedPercentage = stats.filledSlots > 0 ? Math.round((stats.confirmedSlots / stats.filledSlots) * 100) : 0;
                
                let html = `
                    <div class="mb-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl shadow-inner">
                                <div class="flex justify-between items-end mb-2">
                                    <div><p class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">Cobertura</p><h4 class="text-2xl font-black text-slate-800 dark:text-white">${percentage}%</h4></div>
                                    <span class="text-xs font-bold px-2 py-1 rounded bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300">${stats.filledSlots}/${stats.totalSlots}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2 dark:bg-slate-700 overflow-hidden"><div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div></div>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl shadow-inner">
                                <div class="flex justify-between items-end mb-2">
                                    <div><p class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">Confirmaciones</p><h4 class="text-2xl font-black text-slate-800 dark:text-white">${confirmedPercentage}%</h4></div>
                                    <span class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300">${stats.confirmedSlots}/${stats.filledSlots}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2 dark:bg-slate-700 overflow-hidden"><div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: ${confirmedPercentage}%"></div></div>
                            </div>
                        </div>
                        ${stats.urgent.length > 0 ? `<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg dark:bg-red-900/20"><h4 class="font-bold text-red-700 dark:text-red-400 mb-2 flex items-center gap-2"><span class="text-xl">üî•</span> URGENTE</h4><ul class="list-none space-y-1 text-sm text-red-600 dark:text-red-300 max-h-32 overflow-y-auto custom-scrollbar">${stats.urgent.map(u => `<li class="flex items-start gap-2"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-red-400 shrink-0"></span>${u}</li>`).join('')}</ul></div>` : ''}
                        ${stats.critical.length > 0 ? `<div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg dark:bg-orange-900/20"><h4 class="font-bold text-orange-700 dark:text-orange-400 mb-2 flex items-center gap-2"><span class="text-xl">‚ö†Ô∏è</span> Puestos Cr√≠ticos</h4><ul class="list-none space-y-1 text-sm text-orange-600 dark:text-orange-300">${stats.critical.slice(0, 5).map(c => `<li class="flex items-start gap-2"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-orange-400 shrink-0"></span>${c}</li>`).join('')}${stats.critical.length > 5 ? `<li class="text-xs italic pl-4 opacity-75">... y ${stats.critical.length - 5} m√°s</li>` : ''}</ul></div>` : ''}
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar pr-2 max-h-[400px]">
                        <h4 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 sticky top-0 bg-white dark:bg-slate-800 z-10 py-2 border-b dark:border-slate-700">Estado por Local</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                Object.entries(stats.byLocal).forEach(([local, data]) => {
                    const missing = data.total - data.filled;
                    let statusHtml = '', borderClass = 'border-l-green-500';
                    if (missing === 0 && data.unconfirmedCount === 0) statusHtml = `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full dark:bg-green-900/30 dark:text-green-400">Completo</span>`;
                    else {
                        if (missing > 0) { borderClass = 'border-l-red-500'; statusHtml += `<span class="text-red-500 font-bold text-xs bg-red-50 px-2 py-1 rounded dark:bg-red-900/20 mr-1">-${missing} Vacantes</span>`; }
                        if (data.unconfirmedCount > 0) { if(borderClass === 'border-l-green-500') borderClass = 'border-l-yellow-500'; statusHtml += `<span class="text-yellow-600 font-bold text-xs bg-yellow-50 px-2 py-1 rounded dark:bg-yellow-900/20">‚ö† ${data.unconfirmedCount}</span>`; }
                    }
                    const details = Object.entries(data.missingTypes).map(([type, count]) => `<span class="inline-block bg-red-50 text-red-600 px-1.5 py-0.5 rounded text-[10px] border border-red-100 dark:bg-red-900/20 dark:text-red-300 dark:border-red-900/30">${count} ${type === 'puestos' ? 'Puestos' : type}</span>`).join(' ');
                    if(data.total > 0) html += `<div class="group p-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm hover:shadow-md transition-all border-l-4 ${borderClass}"><div class="flex justify-between items-start mb-1"><span class="font-bold text-slate-700 dark:text-slate-200">${local}</span><div class="flex flex-col items-end gap-1">${statusHtml}</div></div><div class="flex flex-wrap gap-1">${details}</div></div>`;
                });
                html += `</div></div>`;
                container.innerHTML = html;
            } catch (err) { console.error("Error dashboard", err); }
        }

        function renderMapeo() {
            calculateConflicts();
            const container = getEl('mapeo-container');
            if(!container) return;
            container.innerHTML = ''; 
            const week = state.selectedWeek;
            if (!week) return;
            const showAllStructure = true;
            const term = getEl('filtro-local-busqueda').value.toLowerCase();
            const filteredLocales = state.locales.filter(l => l.nombre.toLowerCase().includes(term));
            let renderedLocalesCount = 0;

            filteredLocales.forEach(local => {
                const config = state.mapeoConfig[local.nombre] || {};
                const allTypes = ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'];
                const diasContainer = document.createElement('div');
                let localHasContent = false;
                let totalSlots = 0;
                let filledSlots = 0;

                diasSemana.forEach(dia => {
                    const dConf = config[dia] || {};
                    const activeTypes = allTypes.filter(t => parseInt(dConf[t] || 0) > 0);
                    if (activeTypes.length === 0) return;
                    const diaBlock = document.createElement('div');
                    diaBlock.innerHTML = `<h4 class="text-xs font-bold uppercase bg-slate-100 dark:bg-slate-700 p-1 rounded mb-1 dark:text-slate-300">${dia}</h4>`;
                    const slotsList = document.createElement('div');
                    let diaHasVisibleSlots = false;

                    activeTypes.forEach(tipo => {
                        const count = parseInt(dConf[tipo]);
                        const hIn = dConf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] || '';
                        const hOut = dConf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`] || '';
                        const horario = hIn && hOut ? `${hIn}-${hOut}` : '';
                        
                        for(let i=1; i<=count; i++) {
                            const slotId = `${local.nombre}-${dia}-${tipo}-${i}`;
                            const isAssigned = state.asignaciones[week]?.[slotId];
                            if (!isAssigned && !showAllStructure) continue; 
                            totalSlots++; 
                            if(isAssigned) filledSlots++;
                            slotsList.appendChild(createSlot(slotId, tipo, horario, i));
                            diaHasVisibleSlots = true;
                        }
                    });

                    if (diaHasVisibleSlots) {
                        diaBlock.appendChild(slotsList);
                        diasContainer.appendChild(diaBlock);
                        localHasContent = true;
                    }
                });

                if (!localHasContent && term === '') return;
                renderedLocalesCount++;
                const percent = totalSlots > 0 ? Math.round((filledSlots / totalSlots) * 100) : 0;
                let strokeColor = percent >= 100 ? "#22c55e" : (percent >= 50 ? "#f59e0b" : "#ef4444"); 

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-slate-850 rounded-xl shadow-md border-t-4 border-slate-200 flex flex-col h-full";
                card.style.borderTopColor = local.color || '#cbd5e1';
                
                let headerHtml = `<div class="p-4 border-b dark:border-slate-700 flex justify-between items-center"><div class="flex items-center gap-3"><h3 class="font-bold text-lg dark:text-white">${local.nombre.toUpperCase()}</h3><div class="relative w-10 h-10"><svg class="circular-chart" viewBox="0 0 36 36"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path class="circle" stroke="${strokeColor}" stroke-dasharray="${percent}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg><span class="percentage-text absolute inset-0 flex items-center justify-center text-[10px] font-bold dark:text-white">${percent}%</span></div></div><div class="flex gap-2"><button class="btn-vestimenta-local text-slate-400 hover:text-purple-500" data-local="${local.nombre}" title="Cambiar Vestimenta"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.38 3.46L16 2a4 4 0 01-8 0L3.62 3.46a2 2 0 00-1.34 2.23l.58 3.47a1 1 0 00.99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 002-2V10h2.15a1 1 0 00.99-.84l.58-3.47a2 2 0 00-1.34-2.23z"></path></svg></button><button class="btn-copy-local text-slate-400 hover:text-blue-500" data-local="${local.nombre}" title="Copiar"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg></button><button class="btn-config-local text-slate-400 hover:text-blue-500" data-nombre="${local.nombre}" title="Configurar"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.44-.165a2.25 2.25 0 012.22 0l.44.165c.55.219 1.02.684 1.11 1.226l.098.588a2.25 2.25 0 00-2.25-2.25v.588c0 .542-.368 1.007-.918 1.226l-.441.165a2.25 2.25 0 01-2.22 0l-.441-.165c-.55-.219-1.02-.684-1.11-1.226l-.098-.588a2.25 2.25 0 00-2.25-2.25h-.588c-.542 0-1.007-.368-1.226-.918l-.165-.441a2.25 2.25 0 010 2.22l.165-.441c.219-.55.684 1.02 1.226-1.11h.588a2.25 2.25 0 002.25-2.25v-.588zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z"/></svg></button></div></div>`;
                card.innerHTML = headerHtml;
                const bodyDiv = document.createElement('div');
                bodyDiv.className = "p-2 space-y-2";
                bodyDiv.appendChild(diasContainer);
                card.appendChild(bodyDiv);
                container.appendChild(card);
            });

            if (renderedLocalesCount === 0 && !showAllStructure) {
                 container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center p-12 text-slate-400 opacity-60"><svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg><p class="text-lg font-semibold">Semana Limpia / Hist√≥rica</p><p class="text-sm">Activa el interruptor <b>"Ver Vac√≠os"</b> arriba para asignar personal o editar.</p></div>`;
            }
        }

        // --- FUNCI√ìN RENDER DASHBOARD GERENCIAL ---
        function renderAdminDashboard() {
            const week = state.selectedWeek;
            const asig = state.asignaciones[week] || {};
            
            let totalCost = 0;
            let totalTurnos = 0;
            let totalVacantes = 0;
            const activePersonal = new Set();
            const turnosPorLocal = {};
            let costTerno = 0, costTactica = 0;

            state.locales.forEach(l => turnosPorLocal[l.nombre] = 0);

            state.locales.forEach(l => {
                const conf = state.mapeoConfig[l.nombre] || {};
                diasSemana.forEach(dia => {
                    const dayConf = conf[dia] || {};
                    ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'].forEach(tipo => {
                        const cant = parseInt(dayConf[tipo] || 0);
                        for(let i=1; i<=cant; i++) {
                            const slotId = `${l.nombre}-${dia}-${tipo}-${i}`;
                            const pid = asig[slotId];
                            
                            if (pid) {
                                totalTurnos++;
                                turnosPorLocal[l.nombre] = (turnosPorLocal[l.nombre] || 0) + 1;
                                activePersonal.add(pid);
                                
                                const tarifa = state.tarifarios[pid] || { Terno: 0, Tactica: 0 };
                                const vestimenta = asig[`${slotId}-vestimenta`] || 'Ropa T√°ctica';
                                const costoTurno = vestimenta === 'Terno' ? parseFloat(tarifa.Terno||0) : parseFloat(tarifa.Tactica||0);
                                totalCost += costoTurno;
                                if(vestimenta === 'Terno') costTerno += costoTurno; else costTactica += costoTurno;
                            } else {
                                totalVacantes++;
                            }
                        }
                    });
                });
            });

            const elCosto = document.getElementById('dash-costo');
            const elTurnos = document.getElementById('dash-turnos');
            const elPersonal = document.getElementById('dash-personal');
            const elVacantes = document.getElementById('dash-vacantes');

            if(elCosto) elCosto.textContent = `S/ ${totalCost.toLocaleString('es-PE', {minimumFractionDigits: 2})}`;
            if(elTurnos) elTurnos.textContent = totalTurnos;
            if(elPersonal) elPersonal.textContent = activePersonal.size;
            if(elVacantes) elVacantes.textContent = totalVacantes;

            // Gr√°ficos Chart.js
            const ctx1 = document.getElementById('chart-turnos-local');
            if(ctx1) {
                if (adminCharts.turnos) adminCharts.turnos.destroy();
                adminCharts.turnos = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(turnosPorLocal),
                        datasets: [{
                            label: 'Turnos Cubiertos',
                            data: Object.values(turnosPorLocal),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            const ctx2 = document.getElementById('chart-costos-tipo');
            if(ctx2) {
                if (adminCharts.costos) adminCharts.costos.destroy();
                adminCharts.costos = new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Ropa T√°ctica', 'Terno'],
                        datasets: [{ data: [costTactica, costTerno], backgroundColor: ['#10b981', '#6366f1'], hoverOffset: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.parsed !== null) label += `S/ ${context.parsed.toLocaleString('es-PE')}`; return label; } } } } }
                });
            }
        }

        // --- WATCHWEEK ---
        function watchWeek(week) {
            if(!week) return;
            const loader = getEl('loader');
            const mapContainer = getEl('mapeo-container');
            const progContainer = getEl('programacion-container');
            const planContainer = getEl('tabla-planillas');

            if(loader) loader.style.display = 'flex'; 
            if(mapContainer) mapContainer.innerHTML = ''; 
            if(progContainer) progContainer.innerHTML = '';
            if(planContainer) planContainer.innerHTML = '';

            if(listeners.asignaciones) { listeners.asignaciones(); listeners.asignaciones = null; }
            
            listeners.asignaciones = onSnapshot(doc(collections.asignaciones, week), snap => {
                state.asignaciones[week] = snap.exists() ? snap.data() : {};
                renderMapeo();
                renderProgramacion();
                renderPlanillas();
                setTimeout(() => { if(loader) loader.style.display = 'none'; }, 300);
            }, (error) => { console.error("Error:", error); if(loader) loader.style.display = 'none'; });
        }

        // ... (system status and other standard functions) ...
        function setupSystemStatus() {
            const statusRef = doc(collections.status, 'ping');
            onSnapshot(statusRef, (snap) => { if(snap.exists() && snap.data().timestamp) updateStatusIcon(Date.now() - snap.data().timestamp.toMillis()); }, () => handleConnectionChange(false));
            setInterval(() => { setDoc(statusRef, { timestamp: serverTimestamp() }).catch(() => handleConnectionChange(false)); }, 10000);
        }
        function updateStatusIcon(latency) {
            const icon = getEl('system-status-icon');
            icon.classList.remove('text-slate-300', 'text-green-500', 'text-yellow-500', 'text-red-500', 'animate-pulse');
            if (latency < 800) { icon.classList.add('text-green-500'); icon.parentElement.title = `Conexi√≥n: Excelente (${latency}ms)`; } 
            else if (latency < 2000) { icon.classList.add('text-yellow-500'); icon.parentElement.title = `Conexi√≥n: Regular (${latency}ms)`; } 
            else { icon.classList.add('text-red-500'); icon.parentElement.title = `Conexi√≥n: Lenta (${latency}ms)`; }
        }
        function handleConnectionChange(online) {
            const icon = getEl('system-status-icon');
            icon.classList.remove('text-slate-300', 'text-green-500', 'text-yellow-500', 'text-red-500', 'animate-pulse');
            if (online) { icon.classList.add('text-yellow-500'); showToast("‚úÖ Conexi√≥n restaurada"); } 
            else { icon.classList.add('text-red-500', 'animate-pulse'); icon.parentElement.title = "¬°Sin conexi√≥n!"; showToast("‚ö†Ô∏è Sin conexi√≥n", "error"); }
        }
        function renderConfigModal(localNombre) {
            const container = getEl('schedule-config-container');
            if (!container) return;
            container.innerHTML = '';
            const localConf = tempScheduleConfig;
            diasSemana.forEach(dia => {
                if(!localConf[dia]) localConf[dia] = {};
                const div = document.createElement('div');
                div.className = "p-4 bg-white dark:bg-slate-700 rounded border dark:border-slate-600";
                let html = `<h4 class="font-bold mb-2 capitalize dark:text-white">${dia}</h4>`;
                ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'].forEach(tipo => {
                    const cKey = `hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}`;
                    const cant = localConf[dia][tipo] || 0;
                    const ent = localConf[dia][cKey+'Entrada'] || '08:00 AM';
                    const sal = localConf[dia][cKey+'Salida'] || '08:00 PM';
                    const labelMap = { 'puestos': 'Puestos', 'cacheos': 'Cacheos', 'cacheoIngreso': 'C. Ingreso', 'cacheoSalida': 'C. Salida', 'turno1': '1er Turno', 'turno2': '2do Turno', 'turno3': '3er Turno', 'porteria': 'Porter√≠a' };
                    html += `<div class="grid grid-cols-4 gap-2 items-center mb-2"><label class="text-xs font-medium dark:text-slate-300">${labelMap[tipo]}</label><input type="number" min="0" class="p-1 border rounded text-center config-input" data-dia="${dia}" data-tipo="${tipo}" value="${cant}"><input type="text" class="p-1 border rounded text-center text-xs config-time" data-dia="${dia}" data-key="${cKey}Entrada" value="${ent}"><input type="text" class="p-1 border rounded text-center text-xs config-time" data-dia="${dia}" data-key="${cKey}Salida" value="${sal}"></div>`;
                });
                div.innerHTML = html;
                container.appendChild(div);
            });
        }
        function renderTable(id, data, rowFn) {
            const tbody = getEl(id);
            if (!tbody) return;
            tbody.innerHTML = data.map(item => `<tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition">${rowFn(item)}</tr>`).join('');
        }
        // ... (rest of render functions like renderProgramacion, renderCalendar etc.) ...
        function renderCalendar() {
            const container = getEl('calendar-grid'); if(!container) return; container.innerHTML = '';
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            getEl('current-month-display').textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) container.innerHTML += `<div class="calendar-day opacity-50 bg-slate-100 dark:bg-slate-800"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const activePermits = state.permisos.filter(p => dateStr >= p.startDate && dateStr <= p.endDate);
                let dayContent = `<div class="font-bold text-right text-xs mb-1 dark:text-slate-400">${d}</div>`;
                activePermits.forEach(p => {
                    let color = "bg-yellow-400"; if(p.type === 'baja') color = "bg-red-500 text-white"; if(p.type === 'vacaciones') color = "bg-green-500 text-white";
                    const person = state.personal.find(x => x.id === p.personalId);
                    dayContent += `<div class="permiso-item text-[10px] ${color} px-1 rounded truncate mb-1 cursor-pointer hover:opacity-80 transition-opacity" data-id="${p.id}" title="${p.reason || ''}">${person ? getFullName(person).split(' ')[0] : '???'}</div>`;
                });
                const cell = document.createElement('div'); cell.className = 'calendar-day border dark:border-slate-700 bg-white dark:bg-slate-800 p-1 h-24 overflow-y-auto relative'; cell.innerHTML = dayContent;
                cell.onclick = async (e) => {
                    const itemPermiso = e.target.closest('.permiso-item');
                    if (itemPermiso) {
                        e.stopPropagation();
                        const pid = itemPermiso.dataset.id; const dataPermiso = state.permisos.find(x => x.id === pid); if (!dataPermiso) return;
                        if (confirm(`¬øEliminar ausencia de ${getFullName(state.personal.find(p => p.id === dataPermiso.personalId))}?`)) { await deleteDoc(doc(collections.permisos, pid)); showToast("Ausencia eliminada"); }
                    } else if (e.target === cell || e.target.classList.contains('font-bold')) openAddPermisoModal(dateStr);
                };
                container.appendChild(cell);
            }
        }
        
        function openAddPermisoModal(dateStr) {
            getEl('permiso-start').value = dateStr; getEl('permiso-end').value = dateStr;
            getEl('permiso-personal').innerHTML = state.personal.map(p => `<option value="${p.id}">${getFullName(p)}</option>`).join('');
            getEl('add-permiso-modal').style.display = 'block';
        }
        function renderModalPersonalList() {
            const container = getEl('modal-list-container');
            const term = getEl('modal-search').value.toLowerCase();
            const filtered = state.personal.filter(p => getFullName(p).toLowerCase().includes(term));
            const occupiedIds = new Set(Object.values(state.asignaciones[state.selectedWeek] || {}).filter(v => typeof v === 'string'));
            container.innerHTML = filtered.map(p => {
                const isOccupied = occupiedIds.has(p.id); const isCurrent = state.asignaciones[state.selectedWeek]?.[currentSlotId] === p.id;
                return `<div class="p-3 border-b dark:border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 ${isCurrent ? 'bg-blue-50 dark:bg-blue-900/30' : ''}" onclick="window.selectPersonal('${p.id}')"><div><div class="font-medium dark:text-white">${getFullName(p)}</div><div class="text-xs text-slate-500">${p.numero_empleado || 'S/N'}</div></div>${isOccupied && !isCurrent ? '<span class="text-xs text-orange-500 font-bold">OCUPADO</span>' : ''}${isCurrent ? '<span class="text-green-500 font-bold">‚úî</span>' : ''}</div>`;
            }).join('');
        }
        function renderProgramacion() {
            calculateConflicts();
            const container = getEl('programacion-container'); if(!container) return;
            const term = getEl('busqueda-programacion').value.toLowerCase();
            const weekAsig = state.asignaciones[state.selectedWeek] || {};
            const relevantPersonal = state.personal.filter(p => { const nameMatch = getFullName(p).toLowerCase().includes(term); const hasShift = Object.values(weekAsig).includes(p.id); if (term.length > 0) return nameMatch; return hasShift; });
            const specialRoleMap = { 'cacheos': 'Cacheo', 'cacheoIngreso': 'C. Ingreso', 'cacheoSalida': 'C. Salida', 'porteria': 'Porter√≠a' };
            container.innerHTML = relevantPersonal.map(p => {
                const shifts = Object.entries(weekAsig).filter(([k, v]) => v === p.id && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed')).map(([k]) => {
                        const parts = k.split('-'); parts.pop(); const tipo = parts.pop(); const dia = parts.pop(); const local = parts.join('-'); 
                        const conf = state.mapeoConfig[local]?.[dia];
                        const horario = conf ? (conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] + ' - ' + conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Salida`]) : '??';
                        let isUrgent = false; if (!weekAsig[`${k}-confirmed`]) { const shiftDate = getShiftDate(state.selectedWeek, dia, conf ? conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] : ''); if (shiftDate) { const diffHours = (shiftDate - new Date()) / (1000 * 60 * 60); if (diffHours > 0 && diffHours < 48) isUrgent = true; } }
                        return { local, dia, tipo, horario, isConfirmed: weekAsig[`${k}-confirmed`], vestimenta: weekAsig[`${k}-vestimenta`] || 'Ropa T√°ctica', slotId: k, order: diasSemana.indexOf(dia), startMin: timeToMin(conf ? conf[`hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`] : ''), specialLabel: specialRoleMap[tipo] || null, isUrgent };
                    }).sort((a,b) => { if (a.order !== b.order) return a.order - b.order; return a.startMin - b.startMin; });
                if(shifts.length === 0) return '';
                const allConfirmed = shifts.every(s => s.isConfirmed);
                let borderClass = allConfirmed ? "border-green-500 border-2 shadow-green-100 shadow-lg scale-[1.01]" : "border-yellow-400 border-2 shadow-yellow-50 shadow-md";
                let statusBadge = allConfirmed ? '<div class="absolute top-0 right-0 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">COMPLETO</div>' : '<div class="absolute top-0 right-0 bg-yellow-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">INCOMPLETO</div>';
                return `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md border transition-all duration-300 ${borderClass} flex flex-col h-full relative overflow-hidden"><button class="absolute top-1 left-1 p-1 text-slate-300 hover:text-red-500 transition-colors btn-clear-individual z-20" data-person-id="${p.id}" title="Eliminar TODA la programaci√≥n"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>${statusBadge}<div class="flex justify-between items-center mb-4 mt-2 ml-4"><h4 class="font-bold text-lg dark:text-white truncate pr-2 flex items-center gap-2">${getFullName(p)}${shifts.some(s => s.isUrgent) ? '<span title="Falta confirmar pr√≥ximo turno" class="animate-pulse-red">üìû</span>' : ''}</h4>${allConfirmed ? '<span class="text-green-500 text-2xl">‚úÖ</span>' : ''}</div><div class="space-y-2 flex-grow">${shifts.map(s => { let rowBg = "bg-slate-50 dark:bg-slate-700"; let borderL = "border-l-4 border-transparent"; if (s.isUrgent) rowBg = "urgent-card"; else if (conflictMap.role.has(s.slotId)) { rowBg = "conflict-role"; borderL = "border-l-4 border-blue-500"; } else if (conflictMap.repeat.has(s.slotId)) { rowBg = "conflict-repeat"; borderL = "border-l-4 border-red-500"; } else if (conflictMap.overlap.has(s.slotId)) { rowBg = "conflict-overlap"; borderL = "border-l-4 border-yellow-500"; } return `<div class="text-sm flex justify-between items-center p-2 rounded-lg ${rowBg} ${borderL} transition-colors hover:shadow-sm"><div class="flex flex-col"><div class="flex items-center gap-2"><span class="font-bold capitalize text-blue-600 dark:text-blue-400">${s.dia}</span><span class="text-xs text-slate-400 font-mono">${s.horario}</span>${s.specialLabel ? `<span class="bg-indigo-100 text-indigo-800 text-[10px] font-semibold px-1.5 py-0.5 rounded dark:bg-indigo-900 dark:text-indigo-300 ml-1">+ ${s.specialLabel}</span>` : ''}</div><span class="dark:text-slate-200 font-medium text-xs mt-0.5">${s.local}</span></div><div class="flex items-center gap-3 bg-white/50 dark:bg-black/20 p-1 rounded-md"><span title="${s.vestimenta}">${vestimentaEmojis[s.vestimenta]}</span><span class="${s.isConfirmed ? 'text-green-600' : 'text-slate-300'} text-lg leading-none">${s.isConfirmed ? '‚óè' : '‚óã'}</span></div></div>`}).join('')}</div><div class="mt-5 pt-3 border-t dark:border-slate-700 flex justify-end gap-2"><button class="flex-1 flex items-center justify-center gap-2 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400 dark:hover:bg-emerald-900/50 px-3 py-2 rounded-lg text-sm font-bold transition btn-confirm-individual border border-emerald-200 dark:border-emerald-800" data-person-id="${p.id}" title="Confirmar todos sus turnos">Confirmar</button><button class="flex-1 flex items-center justify-center gap-2 bg-blue-50 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:hover:bg-blue-900/50 px-3 py-2 rounded-lg text-sm font-bold transition btn-copy-individual border border-blue-200 dark:border-blue-800" data-person-id="${p.id}" title="Copiar mensaje WhatsApp">Copiar</button></div></div>`;
            }).join('');
        }
        function renderTarifarioTable() {
            const term = getEl('busqueda-tarifario').value.toLowerCase();
            const filtered = state.personal.filter(p => getFullName(p).toLowerCase().includes(term));
            const tbody = getEl('tabla-tarifario'); if(!tbody) return;
            tbody.innerHTML = filtered.map(p => {
                const t = state.tarifarios[p.id] || {};
                return `<tr class="border-b dark:border-slate-700"><td class="p-3 font-medium dark:text-slate-200">${getFullName(p)}</td><td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Terno||0}" data-uid="${p.id}" data-field="Terno"></td><td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Tactica||0}" data-uid="${p.id}" data-field="Tactica"></td><td class="p-2 text-center"><input type="number" class="w-20 p-1 border rounded text-center dark:bg-slate-600 dark:text-white" value="${t.Apoyo||0}" data-uid="${p.id}" data-field="Apoyo"></td></tr>`;
            }).join('');
        }
        function renderPlanillas() {
            const container = getEl('tabla-planillas'); if(!container) return; 
            const asig = state.asignaciones[state.selectedWeek] || {};
            const report = {};
            state.personal.forEach(p => { report[p.id] = { Terno: 0, Tactica: 0, Apoyo: 0, Nombre: getFullName(p), Tarifas: state.tarifarios[p.id] || { Terno:0, Tactica:0, Apoyo:0 } }; });
            Object.entries(asig).forEach(([key, pid]) => {
                if(!pid || typeof pid !== 'string' || !key.includes('-') || key.endsWith('vestimenta') || key.endsWith('confirmed')) return;
                if (report[pid]) { const vest = asig[`${key}-vestimenta`] || 'Ropa T√°ctica'; if (vest === 'Terno') report[pid].Terno++; else report[pid].Tactica++; }
            });
            const html = Object.values(report).filter(r => r.Terno > 0 || r.Tactica > 0 || r.Apoyo > 0).map(r => {
                const total = (r.Terno * (parseFloat(r.Tarifas.Terno)||0)) + (r.Tactica * (parseFloat(r.Tarifas.Tactica)||0));
                return `<tr class="border-b dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600"><td class="p-3 font-medium dark:text-slate-200">${r.Nombre}</td><td class="p-3 text-center dark:text-slate-300">${r.Terno}</td><td class="p-3 text-center dark:text-slate-300">${r.Tactica}</td><td class="p-3 text-center dark:text-slate-300">-</td><td class="p-3 text-right font-bold text-green-600 dark:text-green-400">S/ ${total.toFixed(2)}</td></tr>`;
            }).join('');
            container.innerHTML = html || '<tr><td colspan="5" class="p-4 text-center text-slate-500">No hay turnos registrados esta semana.</td></tr>';
        }

        // --- MAIN INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            getEl('loader').style.display = 'flex';
            window.addEventListener('online', () => handleConnectionChange(true));
            window.addEventListener('offline', () => handleConnectionChange(false));

            try { await signInAnonymously(auth); } 
            catch (e) { console.error("Error Auth", e); handleConnectionChange(false); }

            const now = new Date();
            const w = `${now.getFullYear()}-W${String(getWeekNumber(now)).padStart(2,'0')}`;
            state.selectedWeek = w;
            
            ['semana-mapeo','semana-programacion','semana-planillas'].forEach(id => {
                const el = getEl(id);
                if(el) el.value = w;
            });
            
            setupListeners();
            setupUIListeners();
            setupSystemStatus();
            
            if(localStorage.getItem('swat_remember') === 'true') getEl('login-overlay').style.display = 'none';
            else getEl('login-overlay').style.display = 'flex';
            
            getEl('loader').style.display = 'none';
        });

        function setupListeners() {
            onSnapshot(query(collections.locales), snap => {
                state.locales = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.nombre.localeCompare(b.nombre)); 
                renderLocalesSelects();
                renderTable('tabla-locales', state.locales, (l) => `<td class="p-3 font-medium flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color:${l.color}"></span>${l.nombre.toUpperCase()}</td><td class="p-3 text-right"><button class="text-indigo-500 hover:text-indigo-700 font-medium mr-2 btn-config-local-gestion" data-nombre="${l.nombre}">Horarios</button><button class="text-blue-500 mr-2 btn-edit-local" data-id="${l.id}">Editar</button><button class="text-red-500 btn-del-local" data-id="${l.id}">Eliminar</button></td>`);
                renderMapeo();
            });

            onSnapshot(query(collections.personal), snap => {
                state.personal = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a, b) => (parseInt(a.numero_empleado)||999999) - (parseInt(b.numero_empleado)||999999));
                renderTable('tabla-personal', state.personal, (p) => `<td class="p-3">${p.numero_empleado||'-'}</td><td class="p-3 font-medium cursor-pointer text-blue-600 hover:underline" onclick="window.verPersonal('${p.id}')">${getFullName(p)}</td><td class="p-3">${p.telefono||'-'}</td>`);
                if(getEl('loader').style.display === 'flex') getEl('loader').style.display = 'none';
            });

            onSnapshot(query(collections.mapeoConfig), snap => {
                state.mapeoConfig = {};
                snap.docs.forEach(d => state.mapeoConfig[d.id] = d.data());
                renderMapeo();
            });

            onSnapshot(query(collections.historial), snap => {
                const hContainer = getEl('historial-container');
                if (!hContainer) return;
                hContainer.innerHTML = '';
                snap.docs.forEach(d => {
                    const isBackup = d.id.includes('_RESPALDO_');
                    const displayName = isBackup ? d.id.replace('_', ' ') : `Semana ${d.id}`;
                    const btnClass = isBackup ? 'border-teal-500 bg-teal-50' : 'border-slate-200';
                    const btn = document.createElement('div');
                    btn.className = `p-3 bg-white dark:bg-slate-700 border mb-2 rounded flex justify-between ${btnClass}`;
                    btn.innerHTML = `<span class="font-medium">${displayName}</span> <button class="text-blue-500 font-bold" onclick="window.loadHist('${d.id}')">Cargar</button>`;
                    hContainer.appendChild(btn);
                });
            });

            onSnapshot(query(collections.tarifarios), snap => {
                state.tarifarios = {};
                snap.docs.forEach(d => state.tarifarios[d.id] = d.data());
                renderTarifarioTable();
                renderPlanillas();
            });
            
            watchWeek(state.selectedWeek);
            
            onSnapshot(query(collections.permisos), snap => {
                state.permisos = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderCalendar();
            });
        }

        function setupUIListeners() {
            getEl('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if(getEl('username').value === 'adminswat' && getEl('password').value === 'adminswat') {
                    if(getEl('remember-me').checked) localStorage.setItem('swat_remember', 'true');
                    else localStorage.removeItem('swat_remember');
                    getEl('login-overlay').style.display = 'none';
                } else getEl('login-error').textContent = "Credenciales incorrectas";
            });
            getEl('btn-logout').onclick = () => { localStorage.removeItem('swat_remember'); location.reload(); };

            ['semana-mapeo', 'semana-programacion', 'semana-planillas'].forEach(id => {
                getEl(id).addEventListener('change', (e) => {
                    state.selectedWeek = e.target.value;
                    ['semana-mapeo', 'semana-programacion', 'semana-planillas'].forEach(i => getEl(i).value = state.selectedWeek);
                    watchWeek(state.selectedWeek);
                });
            });

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    const sec = e.target.id.replace('btn-', 'section-');
                    const targetSection = getEl(sec);
                    if(targetSection) targetSection.classList.remove('hidden');
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    getEl('side-nav').classList.remove('open');
                    if(sec === 'section-tarifario') renderTarifarioTable();
                    if(sec === 'section-programacion') renderProgramacion();
                    if(sec === 'section-planillas') renderPlanillas();
                });
            });

            const nav = getEl('side-nav');
            const toggle = getEl('menu-toggle');
            let navTimeout;
            const openMenu = () => { clearTimeout(navTimeout); nav.classList.add('open'); };
            const closeMenu = () => { navTimeout = setTimeout(() => nav.classList.remove('open'), 300); };
            toggle.addEventListener('mouseenter', openMenu);
            nav.addEventListener('mouseenter', openMenu);
            nav.addEventListener('mouseleave', closeMenu);
            toggle.onclick = () => nav.classList.toggle('open'); 

            getEl('search-fab').onclick = () => getEl('search-panel').classList.toggle('open');
            getEl('close-search-panel').onclick = () => getEl('search-panel').classList.remove('open');
            getEl('filtro-local-busqueda').addEventListener('input', renderMapeo);

            getEl('mapeo-container').addEventListener('click', async (e) => {
                const slotRow = e.target.closest('.slot-row');
                if(slotRow && !e.target.closest('button')) {
                    currentSlotId = slotRow.dataset.slotId;
                    renderModalPersonalList();
                    getEl('global-selection-modal').style.display = 'block';
                    getEl('modal-search').value = '';
                    getEl('modal-search').focus();
                }
                const btnVest = e.target.closest('.vestimenta-btn');
                if(btnVest) {
                    const sid = btnVest.dataset.slot;
                    const cur = state.asignaciones[state.selectedWeek][`${sid}-vestimenta`] || 'Ropa T√°ctica';
                    const next = cur === 'Ropa T√°ctica' ? 'Terno' : 'Ropa T√°ctica';
                    await setDoc(doc(collections.asignaciones, state.selectedWeek), { [`${sid}-vestimenta`]: next }, {merge:true});
                }
                const btnConf = e.target.closest('.conf-btn');
                if(btnConf) {
                    const sid = btnConf.dataset.slot;
                    const cur = state.asignaciones[state.selectedWeek][`${sid}-confirmed`];
                    await setDoc(doc(collections.asignaciones, state.selectedWeek), { [`${sid}-confirmed`]: !cur }, {merge:true});
                }
                const btnConfig = e.target.closest('.btn-config-local');
                if(btnConfig) {
                    currentlyEditingLocal = btnConfig.dataset.nombre;
                    getEl('schedule-config-local-name').textContent = currentlyEditingLocal;
                    tempScheduleConfig = JSON.parse(JSON.stringify(state.mapeoConfig[currentlyEditingLocal] || {}));
                    renderConfigModal(currentlyEditingLocal);
                    getEl('schedule-config-modal').style.display = 'flex';
                }
                const btnCopy = e.target.closest('.btn-copy-local');
                if(btnCopy) generateTextSchedule(btnCopy.dataset.local);

                const btnVestAll = e.target.closest('.btn-vestimenta-local');
                if(btnVestAll) {
                    if(!confirm("¬øCambiar vestimenta de TODOS en este local?")) return;
                    const localName = btnVestAll.dataset.local;
                    const weekData = state.asignaciones[state.selectedWeek];
                    const batchUpdate = {};
                    Object.keys(weekData).forEach(key => {
                        if(key.startsWith(localName + '-') && !key.endsWith('vestimenta') && !key.endsWith('confirmed')) {
                            const curVest = weekData[`${key}-vestimenta`] || 'Ropa T√°ctica';
                            const newVest = curVest === 'Ropa T√°ctica' ? 'Terno' : 'Ropa T√°ctica';
                            batchUpdate[`${key}-vestimenta`] = newVest;
                        }
                    });
                    if(Object.keys(batchUpdate).length > 0) { await setDoc(doc(collections.asignaciones, state.selectedWeek), batchUpdate, {merge:true}); showToast("Vestimenta actualizada"); } 
                    else showToast("No hay personal asignado", "error");
                }
            });
            
            const btnDashboard = getEl('btn-dashboard');
            if (btnDashboard) btnDashboard.onclick = () => { updateDashboard(); getEl('dashboard-modal').style.display = 'block'; };
            const btnCloseDashboard = getEl('close-dashboard-modal');
            if (btnCloseDashboard) btnCloseDashboard.onclick = () => getEl('dashboard-modal').style.display = 'none';
            
            const toolsBtn = getEl('btn-tools-dropdown');
            const toolsMenu = getEl('tools-dropdown-menu');
            if(toolsBtn && toolsMenu) {
                toolsBtn.onclick = (e) => { e.stopPropagation(); toolsMenu.classList.toggle('hidden'); };
                document.addEventListener('click', (e) => { if(!toolsMenu.contains(e.target) && !toolsBtn.contains(e.target)) toolsMenu.classList.add('hidden'); });
            }

            const btnSaveHistory = getEl('btn-save-history');
            if (btnSaveHistory) {
                btnSaveHistory.onclick = async () => {
                    if(!confirm("¬øGuardar estado actual en el historial?")) return;
                    const week = state.selectedWeek;
                    const data = state.asignaciones[week] || {};
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    const backupId = `${week}_RESPALDO_${timestamp}`;
                    await setDoc(doc(collections.historial, backupId), data);
                    await setDoc(doc(collections.asignaciones, backupId), data);
                    showToast("Respaldo guardado exitosamente");
                };
            }
            
            const btnPermisos = getEl('btn-permisos');
            if(btnPermisos) btnPermisos.onclick = () => { renderCalendar(); getEl('permisos-modal').style.display = 'block'; };
            
            getEl('prev-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
            getEl('next-month').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };
            
            getEl('form-permiso').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addDoc(collections.permisos, {
                    personalId: getEl('permiso-personal').value,
                    startDate: getEl('permiso-start').value,
                    endDate: getEl('permiso-end').value,
                    type: getEl('permiso-type').value,
                    reason: getEl('permiso-reason').value
                });
                getEl('add-permiso-modal').style.display = 'none';
                showToast("Ausencia registrada");
            });

            getEl('programacion-container').addEventListener('click', async (e) => {
                const btnClear = e.target.closest('.btn-clear-individual');
                if (btnClear) {
                    if(!confirm("¬øEst√°s seguro de ELIMINAR toda la programaci√≥n de esta persona para esta semana?")) return;
                    const pid = btnClear.dataset.personId;
                    const weekAsig = state.asignaciones[state.selectedWeek] || {};
                    const batchUpdate = {};
                    Object.entries(weekAsig).forEach(([key, val]) => {
                        if (val === pid) {
                            batchUpdate[key] = deleteField();
                            batchUpdate[`${key}-vestimenta`] = deleteField();
                            batchUpdate[`${key}-confirmed`] = deleteField();
                        }
                    });
                    if (Object.keys(batchUpdate).length > 0) {
                        await updateDoc(doc(collections.asignaciones, state.selectedWeek), batchUpdate);
                        showToast("Programaci√≥n eliminada");
                    } else {
                        showToast("No hay turnos para eliminar", "error");
                    }
                    return;
                }

                const btnCopy = e.target.closest('.btn-copy-individual');
                if(btnCopy) {
                    const pid = btnCopy.dataset.personId;
                    const p = state.personal.find(x => x.id === pid);
                    const weekAsig = state.asignaciones[state.selectedWeek] || {};
                    const friendlyLabels = { 'puestos': '', 'cacheos': 'Cacheo', 'cacheoIngreso': 'C. Ingreso', 'cacheoSalida': 'C. Salida', 'turno1': '1er Turno', 'turno2': '2do Turno', 'turno3': '3er Turno', 'porteria': 'Porter√≠a' };
                    const getPriority = (t) => ['puestos','turno1','turno2','turno3', 'cacheoIngreso'].includes(t) ? 1 : 2;
                    const groupedShifts = [];
                    const rawShifts = Object.entries(weekAsig)
                        .filter(([k, v]) => v === pid && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed'))
                        .map(([k]) => {
                            const parts = k.split('-'); parts.pop();
                            const tipo = parts.pop(); const dia = parts.pop(); const local = parts.join('-'); 
                            const conf = state.mapeoConfig[local]?.[dia];
                            const keyName = `hora${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Entrada`;
                            const horaEntrada = conf ? conf[keyName] : '??';
                            return { dia: capitalize(dia), local, horaEntrada, vestimenta: weekAsig[`${k}-vestimenta`] || 'Ropa T√°ctica', order: diasSemana.indexOf(dia), startMin: timeToMin(horaEntrada), label: friendlyLabels[tipo] || '', tipoRaw: tipo };
                        });
                        
                    rawShifts.forEach(s => {
                         const existing = groupedShifts.find(g => g.dia === s.dia && g.local === s.local);
                         if (existing) {
                             const sPriority = getPriority(s.tipoRaw);
                             const existPriority = getPriority(existing.tipoRaw);
                             if (sPriority < existPriority) {
                                 existing.startMin = s.startMin; existing.horaEntrada = s.horaEntrada; existing.vestimenta = s.vestimenta; existing.tipoRaw = s.tipoRaw;
                             } else if (sPriority === existPriority) {
                                 if (s.startMin < existing.startMin) { existing.startMin = s.startMin; existing.horaEntrada = s.horaEntrada; existing.vestimenta = s.vestimenta; }
                             }
                             if (s.label && !existing.labels.includes(s.label)) existing.labels.push(s.label);
                         } else {
                             groupedShifts.push({ dia: s.dia, local: s.local, horaEntrada: s.horaEntrada, startMin: s.startMin, vestimenta: s.vestimenta, order: s.order, tipoRaw: s.tipoRaw, labels: s.label ? [s.label] : [] });
                         }
                    });
                    groupedShifts.sort((a,b) => { if (a.order !== b.order) return a.order - b.order; return a.startMin - b.startMin; });
                    if(groupedShifts.length === 0) return showToast("Sin turnos para copiar", "error");
                    let text = `¬°Hola ${p.nombre}! Tu programaci√≥n es la siguiente:\n\n`;
                    groupedShifts.forEach(s => {
                        const extras = s.labels.map(l => ` + (${l})`).join('');
                        text += `‚Ä¢ ${s.dia} en ${s.local.toUpperCase()}: ${s.horaEntrada} Vestimenta: ${s.vestimenta}.${extras}\n`;
                    });
                    text += `\nMANDAME TU CONFIRMACI√ìN ‚úÖ`;
                    copiarTextoSeguro(text);
                }

                const btnConf = e.target.closest('.btn-confirm-individual');
                if(btnConf) {
                    if(!confirm("¬øConfirmar todos los turnos de esta persona?")) return;
                    const pid = btnConf.dataset.personId;
                    const weekAsig = state.asignaciones[state.selectedWeek] || {};
                    const batchData = {};
                    Object.entries(weekAsig).filter(([k, v]) => v === pid && k.includes('-') && !k.endsWith('-vestimenta') && !k.endsWith('-confirmed')).forEach(([k]) => batchData[`${k}-confirmed`] = true);
                    if(Object.keys(batchData).length > 0) { await setDoc(doc(collections.asignaciones, state.selectedWeek), batchData, {merge:true}); showToast("Turnos confirmados"); }
                }
            });

            getEl('modal-search').addEventListener('input', renderModalPersonalList);
            getEl('btn-unassign-slot').onclick = async () => {
                if(currentSlotId) {
                    await updateDoc(doc(collections.asignaciones, state.selectedWeek), { [currentSlotId]: deleteField(), [`${currentSlotId}-vestimenta`]: deleteField(), [`${currentSlotId}-confirmed`]: deleteField() });
                    getEl('global-selection-modal').style.display = 'none';
                }
            };
            getEl('close-global-modal').onclick = () => getEl('global-selection-modal').style.display = 'none';

            getEl('schedule-config-container').addEventListener('input', (e) => {
                if(e.target.matches('input')) {
                    const { dia, tipo, key } = e.target.dataset;
                    if(!tempScheduleConfig[dia]) tempScheduleConfig[dia] = {};
                    if(key) tempScheduleConfig[dia][key] = e.target.value;
                    else tempScheduleConfig[dia][tipo] = e.target.value;
                }
            });
            getEl('btn-guardar-horarios').onclick = async () => {
                if(currentlyEditingLocal) {
                    await setDoc(doc(collections.mapeoConfig, currentlyEditingLocal), tempScheduleConfig);
                    const week = state.selectedWeek;
                    const currentAssignments = state.asignaciones[week] || {};
                    const updates = {};
                    let hasUpdates = false;

                    Object.keys(currentAssignments).forEach(key => {
                        if (!key.startsWith(currentlyEditingLocal + '-')) return;
                        if (key.endsWith('-vestimenta') || key.endsWith('-confirmed')) return;
                        const parts = key.split('-'); parts.pop(); const type = parts.pop(); const dia = parts.pop();
                        const newCount = parseInt(tempScheduleConfig[dia]?.[type] || 0);
                        const slotIndex = parseInt(key.split('-').pop());
                        if (slotIndex > newCount) {
                            updates[key] = deleteField(); updates[`${key}-vestimenta`] = deleteField(); updates[`${key}-confirmed`] = deleteField();
                            hasUpdates = true;
                        }
                    });
                    if (hasUpdates) { await updateDoc(doc(collections.asignaciones, week), updates); showToast("Horarios guardados y asignaciones limpiadas"); } else showToast("Horarios guardados");
                    getEl('schedule-config-modal').style.display = 'none';
                }
            };
            getEl('btn-limpiar-horarios-local').onclick = async () => { if(confirm("¬øBorrar configuraci√≥n de este local?")) { tempScheduleConfig = {}; renderConfigModal(currentlyEditingLocal); } };
            getEl('close-schedule-config-modal').onclick = () => getEl('schedule-config-modal').style.display = 'none';

            getEl('form-locales').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addDoc(collections.locales, { nombre: getEl('nuevo-local').value.toUpperCase(), color: '#3b82f6' });
                getEl('nuevo-local').value = ''; showToast("Local agregado");
            });
            getEl('tabla-locales').addEventListener('click', async (e) => {
                if(e.target.classList.contains('btn-del-local')) if(confirm("¬øEliminar local?")) await deleteDoc(doc(collections.locales, e.target.dataset.id));
                if(e.target.classList.contains('btn-edit-local')) {
                    const l = state.locales.find(x => x.id === e.target.dataset.id);
                    getEl('edit-local-id').value = l.id; getEl('edit-local-name').value = l.nombre; getEl('edit-local-color').value = l.color;
                    getEl('edit-local-modal').style.display = 'block';
                }
                if(e.target.classList.contains('btn-config-local-gestion')) {
                    currentlyEditingLocal = e.target.dataset.nombre;
                    getEl('schedule-config-local-name').textContent = currentlyEditingLocal;
                    tempScheduleConfig = JSON.parse(JSON.stringify(state.mapeoConfig[currentlyEditingLocal] || {}));
                    renderConfigModal(currentlyEditingLocal);
                    getEl('schedule-config-modal').style.display = 'flex';
                }
            });
            getEl('form-edit-local').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateDoc(doc(collections.locales, getEl('edit-local-id').value), { nombre: getEl('edit-local-name').value.toUpperCase(), color: getEl('edit-local-color').value });
                getEl('edit-local-modal').style.display = 'none';
            });
            getEl('close-local-modal').onclick = () => getEl('edit-local-modal').style.display = 'none';

            const formP = getEl('form-personal');
            getEl('btn-abrir-modal-personal').onclick = () => {
                formP.reset(); getEl('personal-id').value = '';
                const maxId = state.personal.reduce((max, p) => Math.max(max, parseInt(p.numero_empleado) || 0), 0);
                getEl('numero_empleado').value = maxId + 1;
                getEl('personal-modal').style.display = 'block';
            };
            formP.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = { numero_empleado: getEl('numero_empleado').value, nombre: getEl('nombre').value, apellido: getEl('apellido').value, telefono: getEl('telefono').value, disponibilidad: getEl('disponibilidad').value, local1: getEl('local1').value, local2: getEl('local2').value, local3: getEl('local3').value };
                const id = getEl('personal-id').value;
                if(id) await updateDoc(doc(collections.personal, id), data); else await addDoc(collections.personal, data);
                getEl('personal-modal').style.display = 'none'; showToast("Personal guardado");
            });
            getEl('close-personal-modal').onclick = () => getEl('personal-modal').style.display = 'none';
            getEl('close-view-personal-modal').onclick = () => getEl('view-personal-modal').style.display = 'none';
            
            getEl('btn-editar-personal-view').onclick = () => {
                const id = getEl('btn-editar-personal-view').dataset.id; const p = state.personal.find(x => x.id === id);
                if(p) {
                    getEl('personal-id').value = p.id; getEl('numero_empleado').value = p.numero_empleado || ''; getEl('nombre').value = p.nombre || ''; getEl('apellido').value = p.apellido || ''; getEl('telefono').value = p.telefono || ''; getEl('disponibilidad').value = p.disponibilidad || 'disponible'; getEl('local1').value = p.local1 || ''; getEl('local2').value = p.local2 || ''; getEl('local3').value = p.local3 || '';
                    getEl('view-personal-modal').style.display = 'none'; getEl('personal-modal').style.display = 'block';
                }
            };
            getEl('btn-eliminar-personal-view').onclick = async () => { if(confirm("¬øEliminar personal?")) { await deleteDoc(doc(collections.personal, getEl('btn-eliminar-personal-view').dataset.id)); getEl('view-personal-modal').style.display = 'none'; } };

            getEl('btn-copy-previous-week').onclick = async () => {
                if(!confirm("¬øSobrescribir esta semana con la anterior?")) return;
                const curr = state.selectedWeek; const [y, w] = curr.split('-W').map(Number);
                let prevW = w - 1; let prevY = y; if(prevW < 1) { prevW = 52; prevY--; }
                const prevKey = `${prevY}-W${String(prevW).padStart(2,'0')}`;
                const prevDocSnap = await getDoc(doc(collections.asignaciones, prevKey));
                if (prevDocSnap.exists()) { await setDoc(doc(collections.asignaciones, curr), prevDocSnap.data()); showToast("Copiado exitosamente"); } 
                else showToast("No hay datos en la semana anterior", "error");
            };
            
            getEl('btn-limpiar-mapeo').onclick = async () => { if(confirm("¬øBorrar TODAS las asignaciones de esta semana?")) { await setDoc(doc(collections.asignaciones, state.selectedWeek), {}); showToast("Mapeo limpiado"); } };

            getEl('btn-copy-all-schedule').onclick = () => generateTextSchedule(null); 
            
            getEl('btn-descargar-excel').onclick = () => {
                const rows = []; rows.push(["Fecha", "D√≠a", "Local", "Puesto", "Nombre", "Hora Entrada", "Hora Salida", "Vestimenta"]);
                const w = state.selectedWeek; const [yearStr, weekNoStr] = w.split('-W'); const year = parseInt(yearStr); const weekNo = parseInt(weekNoStr);
                const asig = state.asignaciones[w] || {};
                state.locales.forEach(l => {
                    diasSemana.forEach((d, dIndex) => {
                        const mondayDate = getDateOfISOWeek(weekNo, year); const currentDate = new Date(mondayDate); currentDate.setDate(mondayDate.getDate() + dIndex); const dateStr = formatDate(currentDate);
                        const conf = state.mapeoConfig[l.nombre]?.[d]; if(!conf) return;
                        ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'].forEach(t => {
                            const cant = parseInt(conf[t] || 0);
                            for(let i=1; i<=cant; i++) {
                                const sid = `${l.nombre}-${d}-${t}-${i}`; const pid = asig[sid];
                                const pName = pid ? getFullName(state.personal.find(x=>x.id===pid)) : 'VACANTE';
                                rows.push([dateStr, capitalize(d), l.nombre, `${t} ${i}`, pName, conf[`hora${t.charAt(0).toUpperCase()+t.slice(1)}Entrada`]||'', conf[`hora${t.charAt(0).toUpperCase()+t.slice(1)}Salida`]||'', asig[`${sid}-vestimenta`] || 'Ropa T√°ctica']);
                            }
                        });
                    });
                });
                const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mapeo Semanal"); XLSX.writeFile(wb, `Mapeo_Completo_${w}.xlsx`);
            };

            getEl('tabla-tarifario').addEventListener('change', async (e) => {
                if(e.target.matches('input')) {
                    await setDoc(doc(collections.tarifarios, e.target.dataset.uid), { [e.target.dataset.field]: e.target.value }, { merge: true });
                }
            });

            getEl('busqueda-programacion').addEventListener('input', renderProgramacion);
            getEl('busqueda-tarifario').addEventListener('input', renderTarifarioTable);
            
            getEl('btn-exportar-planilla').onclick = () => {
                const table = getEl('tabla-planillas'); const rows = []; const headers = [];
                table.parentElement.querySelectorAll('thead th').forEach(th => headers.push(th.innerText)); rows.push(headers);
                table.querySelectorAll('tr').forEach(tr => { const rowData = []; tr.querySelectorAll('td').forEach(td => rowData.push(td.innerText)); rows.push(rowData); });
                const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Planilla"); XLSX.writeFile(wb, `Planilla_${state.selectedWeek}.xlsx`);
            };

// --- INICIO L√ìGICA SUGERENCIA AVANZADA (HISTORIAL 15 SEMANAS + OCUPADOS + PERMISOS) ---
            const btnSmart = document.getElementById('btn-smart-suggest');
            if (btnSmart) {
                // Funci√≥n auxiliar para retroceder semanas
                const getPrevWeekID = (weekStr) => {
                    let [y, w] = weekStr.split('-W').map(Number);
                    w--;
                    if (w < 1) { w = 52; y--; }
                    return `${y}-W${String(w).padStart(2, '0')}`;
                };

                // Funci√≥n auxiliar para obtener la FECHA exacta del slot (YYYY-MM-DD)
                const getSlotDateString = (weekStr, dayName) => {
                    const [y, w] = weekStr.split('-W').map(Number);
                    const simple = new Date(y, 0, 1 + (w - 1) * 7);
                    const dow = simple.getDay();
                    const ISOweekStart = simple;
                    if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                    else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
                    
                    const diasArr = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
                    const dayIndex = diasArr.indexOf(dayName);
                    
                    // Sumar d√≠as para llegar al d√≠a espec√≠fico del slot
                    const targetDate = new Date(ISOweekStart);
                    targetDate.setDate(targetDate.getDate() + dayIndex);
                    return targetDate.toISOString().split('T')[0];
                };

                btnSmart.onclick = async () => {
                    if (!currentSlotId) return;

                    // 1. Desglosar ID del Slot
                    const parts = currentSlotId.split('-');
                    // Estructura: NOMBRE-LOCAL-dia-tipo-numero.
                    // El d√≠a est√° en la antepen√∫ltima posici√≥n (index 3 contando desde atr√°s)
                    const dayName = parts[parts.length - 3]; 
                    const localName = parts.slice(0, parts.length - 3).join('-');
                    
                    const listContainer = document.getElementById('modal-list-container');

                    // 2. Mensaje de carga
                    listContainer.innerHTML = `
                        <div class="p-4 text-center text-blue-600 bg-blue-50 rounded animate-pulse">
                            <div class="font-bold">üß† Analizando disponibilidad total...</div>
                            <div class="text-xs">Revisando historial, turnos y calendario de permisos.</div>
                        </div>`;

                    try {
                        const weeksToAnalyze = [];
                        let tempWeek = state.selectedWeek;
                        for (let i = 0; i < 15; i++) { 
                            tempWeek = getPrevWeekID(tempWeek);
                            weeksToAnalyze.push(tempWeek);
                        }

                        // 3. Obtener lista de OCUPADOS (Turnos ya asignados esa semana)
                        const occupiedIds = new Set(Object.values(state.asignaciones[state.selectedWeek] || {}).filter(v => typeof v === 'string'));

                        // 4. Obtener lista de AUSENTES (Permisos/Vacaciones en esa FECHA espec√≠fica)
                        const targetDateStr = getSlotDateString(state.selectedWeek, dayName);
                        const absentIds = new Set();
                        
                        // state.permisos ya debe estar cargado desde Firebase en tu c√≥digo principal
                        if (state.permisos && state.permisos.length > 0) {
                            state.permisos.forEach(perm => {
                                // Verificar si la fecha del slot cae dentro del rango del permiso
                                if (targetDateStr >= perm.startDate && targetDateStr <= perm.endDate) {
                                    absentIds.add(perm.personalId);
                                }
                            });
                        }

                        // 5. An√°lisis de Puntos (Score)
                        const stats = {}; 
                        
                        // A. Semana Actual
                        const currentWeekData = state.asignaciones[state.selectedWeek] || {};
                        Object.entries(currentWeekData).forEach(([k, pid]) => {
                            if (pid && k.startsWith(localName + '-') && typeof pid === 'string') {
                                if (!stats[pid]) stats[pid] = { count: 0, score: 0, tags: [] };
                                if (!stats[pid].tags.includes('En Turno')) {
                                    stats[pid].tags.push('En Turno');
                                    stats[pid].score += 50; 
                                }
                            }
                        });

                        // B. Historial 15 Semanas
                        const snapshots = await Promise.all(weeksToAnalyze.map(wID => getDoc(doc(collections.asignaciones, wID))));
                        snapshots.forEach(snap => {
                            if (snap.exists()) {
                                const data = snap.data();
                                Object.entries(data).forEach(([key, pid]) => {
                                    if (key.startsWith(localName + '-') && typeof pid === 'string' && !key.includes('vestimenta')) {
                                        if (!stats[pid]) stats[pid] = { count: 0, score: 0, tags: [] };
                                        stats[pid].count++;
                                        stats[pid].score += 5; 
                                    }
                                });
                            }
                        });

                        // C. Preferencias Perfil
                        state.personal.forEach(p => {
                            if (p.local1 === localName || p.local2 === localName) {
                                if (!stats[p.id]) stats[p.id] = { count: 0, score: 0, tags: [] };
                                stats[p.id].score += 25; 
                                if (!stats[p.id].tags.includes('Preferencia')) stats[p.id].tags.push('Preferencia');
                            }
                        });

                        // 6. Filtrado Final y Ordenamiento
                        const suggestions = Object.keys(stats)
                            .map(pid => {
                                const p = state.personal.find(x => x.id === pid);
                                if (!p) return null;
                                return { ...p, stats: stats[pid] };
                            })
                            .filter(item => {
                                // FILTROS DE SEGURIDAD:
                                return item && 
                                       item.disponibilidad !== 'no-disponible' && // 1. Perfil Disponible
                                       !occupiedIds.has(item.id) &&               // 2. No tiene turno esta semana
                                       !absentIds.has(item.id);                   // 3. NO TIENE PERMISO/VACACIONES HOY
                            })
                            .sort((a, b) => b.stats.score - a.stats.score)
                            .slice(0, 5);

                        // 7. Renderizar
                        if (suggestions.length === 0) {
                            listContainer.innerHTML = `<div class="p-3 text-center text-slate-500 bg-slate-100 mb-2 rounded">No se encontraron sugerencias disponibles (Libres y sin permisos) para ${localName}.</div>`;
                            renderModalPersonalList(); 
                        } else {
                            listContainer.innerHTML = `
                                <div class="p-2 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-900 text-xs font-bold mb-2 rounded border border-purple-300 flex justify-between items-center shadow-sm">
                                    <span>‚úÖ Sugerencias Habilitadas</span>
                                    <span class="bg-white px-2 rounded-full text-[10px] border border-purple-200">100% Libres</span>
                                </div>` +
                                suggestions.map(p => {
                                    const tagsHtml = p.stats.tags.map(t => `<span class="text-[9px] px-1 rounded border ${t==='En Turno'?'bg-purple-100 text-purple-700 border-purple-200':'bg-blue-100 text-blue-700 border-blue-200'}">${t}</span>`).join(' ');
                                    const historyText = p.stats.count > 0 ? `<span class="text-[10px] font-semibold text-slate-500">Historial: ${p.stats.count} turnos</span>` : '';

                                    return `<div class="group relative p-3 border-b dark:border-slate-700 bg-purple-50/40 dark:bg-purple-900/10 flex justify-between items-center cursor-pointer hover:bg-purple-100 dark:hover:bg-slate-700 transition-all" onclick="window.selectPersonal('${p.id}')">
                                        <div class="absolute left-0 top-0 bottom-0 bg-purple-500 w-1 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <div>
                                            <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                                ${getFullName(p)} 
                                                ${tagsHtml}
                                            </div>
                                            <div class="flex flex-col mt-0.5">
                                                ${historyText}
                                                <span class="text-[10px] text-slate-400">Score: ${p.stats.score} pts</span>
                                            </div>
                                        </div>
                                        <span class="text-[10px] text-green-600 font-bold bg-white px-2 py-1 rounded border border-green-200 shadow-sm">HABILITADO</span>
                                    </div>`;
                                }).join('') + 
                                `<div class="text-center text-[10px] text-slate-400 py-1 border-t dark:border-slate-700 mt-2">--- Fin de Sugerencias ---</div>`;
                        }

                    } catch (error) {
                        console.error(error);
                        listContainer.innerHTML = `<div class="text-red-500 text-xs p-2">Error: ${error.message}</div>`;
                    }
                };
            }
            // --- FIN L√ìGICA SUGERENCIA AVANZADA ---
            // --- BUSCADOR GESTI√ìN ---
            const searchGestion = document.getElementById('gestion-personal-search');
            if (searchGestion) {
                searchGestion.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = state.personal.filter(p => getFullName(p).toLowerCase().includes(term) || (p.numero_empleado && p.numero_empleado.toString().includes(term)));
                    renderTable('tabla-personal', filtered, (p) => `<td class="p-3 text-sm text-slate-600 dark:text-slate-300">${p.numero_empleado||'-'}</td><td class="p-3 font-medium cursor-pointer text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline transition-colors" onclick="window.verPersonal('${p.id}')">${getFullName(p)}</td><td class="p-3 text-sm text-slate-600 dark:text-slate-300">${p.telefono||'-'}</td>`);
                });
            }

            // --- ACTIVAR DASHBOARD ---
            const btnDash = document.getElementById('btn-dashboard-admin');
            if (btnDash) {
                btnDash.addEventListener('click', () => {
                    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                    document.getElementById('section-dashboard-admin').classList.remove('hidden');
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    btnDash.classList.add('active');
                    document.getElementById('side-nav').classList.remove('open');
                    renderAdminDashboard();
                });
            }
        }

        function generateTextSchedule(filterLocal) {
            let finalText = ""; const week = state.selectedWeek; const asig = state.asignaciones[week] || {};
            const specialRoleMap = { 'cacheos': 'Cacheo', 'cacheoIngreso': 'Ingreso', 'cacheoSalida': 'Salida', 'porteria': 'Porter√≠a' };
            const localesToPrint = filterLocal ? state.locales.filter(l => l.nombre === filterLocal) : state.locales;
            localesToPrint.forEach(l => {
                let localBlock = `Programaci√≥n ${l.nombre.toUpperCase()}\n\n`; let hasContent = false;
                diasSemana.forEach(d => {
                    const shifts = []; const conf = state.mapeoConfig[l.nombre]?.[d];
                    if (conf) {
                        ['puestos','cacheos','cacheoIngreso','cacheoSalida','turno1','turno2','turno3','porteria'].forEach(t => {
                            const cant = parseInt(conf[t] || 0);
                            for(let i=1; i<=cant; i++) {
                                const pid = asig[`${l.nombre}-${d}-${t}-${i}`];
                                if(pid) {
                                    const p = state.personal.find(x => x.id === pid);
                                    if (p) shifts.push(getFullName(p) + (specialRoleMap[t] ? ` (+ ${specialRoleMap[t]})` : ''));
                                }
                            }
                        });
                    }
                    if (shifts.length > 0) { hasContent = true; localBlock += `${capitalize(d)}\n` + shifts.sort().map((n,i)=>`${i+1}. ${n}`).join('\n') + '\n\n'; }
                });
                if (hasContent) finalText += localBlock + '\n';
            });
            if (!finalText) showToast("No hay asignaciones", "error"); else copiarTextoSeguro(finalText);
        }

        window.verPersonal = (id) => {
            const p = state.personal.find(x => x.id === id);
            if(!p) return;
            getEl('view-personal-name').textContent = getFullName(p);
            getEl('view-personal-details').innerHTML = `
                <p><strong>Tel√©fono:</strong> ${p.telefono || '-'}</p>
                <p><strong>DNI/Legajo:</strong> ${p.numero_empleado || '-'}</p>
                <p><strong>Locales Pref:</strong> ${[p.local1, p.local2, p.local3].filter(Boolean).join(', ')}</p>
            `;
            getEl('btn-editar-personal-view').dataset.id = id;
            getEl('btn-eliminar-personal-view').dataset.id = id;
            getEl('view-personal-modal').style.display = 'block';
        };
        
        window.selectPersonal = async (pid) => {
            if(!currentSlotId) return;
            await setDoc(doc(collections.asignaciones, state.selectedWeek), { [currentSlotId]: pid }, { merge: true });
            getEl('global-selection-modal').style.display = 'none';
        };

        window.loadHist = (weekId) => {
            if(confirm("¬øCargar esta configuraci√≥n hist√≥rica?")) {
                state.selectedWeek = weekId;
                getEl('semana-mapeo').value = weekId;
                watchWeek(weekId);
                alert("Visualizando datos hist√≥ricos. Tenga cuidado al guardar cambios.");
            }
        };

    </script>
</body>
</html>