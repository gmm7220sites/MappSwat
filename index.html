<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Personal para Mapeos (Firebase)</title>
    <link rel="icon" href="logo swat.ico" type="image/x-icon">
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html.dark { color-scheme: dark; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }
        html.dark body {
            background-color: #0f172a;
            color: #cbd5e1;
        }

        /* --- Nuevo Men√∫ de Navegaci√≥n Lateral --- */
        #menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        html.dark #menu-toggle {
            background-color: rgba(30, 41, 59, 0.8);
        }
        #menu-toggle:hover {
            transform: scale(1.1);
        }

        #side-nav {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            padding: 80px 0 20px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1999;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        html.dark #side-nav {
            background-color: rgba(15, 23, 42, 0.7);
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
        }
        #side-nav.open {
            transform: translateX(0);
        }
        #side-nav .nav-button {
            display: block;
            width: calc(100% - 20px);
            margin: 5px 10px;
            text-align: left;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        #side-nav .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.1);
            transition: left 0.4s ease;
        }
        html.dark #side-nav .nav-button::before {
            background-color: rgba(255,255,255,0.1);
        }
        #side-nav .nav-button:hover::before {
            left: 0;
        }
        #side-nav .nav-button.active {
            background-color: #961111;
            color: white;
            box-shadow: 0 4px 8px rgba(150, 17, 17, 0.3);
        }
        /* --- Fin del Men√∫ de Navegaci√≥n --- */

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { 
            background-color: #fefefe; margin: 5% auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px;
            color: #1e293b;
        }
        html.dark .modal-content {
             background-color: #1e293b;
             border-color: #334155;
             color: #e2e8f0;
        }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #16a34a; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        /* Colores de Conflicto */
        .conflict-highlight { background-color: #fee2e2 !important; border-color: #ef4444 !important; } /* Rojo */
        html.dark .conflict-highlight { background-color: #450a0a !important; border-color: #b91c1c !important; }
        
        .schedule-conflict-highlight { background-color: #fef08a !important; border-color: #f59e0b !important; } /* Amarillo */
        html.dark .schedule-conflict-highlight { background-color: #422006 !important; border-color: #92400e !important; }

        .role-conflict-highlight { background-color: #dbeafe !important; border-color: #3b82f6 !important; } /* Celeste */
        html.dark .role-conflict-highlight { background-color: #1e3a8a !important; border-color: #60a5fa !important; }


        .vestimenta-btn { cursor: pointer; font-size: 1.5rem; padding: 4px; border-radius: 8px; background-color: #e2e8f0; transition: background-color: 0.2s ease; }
        .vestimenta-btn:hover { background-color: #cbd5e1; }
        html.dark .vestimenta-btn { background-color: #334155; }
        html.dark .vestimenta-btn:hover { background-color: #475569; }

        .programacion-card { border-top: 4px solid; }
        #loader { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; align-items: center; justify-content: center; }
        html.dark #loader { background-color: rgba(15, 23, 42, 0.8); }

        .main-content { 
            display: block;
            width: 100%;
            min-height: 100vh;
        }
        
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; display: none; align-items: center; justify-content: center;
            background-color: rgba(248, 250, 252, 0.7); /* Fondo claro semi-transparente */
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        html.dark #login-overlay { 
             background-color: rgba(15, 23, 42, 0.7); /* Fondo oscuro semi-transparente */
        }

        #login-overlay .bg-white {
             background-color: rgba(255, 255, 255, 0.9);
        }
        html.dark #login-overlay .bg-white {
             background-color: rgba(30, 41, 59, 0.9); /* slate-800 con transparencia */
        }

        /* --- ESTILOS VISUALES MEJORADOS --- */
        .local-card {
            transition: all 0.2s ease-in-out;
            border-top-width: 4px;
        }
        .local-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        html.dark .local-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
        }
        .dia-grupo {
            padding-top: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom-width: 1px;
        }
        .dia-grupo:last-child {
            border-bottom-width: 0;
            padding-bottom: 0;
        }
        .asignacion-fila {
             display: flex;
             align-items: center;
             gap: 0.75rem;
             margin-bottom: 0.5rem;
             padding: 0.75rem;
             border-radius: 0.5rem;
             background-color: #f8fafc;
             border-left-width: 4px;
             border-color: transparent;
             transition: background-color 0.2s ease;
        }
        .mapeo-select { min-width: 0; }
        html.dark .asignacion-fila {
            background-color: #1a2742;
        }
        .asignacion-fila:hover {
            background-color: #f1f5f9;
        }
        html.dark .asignacion-fila:hover {
            background-color: #334155;
        }

        /* --- Icon Buttons --- */
        .icon-btn {
            background-color: #f1f5f9; /* slate-100 */
            border-radius: 9999px;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        .icon-btn:hover {
            background-color: #e2e8f0; /* slate-200 */
            transform: scale(1.1);
        }
        .icon-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #1e293b; /* slate-800 */
        }
        html.dark .icon-btn {
            background-color: #334155; /* slate-700 */
        }
        html.dark .icon-btn:hover {
            background-color: #475569; /* slate-600 */
        }
        html.dark .icon-btn svg {
            color: #e2e8f0; /* slate-200 */
        }

        /* --- Floating Search Button --- */
        #search-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }
        #search-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            padding: 16px;
            z-index: 1000;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        html.dark #search-panel {
            background-color: rgba(30, 41, 59, 0.8);
        }
        #search-panel.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        /* --- FIN DE ESTILOS VISUALES --- */


        /* Estilos Modo Oscuro */
        html.dark .bg-white { background-color: #1e293b; }
        html.dark .text-slate-800 { color: #e2e8f0; }
        html.dark .text-slate-900 { color: #f1f5f9; }
        html.dark .text-slate-600 { color: #94a3b8; }
        html.dark .bg-slate-200 { background-color: #334155; }
        html.dark .bg-slate-50 { background-color: #0f172a; }
        html.dark .bg-slate-100 { background-color: #334155; }
        html.dark .border-slate-300, html.dark .dia-grupo { border-color: #475569; }
        html.dark input, html.dark select { background-color: #334155; color: #f1f5f9; border-color: #475569; }
        html.dark input:read-only { background-color: #475569; }
        html.dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.4); }
        html.dark .border { border-color: #475569; }
        html.dark .border-b { border-color: #334155; }
        html.dark ::-webkit-calendar-picker-indicator { filter: invert(1); }

        @keyframes blink {
            50% { opacity: 0.3; }
        }
        .notification-bell, .pending-change-indicator {
            animation: blink 1.5s infinite;
            cursor: help;
        }
        .notification-bell {
            color: #f59e0b; /* amber-500 */
            font-size: 1.2rem;
            margin-left: 8px;
        }
        .pending-change-indicator {
            color: #ef4444; /* red-500 */
        }


        #tabla-personal tbody tr { cursor: pointer; }
        #tabla-personal tbody tr:hover { background-color: #f1f5f9; }
        html.dark #tabla-personal tbody tr:hover { background-color: #334155; }
        
        .detail-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; }
        .detail-label { font-semibold; text-align: right; }

        /* Estilos para Planillas y Tarifario */
        .planilla-detalle { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .planilla-detalle.open { max-height: 500px; }
        .descuento-input { color: #ef4444; } /* red-500 */
        .extra-input { color: #22c55e; } /* green-500 */
        .work-day-bar { display: flex; gap: 2px; }
        .work-day { flex: 1; text-align: center; padding: 2px; border-radius: 4px; font-size: 10px; background-color: #e2e8f0; color: #64748b;}
        html.dark .work-day { background-color: #334155; color: #94a3b8; }
        .work-day.worked { background-color: #22c55e; color: white; font-weight: bold; }
        html.dark .work-day.worked { background-color: #16a34a; }
        .pago-btn { cursor: pointer; color: #94a3b8; transition: color 0.2s; }
        .pago-btn:hover { color: #facc15; }
        .pago-btn.active { color: #facc15; }

        /* Iconos de Status y Conexi√≥n */
        #system-status-icon { transition: color 0.5s ease; color: #e2e8f0; /*slate-200*/ }
        html.dark #system-status-icon { color: #475569; /*slate-600*/ }
        #system-status-icon.status-green { color: #22c55e; }
        #system-status-icon.status-yellow { color: #f59e0b; }
        #system-status-icon.status-red { color: #ef4444; }

    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Pantalla de Login -->
    <div id="login-overlay">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-slate-700 font-semibold mb-2">Usuario</label>
                    <input type="text" id="username" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-slate-700 font-semibold mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex items-center mb-6">
                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="remember-me" class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Recordar usuario</label>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>
    
    <!-- Nueva Navegaci√≥n -->
    <button id="menu-toggle">
        <svg class="w-6 h-6 text-slate-800 dark:text-white" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </button>
    <nav id="side-nav">
        <button id="btn-mapeo" class="nav-button">Mapeo Semanal</button>
        <button id="btn-gestion" class="nav-button">Gesti√≥n</button>
        <button id="btn-programacion" class="nav-button">Programaci√≥n</button>
        <button id="btn-tarifario" class="nav-button">Tarifario</button>
        <button id="btn-planillas" class="nav-button">Planillas</button>
        <button id="btn-historial" class="nav-button">Historial</button>
    </nav>


    <div class="container mx-auto p-4 md:p-8 w-full main-content">
        <header class="text-center mb-8 relative">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold text-slate-900"></h1>
            <p class="text-slate-600 mt-2">Plataforma colaborativa para la gesti√≥n de personal y turnos.</p>
            <div class="absolute top-0 right-0 flex items-center gap-4">
                <div id="system-status-container" title="Estado del sistema">
                    <svg id="system-status-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 14v4M9 10v8M13 6v12M17 2v16" />
                    </svg>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" title="Cambiar tema">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </header>

        <div id="status-message-container" class="fixed top-4 right-4 z-50"></div>

        <main>
            <!-- SECCIONES (GESTION, MAPEO, ETC.) -->
            <section id="section-gestion" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900">Gesti√≥n de Locales</h2>
                        <form id="form-locales" class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input type="text" id="nuevo-local" placeholder="Nombre del nuevo local" class="flex-grow p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                            <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">Agregar</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3 font-semibold">Local</th>
                                        <th class="p-3 font-semibold text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-locales"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-slate-900">Base de Datos del Personal</h2>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="btn-reemplazar-personal" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-600">Reemplazar Base de Datos</button>
                                <button id="btn-exportar-bd-personal" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-600">Exportar Base de Datos</button>
                                <input type="file" id="import-personal-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                        </div>
                        <button id="btn-abrir-modal-personal" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 mb-6">Agregar Personal</button>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3">N¬∫ Empleado</th>
                                        <th class="p-3">Nombre Completo</th>
                                        <th class="p-3">Tel√©fono</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-personal"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <section id="section-mapeo">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label for="semana-mapeo" class="font-semibold">Semana:</label>
                        <input type="week" id="semana-mapeo" class="p-2 border rounded-md">
                        <div class="flex-grow"></div>
                        <button id="btn-guardar-programacion" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">Guardar</button>
                        <button id="btn-limpiar-mapeo" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">Limpiar</button>
                        <button id="btn-descargar-excel" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">Excel</button>
                        <button id="btn-download-all-pdf" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">PDF Todos</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="mapeo-container"></div>
                </div>

                <!-- Bot√≥n Flotante de B√∫squeda -->
                <div id="search-fab">
                    <button class="icon-btn bg-blue-500 hover:bg-blue-600 text-white w-14 h-14 shadow-lg">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
                <!-- Panel de B√∫squeda -->
                <div id="search-panel">
                    <label for="filtro-local-busqueda" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Buscar Local o Personal</label>
                    <input type="text" id="filtro-local-busqueda" placeholder="Escribe aqu√≠..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </section>
            <section id="section-programacion" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label for="semana-programacion" class="font-semibold">Semana:</label>
                        <input type="week" id="semana-programacion" class="p-2 border rounded-md">
                        <input type="text" id="busqueda-programacion" placeholder="Buscar personal o local..." class="flex-grow p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="programacion-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </section>
            <section id="section-tarifario" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold">Tarifario Individual por Turno (S/)</h2>
                            <p class="text-sm text-slate-500 mt-1">Los cambios se guardan autom√°ticamente.</p>
                        </div>
                        <div class="relative">
                            <input type="text" id="busqueda-tarifario" placeholder="Buscar por nombre..." class="w-full md:w-64 p-2 pl-10 border rounded-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-3 font-semibold">Nombre Completo</th>
                                    <th class="p-3 font-semibold text-center"><div class="flex items-center justify-center gap-2">ü§µ<span>TERNO</span></div></th>
                                    <th class="p-3 font-semibold text-center"><div class="flex items-center justify-center gap-2">ü•ã<span>TACTICO</span></div></th>
                                    <th class="p-3 font-semibold text-center"><div class="flex items-center justify-center gap-2">ü§ù<span>APOYO</span></div></th>
                                </tr>
                            </thead>
                            <tbody id="tabla-tarifario"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="section-planillas" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                        <label for="semana-planillas" class="font-semibold">Semana para Calcular:</label>
                        <input type="week" id="semana-planillas" class="p-2 border rounded-md">
                        <div class="flex-grow"></div>
                        <button id="btn-exportar-planilla" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-600">Exportar Planilla</button>
                    </div>
                    <div id="planillas-container" class="space-y-8">
                        <!-- Contenido generado por JS -->
                    </div>
                </div>
            </section>
            <section id="section-historial" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Historial y Estad√≠sticas</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="h-80 relative">
                             <canvas id="historial-chart"></canvas>
                        </div>
                        <div class="h-80 relative">
                             <canvas id="pagos-chart"></canvas>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold mb-4 mt-8">Datos Hist√≥ricos</h3>
                    <div id="historial-container" class="overflow-x-auto"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALES -->
    <div id="personal-modal" class="modal">
        <div class="modal-content !max-w-3xl">
            <h3 id="personal-modal-title" class="text-2xl font-bold mb-4">Agregar Personal</h3>
            <form id="form-personal" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <input type="hidden" id="personal-id">
                <div><label for="numero_empleado" class="block text-sm font-medium">N¬∫ de Empleado</label><input type="text" id="numero_empleado" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required></div>
                <div><label for="fecha_ingreso" class="block text-sm font-medium">Fecha de Ingreso</label><input type="date" id="fecha_ingreso" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required></div>
                <div><label for="nombre" class="block text-sm font-medium">Nombre</label><input type="text" id="nombre" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required></div>
                <div><label for="apellido" class="block text-sm font-medium">Apellidos</label><input type="text" id="apellido" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required></div>
                <div><label for="fecha_nacimiento" class="block text-sm font-medium">Fecha de Nacimiento</label><input type="date" id="fecha_nacimiento" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div>
                <div><label for="seguridad_social" class="block text-sm font-medium">N¬∫ Seguridad Social</label><input type="text" id="seguridad_social" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div>
                <div class="md:col-span-2"><label for="direccion" class="block text-sm font-medium">Direcci√≥n</label><input type="text" id="direccion" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div>
                <div><label for="email" class="block text-sm font-medium">E-mail</label><input type="email" id="email" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div>
                <div><label for="telefono" class="block text-sm font-medium">Tel√©fono</label><input type="tel" id="telefono" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required></div>
                <div><label for="contacto_emergencia" class="block text-sm font-medium">Persona de Contacto</label><input type="text" id="contacto_emergencia" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div>
                <div><label for="disponibilidad" class="block text-sm font-medium">Disponibilidad</label><select id="disponibilidad" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" required><option value="disponible">Disponible</option><option value="no-disponible">No Disponible</option></select></div>
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label for="local1" class="block text-sm font-medium">Local Preferido 1</label><select id="local1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"><option value="">Ninguno</option></select></div>
                    <div><label for="local2" class="block text-sm font-medium">Local Preferido 2</label><select id="local2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"><option value="">Ninguno</option></select></div>
                    <div><label for="local3" class="block text-sm font-medium">Local Preferido 3</label><select id="local3" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"><option value="">Ninguno</option></select></div>
                </div>
                <div class="md:col-span-2 flex justify-end gap-4 mt-4">
                    <button type="button" id="close-personal-modal" class="bg-slate-300 py-2 px-4 rounded-md hover:bg-slate-400">Cancelar</button>
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="view-personal-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-start">
                <h3 id="view-personal-name" class="text-2xl font-bold mb-4"></h3>
                <button type="button" id="close-view-personal-modal" class="text-3xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="view-personal-details" class="detail-grid text-sm"></div>
            <div class="mt-6 pt-4 border-t flex justify-end gap-4">
                <button type="button" id="btn-eliminar-personal-view" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">Eliminar</button>
                <button type="button" id="btn-editar-personal-view" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600">Editar</button>
            </div>
        </div>
    </div>

    <div id="edit-local-modal" class="modal"><div class="modal-content"><h3 class="text-2xl font-bold mb-4">Editar Local</h3><form id="form-edit-local" class="flex flex-col gap-4"><input type="hidden" id="edit-local-id"><input type="text" id="edit-local-name" placeholder="Nombre del Local" class="p-2 border rounded-md" required><div class="flex items-center gap-4"><label for="edit-local-color">Color:</label><input type="color" id="edit-local-color" class="h-10 w-10"></div><div class="flex gap-4"><button type="submit" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">Guardar</button><button type="button" id="close-local-modal" class="flex-1 bg-slate-300 py-2 px-4 rounded-md hover:bg-slate-400">Cancelar</button></div></form></div></div>
    
    <!-- INICIO: Modal de Horarios Modificado -->
    <div id="schedule-config-modal" class="modal">
        <div class="modal-content !max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Configurar Horarios para <span id="schedule-config-local-name"></span></h3>
                <button type="button" id="close-schedule-config-modal" class="text-3xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="schedule-config-container" class="space-y-6 max-h-[60vh] overflow-y-auto p-2 bg-slate-50 dark:bg-slate-900 rounded-lg"></div>
            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700 flex justify-end items-center gap-4">
                 <button type="button" id="btn-limpiar-horarios-local" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 mr-auto">Limpiar Puestos</button>
                 <button type="button" id="btn-cancelar-horarios" class="bg-slate-200 dark:bg-slate-600 py-2 px-4 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">Cancelar</button>
                 <button type="button" id="btn-guardar-horarios" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700">Guardar Cambios</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal de Horarios Modificado -->
    
    <div id="message-modal" class="modal"><div class="modal-content"><p id="message-modal-text" class="mb-4"></p><button id="close-message-modal" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">OK</button></div></div>
    
    <!-- INICIO: Modal de Confirmaci√≥n -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="confirmation-modal-text" class="mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirmation-modal-cancel" class="bg-slate-300 dark:bg-slate-600 py-2 px-4 rounded-md hover:bg-slate-400 dark:hover:bg-slate-500">Cancelar</button>
                <button id="confirmation-modal-confirm" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal de Confirmaci√≥n -->

    <!-- INICIO: Modal de An√°lisis con IA -->
    <div id="ai-analysis-modal" class="modal">
        <div class="modal-content !max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold flex items-center gap-2">‚ú® An√°lisis de la Semana con IA</h3>
                <button type="button" id="close-ai-analysis-modal" class="text-3xl font-bold text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="ai-analysis-content" class="prose dark:prose-invert max-w-none max-h-[60vh] overflow-y-auto p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                <!-- Contenido generado por Gemini -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="copy-ai-analysis" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">Copiar Texto</button>
            </div>
        </div>
    </div>
    <!-- FIN: Modal de An√°lisis con IA -->

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, getDocs, updateDoc, deleteField, getDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, push, serverTimestamp as databaseServerTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";

        // --- INICIO: Configuraci√≥n de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBwtZ8Kdvw4LJyu3t0QeaBgq6_0Z_9jrvw",
            authDomain: "swattmapee.firebaseapp.com",
            databaseURL: "https://swattmapee-default-rtdb.firebaseio.com",
            projectId: "swattmapee",
            storageBucket: "swattmapee.appspot.com",
            messagingSenderId: "522791414169",
            appId: "1:522791414169:web:7c2d3c567fbd1d5703cb08",
            measurementId: "G-LSH6K1XH89"
        };
        // --- FIN: Configuraci√≥n de Firebase ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const FIRESTORE_PATHS = {
            PERSONAL: 'personal',
            LOCALES: 'locales',
            MAPEO_CONFIG: 'mapeoConfig',
            ASIGNACIONES: 'asignaciones',
            HISTORIAL: 'historial',
            PLANILLA_CONFIG: 'planillaConfig',
            TARIFARIOS: 'tarifarios',
            PRESENCE: 'presence',
            STATUS: 'status'
        };

        // Referencias a Colecciones de Firestore
        let personalCol, localesCol, mapeoConfigCol, asignacionesCol, historialCol, planillaConfigCol, tarifariosCol, statusCol;

        // --- INICIO: L√≥gica para Deshacer (Ctrl+Z) ---
        let actionHistory = [];
        const MAX_HISTORY = 30;

        function saveUndoState() {
            try {
                const stateSnapshot = {
                    asignaciones: JSON.parse(JSON.stringify(state.asignaciones)),
                    mapeoConfig: JSON.parse(JSON.stringify(state.mapeoConfig))
                };
                actionHistory.push(stateSnapshot);
                if (actionHistory.length > MAX_HISTORY) {
                    actionHistory.shift();
                }
            } catch (error) {
                console.error("Failed to save undo state:", error);
            }
        }

        async function undoLastAction() {
            if (actionHistory.length === 0) {
                showStatusMessage('No hay acciones que deshacer.', 'error');
                return;
            }
            
            const confirmed = await showConfirmationModal('¬øEst√° seguro de que desea deshacer la √∫ltima acci√≥n?');
            if (!confirmed) return;
            
            loader.style.display = 'flex';
            const lastState = actionHistory.pop();

            try {
                const allWeeks = new Set([...Object.keys(state.asignaciones), ...Object.keys(lastState.asignaciones)]);
                for (const week of allWeeks) {
                    await setDoc(doc(db, asignacionesCol.path, week), lastState.asignaciones[week] || {});
                }

                const allLocales = new Set([...Object.keys(state.mapeoConfig), ...Object.keys(lastState.mapeoConfig)]);
                 for (const local of allLocales) {
                    await setDoc(doc(db, mapeoConfigCol.path, local), lastState.mapeoConfig[local] || {});
                }
                showStatusMessage('√öltima acci√≥n deshecha.');
            } catch (error) {
                console.error("Error al deshacer:", error);
                showStatusMessage('No se pudo deshacer la acci√≥n.', 'error');
                actionHistory.push(lastState);
            } finally {
                loader.style.display = 'none';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undoLastAction();
            }
        });
        // --- FIN: L√≥gica para Deshacer (Ctrl+Z) ---


        // Estado local de la aplicaci√≥n
        let state = {
            personal: [],
            locales: [],
            mapeoConfig: {},
            asignaciones: {},
            historial: {},
            planillaConfig: {},
            tarifarios: {},
            selectedWeek: '',
            currentView: 'mapeo',
            searchTermMapeo: '',
            searchTermProgramacion: '',
            searchTermTarifario: '',
            redConflicts: new Set(),
            yellowConflicts: new Set(),
            celesteConflicts: new Set(),
            notifiedChanges: new Set()
        };

        // INICIO: Estado para carga de datos
        let initialDataLoaded = {
            personal: false,
            locales: false,
            mapeoConfig: false,
            asignaciones: false,
            historial: false,
            planillaConfig: false,
            tarifarios: false
        };
        // FIN: Estado para carga de datos

        // INICIO: Variables para el modal de horarios
        let tempScheduleConfig = {};
        let currentlyEditingLocal = null;
        let historialChartInstance, pagosChartInstance;
        // FIN: Variables para el modal de horarios

        // INICIO: Variables para listeners de Firestore
        let listenersAreActive = false;
        let asignacionesListenerUnsubscribe = () => {};
        let planillaConfigListenerUnsubscribe = () => {};
        // FIN: Variables para listeners

        let inactivityTimer;

        // Constantes y Elementos del DOM
        const diasSemana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        const diasSemanaFull = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        const diasSemanaShort = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
        const vestimentaOptions = ['Ropa T√°ctica', 'Terno'];
        const vestimentaEmojis = { 'Ropa T√°ctica': 'ü•ã', 'Terno': 'ü§µ' };
        const tipoPuestoNombres = {
            'puestos': 'Puesto',
            'cacheos': 'Cacheo',
            'cacheoIngreso': 'C. Ingreso',
            'cacheoSalida': 'C. Salida',
            'turno1': '1er. Turno',
            'turno2': '2do. Turno',
            'turno3': '3er. Turno'
        };
        const loader = document.getElementById('loader');
        const mainContent = document.querySelector('.main-content');
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const allSections = document.querySelectorAll('main > section');
        const navButtons = document.querySelectorAll('#side-nav .nav-button');
        const mainTitle = document.getElementById('main-title');
        const formPersonal = document.getElementById('form-personal');
        const formLocales = document.getElementById('form-locales');
        
        const formEditLocal = document.getElementById('form-edit-local');
        const semanaInputMapeo = document.getElementById('semana-mapeo');
        const semanaInputProgramacion = document.getElementById('semana-programacion');
        const semanaInputPlanillas = document.getElementById('semana-planillas');
        const busquedaProgramacionInput = document.getElementById('busqueda-programacion');
        const busquedaTarifarioInput = document.getElementById('busqueda-tarifario');
        const filtroLocalBusquedaInput = document.getElementById('filtro-local-busqueda');
        const personalModal = document.getElementById('personal-modal');
        const viewPersonalModal = document.getElementById('view-personal-modal');
        const editLocalModal = document.getElementById('edit-local-modal');
        const scheduleConfigModal = document.getElementById('schedule-config-modal');
        const importPersonalInput = document.getElementById('import-personal-input');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalText = document.getElementById('confirmation-modal-text');
        const confirmationModalConfirm = document.getElementById('confirmation-modal-confirm');
        const confirmationModalCancel = document.getElementById('confirmation-modal-cancel');


        // --- AUTENTICACI√ìN Y SETUP DE FIREBASE ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            const rememberMe = document.getElementById('remember-me').checked;
            loginError.textContent = '';
            
            if (username === 'adminswat' && password === 'adminswat') {
                if (rememberMe) {
                    localStorage.setItem('mapeoUsername', username);
                    localStorage.setItem('mapeoPassword', password);
                } else {
                    localStorage.removeItem('mapeoUsername');
                    localStorage.removeItem('mapeoPassword');
                }
                
                loginOverlay.style.display = 'none';
                // La carga de datos ahora se centraliza en setupListeners
                setupListeners(); 
                setupSystemStatus();
                resetInactivityTimer();
                inicializarApp();
            } else {
                loginError.textContent = 'Usuario o contrase√±a incorrectos.';
            }
        });

        // This will run on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const appId = "mapeo-app-v2";
            const basePath = `artifacts/${appId}/public/data`;
            personalCol = collection(db, `${basePath}/${FIRESTORE_PATHS.PERSONAL}`);
            localesCol = collection(db, `${basePath}/${FIRESTORE_PATHS.LOCALES}`);
            mapeoConfigCol = collection(db, `${basePath}/${FIRESTORE_PATHS.MAPEO_CONFIG}`);
            asignacionesCol = collection(db, `${basePath}/${FIRESTORE_PATHS.ASIGNACIONES}`);
            historialCol = collection(db, `${basePath}/${FIRESTORE_PATHS.HISTORIAL}`);
            planillaConfigCol = collection(db, `${basePath}/${FIRESTORE_PATHS.PLANILLA_CONFIG}`);
            tarifariosCol = collection(db, `${basePath}/${FIRESTORE_PATHS.TARIFARIOS}`);
            statusCol = collection(db, `${basePath}/${FIRESTORE_PATHS.STATUS}`);

            
            try {
                await signInAnonymously(auth); // Ensure we are connected
            } catch (error) {
                 console.error("Firebase auth failed:", error);
                 showStatusMessage('Error de conexi√≥n con el servidor.', 'error');
            }
            
            // Check for saved credentials
            const savedUser = localStorage.getItem('mapeoUsername');
            const savedPass = localStorage.getItem('mapeoPassword');
            if (savedUser && savedPass) {
                document.getElementById('username').value = savedUser;
                document.getElementById('password').value = savedPass;
                document.getElementById('remember-me').checked = true;
            }

            loginOverlay.style.display = 'flex';
            loader.style.display = 'none';
        });

        // --- INICIO: L√≥gica de carga de datos optimizada ---
        function setupListeners() {
            if (listenersAreActive) return;
            loader.style.display = 'flex';

            // Listener para Locales
            onSnapshot(query(localesCol), snapshot => {
                state.locales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!initialDataLoaded.locales) initialDataLoaded.locales = true;
                debouncedRender();
            }, error => console.error("Error fetching locales:", error));

            // Listener para Personal (con manejo de duplicados)
            onSnapshot(query(personalCol), snapshot => {
                const allPersonal = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const uniquePersonal = [];
                const duplicatesToDelete = new Set();
                const seenNames = new Set();
                const seenNumbers = new Set();

                allPersonal.forEach(p => {
                    const fullName = `${(p.nombre || '').trim().toLowerCase()} ${(p.apellido || '').trim().toLowerCase()}`;
                    const employeeNumber = p.numero_empleado ? String(p.numero_empleado).trim() : null;
                    let isDuplicate = seenNames.has(fullName) || (employeeNumber && seenNumbers.has(employeeNumber));

                    if (isDuplicate) {
                        duplicatesToDelete.add(p.id);
                    } else {
                        uniquePersonal.push(p);
                        if (fullName) seenNames.add(fullName);
                        if(employeeNumber) seenNumbers.add(employeeNumber);
                    }
                });

                if (duplicatesToDelete.size > 0) {
                    showStatusMessage(`Se encontraron y eliminaron ${duplicatesToDelete.size} duplicados autom√°ticamente.`, 'success');
                    duplicatesToDelete.forEach(id => deleteDoc(doc(db, personalCol.path, id)));
                }
                
                state.personal = uniquePersonal;
                if (!initialDataLoaded.personal) initialDataLoaded.personal = true;
                debouncedRender();
            }, error => console.error("Error fetching personal:", error));

            // Listener para Configuraci√≥n de Mapeo
            onSnapshot(query(mapeoConfigCol), snapshot => {
                state.mapeoConfig = {};
                snapshot.docs.forEach(doc => { state.mapeoConfig[doc.id] = doc.data(); });
                if (!initialDataLoaded.mapeoConfig) initialDataLoaded.mapeoConfig = true;
                recalculateConflicts();
                debouncedRender();
            }, error => console.error("Error fetching mapeo config:", error));
            
            // Listener para Historial
            onSnapshot(query(historialCol), snapshot => {
                state.historial = {};
                snapshot.docs.forEach(doc => { state.historial[doc.id] = doc.data(); });
                if (!initialDataLoaded.historial) initialDataLoaded.historial = true;
                debouncedRender();
            }, error => console.error("Error fetching historial:", error));

            // Listener para Tarifarios individuales
            onSnapshot(query(tarifariosCol), snapshot => {
                state.tarifarios = {};
                snapshot.docs.forEach(doc => { state.tarifarios[doc.id] = doc.data(); });
                if(!initialDataLoaded.tarifarios) initialDataLoaded.tarifarios = true;
                debouncedRender();
            }, error => console.error("Error fetching tarifarios:", error));
            
            // Listener para Asignaciones y Planillas (se activa al cambiar de semana)
            if (!state.selectedWeek) {
                 const now = new Date();
                 state.selectedWeek = `${now.getFullYear()}-W${String(now.getWeek()).padStart(2, '0')}`;
            }
            listenToWeekData(state.selectedWeek);
            
            listenersAreActive = true;
        }

        function listenToWeekData(week) {
            listenToAssignments(week);
            listenToPlanillaConfig(week);
        }

        function listenToAssignments(week) {
            if (asignacionesListenerUnsubscribe) asignacionesListenerUnsubscribe();
            
            if (!week) {
                state.asignaciones = {};
                debouncedRender();
                return;
            }
            
            const weekDocRef = doc(db, asignacionesCol.path, week);
            asignacionesListenerUnsubscribe = onSnapshot(weekDocRef, (docSnap) => {
                const weekData = docSnap.exists() ? docSnap.data() : {};
                state.asignaciones[week] = weekData;

                if (!initialDataLoaded.asignaciones) initialDataLoaded.asignaciones = true;
                
                recalculateConflicts();
                debouncedRender();
            }, error => console.error("Error fetching asignaciones:", error));
        }

        function listenToPlanillaConfig(week) {
            if (planillaConfigListenerUnsubscribe) planillaConfigListenerUnsubscribe();

            if (!week) {
                state.planillaConfig = {};
                debouncedRender();
                return;
            }

            const weekDocRef = doc(db, planillaConfigCol.path, week);
            planillaConfigListenerUnsubscribe = onSnapshot(weekDocRef, (docSnap) => {
                state.planillaConfig = docSnap.exists() ? docSnap.data() : {};
                if (!initialDataLoaded.planillaConfig) initialDataLoaded.planillaConfig = true;
                debouncedRender();
            }, error => console.error("Error fetching planilla config:", error));
        }
        // --- FIN: L√≥gica de carga de datos optimizada ---

        function renderCurrentView() {
            switch(state.currentView) {
                case 'gestion':
                    if (initialDataLoaded.locales) renderizarTablaLocales();
                    if (initialDataLoaded.personal) renderizarTablaPersonal();
                    break;
                case 'mapeo':
                    renderizarMapeo();
                    break;
                case 'programacion':
                    renderizarProgramacionPersonal();
                    break;
                case 'tarifario':
                    renderizarTarifario();
                    break;
                case 'planillas':
                    renderizarPlanillas();
                    break;
                case 'historial':
                    if (initialDataLoaded.historial) renderizarHistorial();
                    break;
            }
        }
        
        // --- L√ìGICA DE RENDERIZADO ---
        function renderizarTablaLocales() {
            const tabla = document.getElementById('tabla-locales');
            tabla.innerHTML = '';
            state.locales.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(local => {
                const row = tabla.insertRow();
                row.innerHTML = `
                    <td class="p-3 font-medium flex items-center gap-3">
                        <span class="h-4 w-4 rounded-full" style="background-color: ${local.color || '#cccccc'}"></span>
                        ${local.nombre.toUpperCase()}
                    </td>
                    <td class="p-3 text-right space-x-2">
                        <button data-id="${local.id}" data-nombre="${local.nombre}" data-color="${local.color || '#cccccc'}" class="btn-editar-local bg-yellow-400 text-white font-bold py-1 px-3 rounded-md hover:bg-yellow-500">Editar</button>
                        <button data-id="${local.id}" data-nombre="${local.nombre}" class="btn-configurar-horarios bg-teal-500 text-white font-bold py-1 px-3 rounded-md hover:bg-teal-600">Horarios</button>
                        <button data-id="${local.id}" class="btn-eliminar-local bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600">Eliminar</button>
                    </td>
                `;
            });
        }

        function renderizarTablaPersonal() {
            const tabla = document.getElementById('tabla-personal');
            tabla.innerHTML = '';
            state.personal.sort((a, b) => `${a.nombre} ${a.apellido}`.localeCompare(`${b.nombre} ${b.apellido}`)).forEach(p => {
                const row = tabla.insertRow();
                row.dataset.id = p.id;
                row.innerHTML = `
                    <td class="p-3">${p.numero_empleado || 'N/A'}</td>
                    <td class="p-3">${p.nombre} ${p.apellido}</td>
                    <td class="p-3">${p.telefono}</td>
                `;
            });
        }

        function renderizarSelectsLocales(container) {
            const selects = container.querySelectorAll('select[id*="local"]');
            selects.forEach(select => {
                const currentValue = select.value;
                const firstOption = select.options[0].outerHTML;
                select.innerHTML = firstOption;
                state.locales.forEach(local => {
                    select.innerHTML += `<option value="${local.nombre}">${local.nombre.toUpperCase()}</option>`;
                });
                select.value = currentValue;
            });
        }

        function renderizarMapeoConfig(localNombre, container) {
            const local = state.locales.find(l => l.nombre === localNombre);
            if (!local) return;
            container.innerHTML = '';
            const localConfig = tempScheduleConfig || {};
            
            const createTimeSelectors = (dia, tipo, config, sufijo) => {
                const horaKey = `hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}${sufijo}`;
                const timeString = config[horaKey] || (sufijo === 'Entrada' ? "12:00 AM" : "12:00 PM");
                const timeMatch = timeString.match(/(\d+):(\d+) (AM|PM)/);
                const [h, m, ampm] = timeMatch ? timeMatch.slice(1) : ["12", "00", sufijo === 'Entrada' ? "AM" : "PM"];
                return `
                    <select data-local="${local.nombre}" data-dia="${dia}" data-type="${tipo}" data-part="hour" data-sufijo="${sufijo}" class="mapeo-config-input p-1 border rounded">${Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${h == i+1 ? 'selected' : ''}>${i+1}</option>`).join('')}</select>
                    <select data-local="${local.nombre}" data-dia="${dia}" data-type="${tipo}" data-part="minute" data-sufijo="${sufijo}" class="mapeo-config-input p-1 border rounded"><option value="00" ${m == '00' ? 'selected' : ''}>00</option><option value="30" ${m == '30' ? 'selected' : ''}>30</option></select>
                    <select data-local="${local.nombre}" data-dia="${dia}" data-type="${tipo}" data-part="ampm" data-sufijo="${sufijo}" class="mapeo-config-input p-1 border rounded"><option ${ampm === 'AM' ? 'selected' : ''}>AM</option><option ${ampm === 'PM' ? 'selected' : ''}>PM</option></select>
                `;
            };

            diasSemana.forEach(dia => {
                const config = localConfig[dia] || {};
                const diaDiv = document.createElement('div');
                diaDiv.className = 'mb-4 p-4 bg-white dark:bg-slate-800 rounded-lg border dark:border-slate-700';
                
                let innerHTML = `<h4 class="font-bold text-lg capitalize mb-3">${dia}</h4>
                    <div class="space-y-3">
                        <!-- Header -->
                        <div class="grid grid-cols-[1.5fr_1fr_2fr_2fr] gap-x-4 pb-2 border-b dark:border-slate-600 text-xs font-bold text-slate-500 dark:text-slate-400">
                            <span>Tipo de Puesto</span>
                            <span class="text-center">Cantidad</span>
                            <span class="text-center">Hora Entrada</span>
                            <span class="text-center">Hora Salida</span>
                        </div>
                        <!-- Rows -->
                        ${['puestos', 'cacheos', 'cacheoIngreso', 'cacheoSalida', 'turno1', 'turno2', 'turno3'].map(tipo => `
                            <div class="grid grid-cols-[1.5fr_1fr_2fr_2fr] gap-x-4 items-center">
                                <label class="text-sm font-medium">${tipoPuestoNombres[tipo]}</label>
                                <input type="number" data-local="${local.nombre}" data-dia="${dia}" data-type="${tipo}" data-part="count" class="mapeo-config-input w-16 p-1 border rounded mx-auto" min="0" value="${config[tipo] || 0}">
                                <div class="flex items-center gap-1 justify-center">${createTimeSelectors(dia, tipo, config, 'Entrada')}</div>
                                <div class="flex items-center gap-1 justify-center">${createTimeSelectors(dia, tipo, config, 'Salida')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                diaDiv.innerHTML = innerHTML;
                container.appendChild(diaDiv);
            });
        }

        function renderizarMapeo() {
            const container = document.getElementById('mapeo-container');
            container.innerHTML = '';
            const week = state.selectedWeek;
            if (!week) return;

            const dates = getWeekDates(week);
            const localesFiltrados = state.locales.filter(local => {
                const searchTerm = state.searchTermMapeo;
                if (!searchTerm) return true;
                if (local.nombre.toLowerCase().includes(searchTerm)) return true;
                
                const asignacionesSemana = state.asignaciones[state.selectedWeek] || {};
                const assignedPersonnelIds = Object.entries(asignacionesSemana)
                    .filter(([slotId, personaId]) => slotId.startsWith(local.nombre + '-') && personaId)
                    .map(([_, personaId]) => personaId);
                
                if (assignedPersonnelIds.length > 0) {
                    return [...new Set(assignedPersonnelIds)].some(personaId => {
                        const persona = state.personal.find(p => p.id === personaId);
                        return persona && `${persona.nombre} ${persona.apellido}`.toLowerCase().includes(searchTerm);
                    });
                }
                return false;
            });

            localesFiltrados.forEach(local => {
                const localConfig = state.mapeoConfig[local.nombre] || {};
                const hasPositions = diasSemana.some(dia => (localConfig[dia]?.puestos > 0) || (localConfig[dia]?.cacheos > 0) || (localConfig[dia]?.cacheoIngreso > 0) || (localConfig[dia]?.cacheoSalida > 0) || (localConfig[dia]?.turno1 > 0) || (localConfig[dia]?.turno2 > 0) || (localConfig[dia]?.turno3 > 0));
                if (!hasPositions) return;

                const localCol = document.createElement('div');
                localCol.className = 'bg-white p-6 rounded-xl shadow-lg local-card';
                localCol.id = `local-card-${local.nombre.replace(/\s+/g, '-')}`;
                localCol.style.borderTopColor = local.color || '#cccccc';

                // --- INICIO: C√°lculo de Porcentaje de Completado ---
                let totalPuestos = 0;
                let puestosAsignados = 0;
                const asignacionesSemana = state.asignaciones[week] || {};

                diasSemana.forEach(dia => {
                    const configDia = localConfig[dia] || {};
                    ['puestos', 'cacheos', 'cacheoIngreso', 'cacheoSalida', 'turno1', 'turno2', 'turno3'].forEach(tipo => {
                        const count = parseInt(configDia[tipo] || 0);
                        if(isNaN(count)) return;
                        totalPuestos += count;
                        for (let i = 1; i <= count; i++) {
                            const slotId = `${local.nombre}-${dia}-${tipo}-${i}`;
                            if (asignacionesSemana[slotId]) {
                                puestosAsignados++;
                            }
                        }
                    });
                });
                const porcentaje = totalPuestos > 0 ? (puestosAsignados / totalPuestos) * 100 : 100;
                // --- FIN: C√°lculo de Porcentaje de Completado ---

                localCol.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <h3 class="text-2xl font-bold">${local.nombre.toUpperCase()}</h3>
                            ${createCompletionCircle(porcentaje)}
                        </div>
                        <div class="flex items-center gap-2">
                             <button data-local-nombre="${local.nombre}" title="Cambiar vestimenta para este local" class="icon-btn btn-cambiar-vestimenta-local">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.18-3.182l-3.182 3.183m0 0V7.5m0 4.993l-3.182-3.182M7.5 19.5l-3.182-3.182" /></svg>
                            </button>
                             <button data-id="${local.id}" data-nombre="${local.nombre}" title="Configurar Horarios" class="icon-btn btn-configurar-horarios">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.226l.44-.165a2.25 2.25 0 012.22 0l.44.165c.55.219 1.02.684 1.11 1.226l.098.588a2.25 2.25 0 002.25 2.25h.588c.542 0 1.007.368 1.226.918l.165.441a2.25 2.25 0 010 2.22l-.165.441c-.219.55-.684 1.02-1.226 1.11l-.588.098a2.25 2.25 0 00-2.25 2.25v.588c0 .542-.368 1.007-.918 1.226l-.441.165a2.25 2.25 0 01-2.22 0l-.441-.165c-.55-.219-1.02-.684-1.11-1.226l-.098-.588a2.25 2.25 0 00-2.25-2.25h-.588c-.542 0-1.007-.368-1.226-.918l-.165-.441a2.25 2.25 0 010 2.22l.165-.441c.219-.55.684 1.02 1.226-1.11h.588a2.25 2.25 0 002.25-2.25v-.588zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" /></svg>
                            </button>
                             <button data-local-nombre="${local.nombre}" title="Copiar Programaci√≥n" class="icon-btn btn-copy-local-schedule">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                            </button>
                             <button data-local-nombre="${local.nombre}" title="Descargar PDF" class="icon-btn btn-download-pdf">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                        </div>
                    </div>`;
                
                diasSemana.forEach(dia => {
                    const config = localConfig[dia];
                    if (config && ((config.puestos > 0) || (config.cacheos > 0) || (config.cacheoIngreso > 0) || (config.cacheoSalida > 0) || (config.turno1 > 0) || (config.turno2 > 0) || (config.turno3 > 0))) {
                        const diaContenedor = document.createElement('div');
                        diaContenedor.className = 'dia-grupo border-slate-200 dark:border-slate-700';
                        
                        diaContenedor.innerHTML = `<h4 class="text-lg font-bold capitalize text-slate-800 dark:text-slate-200">${dia} <span class="text-sm font-normal text-slate-500">${dates[dia] || ''}</span></h4>`;
                        
                        const createSubSection = (tipo, count, horaEntrada, horaSalida) => {
                            const numCount = parseInt(count || 0);
                            if (isNaN(numCount) || numCount <= 0) return;

                            const sub = document.createElement('div');
                            sub.className = 'mt-3';
                            sub.innerHTML = `<h5 class="font-semibold text-slate-600 dark:text-slate-400 text-sm mb-2">${tipoPuestoNombres[tipo]}</h5>`;
                            for (let i = 1; i <= numCount; i++) {
                                sub.appendChild(crearSelectAsignacion(tipo, local.nombre, dia, i, horaEntrada, horaSalida));
                            }
                            diaContenedor.appendChild(sub);
                        };
                        
                        createSubSection('puestos', config.puestos, config.horaPuestosEntrada, config.horaPuestosSalida);
                        createSubSection('cacheos', config.cacheos, config.horaCacheosEntrada, config.horaCacheosSalida);
                        createSubSection('cacheoIngreso', config.cacheoIngreso, config.horaCacheoIngresoEntrada, config.horaCacheoIngresoSalida);
                        createSubSection('cacheoSalida', config.cacheoSalida, config.horaCacheoSalidaEntrada, config.horaCacheoSalidaSalida);
                        createSubSection('turno1', config.turno1, config.horaTurno1Entrada, config.horaTurno1Salida);
                        createSubSection('turno2', config.turno2, config.horaTurno2Entrada, config.horaTurno2Salida);
                        createSubSection('turno3', config.turno3, config.horaTurno3Entrada, config.horaTurno3Salida);

                       
                        localCol.appendChild(diaContenedor);
                    }
                });
                container.appendChild(localCol);
            });
        }

        function crearSelectAsignacion(tipo, local, dia, i, horaEntrada, horaSalida) {
            const week = state.selectedWeek;
            const slotId = `${local}-${dia}-${tipo}-${i}`;
            const asignacionActual = state.asignaciones[week]?.[slotId] || '';
            const div = document.createElement('div');
            div.className = 'asignacion-fila'; // Clase para la fila de asignaci√≥n
            
            const weekSlotId = `${week}-${slotId}`;
            if (state.redConflicts.has(weekSlotId)) div.classList.add('conflict-highlight');
            else if (state.celesteConflicts.has(weekSlotId)) div.classList.add('role-conflict-highlight');
            else if (state.yellowConflicts.has(weekSlotId)) div.classList.add('schedule-conflict-highlight');

            const select = document.createElement('select');
            select.dataset.slotId = slotId;
            select.className = 'mapeo-select flex-grow p-2 border rounded bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600';
            
            let optionsHTML = '';
            const sugerencias = obtenerSugerenciaInteligente(local, dia); // Ahora devuelve un array

            if (!asignacionActual && sugerencias.length > 0) {
                const suggestionText = sugerencias.map(p => `${p.nombre} ${p.apellido.charAt(0)}`).join(', ');
                optionsHTML += `<option value="" disabled selected style="color: #9ca3af;">Sugerencia: ${suggestionText}</option>`;
                optionsHTML += `<option value="">-- Limpiar --</option>`;
            } else {
                optionsHTML += `<option value="">-- Seleccionar --</option>`;
            }

            state.personal.filter(p => p.disponibilidad === 'disponible').forEach(p => {
                optionsHTML += `<option value="${p.id}" ${p.id === asignacionActual ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`;
            });
            select.innerHTML = optionsHTML;
            
            const vestimentaActual = state.asignaciones[week]?.[`${slotId}-vestimenta`] || vestimentaOptions[0];
            const vestimentaBtn = document.createElement('button');
            vestimentaBtn.className = 'vestimenta-btn';
            vestimentaBtn.textContent = vestimentaEmojis[vestimentaActual];
            vestimentaBtn.title = `Vestimenta: ${vestimentaActual}`;
            vestimentaBtn.dataset.slotId = slotId;

            const isConfirmed = state.asignaciones[week]?.[`${slotId}-confirmed`] || false;
            const confirmationSwitch = document.createElement('div');
            confirmationSwitch.className = 'toggle-switch-container';
            confirmationSwitch.title = 'Confirmado';
            confirmationSwitch.innerHTML = `<label class="toggle-switch"><input type="checkbox" class="confirmation-checkbox" data-slot-id="${slotId}" ${isConfirmed ? 'checked' : ''}><span class="toggle-slider"></span></label>`;
            
            const horaText = (horaEntrada && horaSalida) ? `${horaEntrada} - ${horaSalida}` : (horaEntrada || 'N/A');

            // --- INICIO: Nueva L√≥gica de Iconos de Notificaci√≥n ---
            const changeTimestamp = state.asignaciones[week]?.[`${slotId}-changeTimestamp`];
            let pendingIconHTML = '';

            if (changeTimestamp && typeof changeTimestamp.toDate === 'function' && !isConfirmed) {
                const changeTime = changeTimestamp.toDate();
                const now = new Date();
                const minutesSinceChange = (now - changeTime) / (1000 * 60);

                if (minutesSinceChange > 15) {
                    pendingIconHTML = `<span class="notification-bell" title="Cambio no confirmado hace m√°s de 15 minutos.">üîî</span>`;
                    triggerDelayedNotificationAlert(slotId, week);
                } else {
                    pendingIconHTML = `<span class="text-xl pending-change-indicator" title="Cambio pendiente de notificar.">‚ùó</span>`;
                }
            }
            // --- FIN: Nueva L√≥gica de Iconos de Notificaci√≥n ---

            div.innerHTML = `<span class="font-bold text-slate-600 dark:text-slate-400 w-8 text-center">${i}.</span><span class="font-medium text-xs text-slate-500 w-40">${horaText}</span>`;
            div.appendChild(select);
            div.innerHTML += pendingIconHTML;
            div.appendChild(vestimentaBtn);
            div.appendChild(confirmationSwitch);
            return div;
        }

        // INICIO: Renderizado de Programaci√≥n Mejorado
        function renderizarProgramacionPersonal() {
            const container = document.getElementById('programacion-container');
            container.innerHTML = '';
            const week = state.selectedWeek;
            
            if (!initialDataLoaded.personal || !initialDataLoaded.asignaciones || !initialDataLoaded.mapeoConfig) {
                container.innerHTML = `<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center p-8 text-slate-500"><p>Cargando programaci√≥n...</p></div>`;
                return;
            }

            if (!week) {
                container.innerHTML = `<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center p-8 text-slate-500"><p>Por favor, selecciona una semana.</p></div>`;
                return;
            }
            
            const personalFiltrado = state.personal.filter(p => {
                const searchTerm = state.searchTermProgramacion;
                if (!searchTerm) return true;
                if (`${p.nombre} ${p.apellido}`.toLowerCase().includes(searchTerm)) return true;

                const asignacionesSemana = state.asignaciones[state.selectedWeek] || {};
                const assignedLocals = Object.entries(asignacionesSemana)
                    .filter(([slotId, personaId]) => personaId === p.id && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed'))
                    .map(([slotId, _]) => slotId.split('-')[0]);

                if(assignedLocals.length > 0) {
                    return [...new Set(assignedLocals)].some(localNombre => localNombre.toLowerCase().includes(searchTerm));
                }
                return false;
            });
            
            if (personalFiltrado.length === 0) {
                container.innerHTML = `<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center p-8 text-slate-500"><p>No se encontraron resultados para la semana y filtro actual.</p></div>`;
                return;
            }

            personalFiltrado.forEach(persona => {
                const asignacionesSemana = state.asignaciones[week] || {};
                const assignments = Object.entries(asignacionesSemana)
                    .filter(([slotId, pId]) => pId === persona.id && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed'))
                    .map(([slotId, _]) => {
                        const [local, dia, tipo] = slotId.split('-');
                        const config = state.mapeoConfig[local]?.[dia] || {};
                        const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                        const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                        const horario = (horaEntrada && horaSalida) ? `${horaEntrada} - ${horaSalida}` : horaEntrada;

                        return {
                            slotId,
                            weekSlotId: `${week}-${slotId}`,
                            local, dia, tipo,
                            horario: horario,
                            vestimenta: asignacionesSemana[`${slotId}-vestimenta`] || vestimentaOptions[0],
                            isConfirmed: asignacionesSemana[`${slotId}-confirmed`] || false,
                            changeTimestamp: asignacionesSemana[`${slotId}-changeTimestamp`] || null,
                        };
                    })
                    .sort((a, b) => diasSemana.indexOf(a.dia) - diasSemana.indexOf(b.dia));
                
                const card = document.createElement('div');
                card.className = `programacion-card bg-white p-6 rounded-xl shadow-md ${assignments.length > 0 ? 'border-green-500' : 'border-slate-200'}`;
                
                let assignmentsHTML = assignments.length > 0 ? `<ul class="mt-4 space-y-2">${assignments.map(a => {
                    let conflictClass = '';
                    if (state.redConflicts.has(a.weekSlotId)) conflictClass = 'conflict-highlight';
                    else if (state.celesteConflicts.has(a.weekSlotId)) conflictClass = 'role-conflict-highlight';
                    else if (state.yellowConflicts.has(a.weekSlotId)) conflictClass = 'schedule-conflict-highlight';
                    
                    // --- INICIO: Nueva L√≥gica de Iconos de Notificaci√≥n para Programaci√≥n ---
                    let notificationHTML = '';
                    if (a.changeTimestamp && typeof a.changeTimestamp.toDate === 'function' && !a.isConfirmed) {
                        const changeTime = a.changeTimestamp.toDate();
                        const now = new Date();
                        const minutesSinceChange = (now - changeTime) / (1000 * 60);

                        if (minutesSinceChange > 15) {
                            notificationHTML = `<span class="notification-bell" title="Cambio no confirmado (+15 min)">üîî</span>`;
                        } else {
                            notificationHTML = `<span class="text-xl pending-change-indicator" title="Cambio pendiente">‚ùó</span>`;
                        }
                    }
                    // --- FIN: Nueva L√≥gica de Iconos de Notificaci√≥n ---


                    return `<li class="p-3 rounded-lg border bg-slate-50 text-sm flex justify-between items-center ${conflictClass}">
                        <span><span class="font-bold">${diasSemanaFull[diasSemana.indexOf(a.dia)]}</span> - ${a.local.toUpperCase()}<br><span class="text-xs text-slate-500">${tipoPuestoNombres[a.tipo] || a.tipo} (${a.horario})</span></span>
                        <span class="flex items-center gap-2">
                            ${notificationHTML}
                            <span class="text-2xl" title="Vestimenta: ${a.vestimenta}">${vestimentaEmojis[a.vestimenta]}</span>
                            <span class="text-xl">${a.isConfirmed ? '‚úÖ' : '‚ùå'}</span>
                        </span>
                    </li>`;
                }).join('')}</ul>` : '<p class="text-sm text-slate-500 mt-2">Sin asignaciones esta semana.</p>';

                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold">${persona.nombre} ${persona.apellido}</h4>
                        <div class="flex items-center gap-2">
                             <button data-person-id="${persona.id}" title="Enviar por WhatsApp" class="btn-send-whatsapp icon-btn !bg-green-100 hover:!bg-green-200 dark:!bg-green-800 dark:hover:!bg-green-700">
                                <svg class="!text-green-600 dark:!text-green-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.89-9.889-9.89-5.452 0-9.887 4.428-9.888 9.89 .001 2.225.651 4.315 1.731 6.086l-.579 2.168 2.223-.58zM12.072 6.78c-.24-.003-.48.09-.662.271l-1.933 1.933c-.021.021-.035.05-.043.081-.006.021-.006.041 0 .062.086.324.239.636.444.939.22.326.477.63.785.908.347.312.721.573 1.129.773.348.174.71.296 1.077.362.016.004.033.004.049 0 .03-.003.059-.013.081-.03l1.832-1.832c.205-.183.498-.246.761-.154a3.179 3.179 0 0 1 1.59 1.59c.092.262.029.555-.154.761l-1.448 1.447c-.426.426-1.01.66-1.611.66-.566 0-1.114-.21-1.554-.582-1.359-1.144-2.429-2.58-3.138-4.119-.245-.536-.358-1.111-.341-1.691.017-.579.208-1.142.55-1.611l1.37-1.37c.24-.24.576-.375.926-.375.213 0 .423.053.618.154a3.179 3.179 0 0 1 1.59 1.59c.101.196.153.406.153.618z"/></svg>
                             </button>
                             <button data-person-id="${persona.id}" title="Confirmar todos los turnos" class="btn-confirmar-persona icon-btn !bg-yellow-100 hover:!bg-yellow-200 dark:!bg-yellow-800 dark:hover:!bg-yellow-700">
                                 <svg class="!text-yellow-600 dark:!text-yellow-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                             </button>
                             <button data-person-id="${persona.id}" title="Copiar programaci√≥n al portapapeles" class="btn-copy-schedule icon-btn !bg-blue-100 hover:!bg-blue-200 dark:!bg-blue-800 dark:hover:!bg-blue-700">
                                <svg class="!text-blue-600 dark:!text-blue-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                            </button>
                        </div>
                    </div>
                    ${assignmentsHTML}`;
                container.appendChild(card);
            });
        }
        // FIN: Renderizado de Programaci√≥n Mejorado
        function renderizarHistorial() {
            const container = document.getElementById('historial-container');
            const historialChartCtx = document.getElementById('historial-chart').getContext('2d');
            const pagosChartCtx = document.getElementById('pagos-chart').getContext('2d');
            
            if (historialChartInstance) historialChartInstance.destroy();
            if (pagosChartInstance) pagosChartInstance.destroy();

            const historialSemanas = Object.keys(state.historial).sort();
            
            container.innerHTML = `<table class="w-full text-left"><thead class="bg-slate-100"><tr><th class="p-3">Semana</th><th class="p-3">Asignaciones</th><th class="p-3 text-right">Pago Neto Total</th><th class="p-3 text-right">Acciones</th></tr></thead><tbody>${historialSemanas.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-500">No hay programaciones guardadas.</td></tr>` : historialSemanas.map(week => {
                const data = state.historial[week] || {};
                const asignacionesCount = Object.keys(data.asignaciones || {}).filter(k => !k.includes('-vestimenta') && !k.includes('-confirmed')).length;
                const pagoNeto = data.payrollSummary?.pagoNetoTotal || 0;
                return `
                <tr class="border-b">
                    <td class="p-3 font-medium">${week}</td>
                    <td class="p-3">${asignacionesCount}</td>
                    <td class="p-3 text-right">S/ ${pagoNeto.toFixed(2)}</td>
                    <td class="p-3 text-right space-x-2">
                        <button data-week="${week}" class="btn-analizar-historial bg-purple-500 text-white font-bold py-1 px-3 rounded-md hover:bg-purple-600">‚ú® Analizar</button>
                        <button data-week="${week}" class="btn-cargar-historial bg-blue-500 text-white font-bold py-1 px-3 rounded-md hover:bg-blue-600">Cargar</button>
                        <button data-week="${week}" class="btn-descargar-historial bg-green-500 text-white font-bold py-1 px-3 rounded-md hover:bg-green-600">Excel</button>
                        <button data-week="${week}" class="btn-eliminar-historial bg-red-500 text-white font-bold py-1 px-3 rounded-md hover:bg-red-600">Eliminar</button>
                    </td>
                </tr>`
            }).join('')}</tbody></table>`;
            
            if (historialSemanas.length === 0) return;

            // --- L√≥gica de Gr√°ficos ---
            const personalDataPoints = historialSemanas.map(week => {
                const asignaciones = state.historial[week]?.asignaciones || {};
                const personalUnico = new Set(Object.values(asignaciones).filter(id => id && typeof id === 'string'));
                return personalUnico.size;
            });

             const pagosDataPoints = historialSemanas.map(week => {
                return state.historial[week]?.payrollSummary?.pagoNetoTotal || 0;
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#cbd5e1' : '#475569';

            historialChartInstance = new Chart(historialChartCtx, {
                type: 'bar',
                data: {
                    labels: historialSemanas,
                    datasets: [{
                        label: 'Cantidad de Personal Asignado',
                        data: personalDataPoints,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Personal Asignado por Semana', color: labelColor, font: { size: 16 } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'N¬∫ de Personas', color: labelColor }, ticks: { color: labelColor, stepSize: 1 }, grid: { color: gridColor } },
                        x: { ticks: { color: labelColor }, grid: { display: false } }
                    }
                }
            });

            pagosChartInstance = new Chart(pagosChartCtx, {
                type: 'line',
                data: {
                    labels: historialSemanas,
                    datasets: [{
                        label: 'Pago Neto Total (S/)',
                        data: pagosDataPoints,
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                 options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Pagos Netos por Semana', color: labelColor, font: { size: 16 } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Monto (S/)', color: labelColor }, ticks: { color: labelColor }, grid: { color: gridColor } },
                        x: { ticks: { color: labelColor }, grid: { display: false } }
                    }
                }
            });
        }

        function renderizarTarifario() {
            const tabla = document.getElementById('tabla-tarifario');
            tabla.innerHTML = '';
            
            const personalFiltrado = state.personal.filter(p => {
                const searchTerm = state.searchTermTarifario;
                if (!searchTerm) return true;
                return `${p.nombre} ${p.apellido}`.toLowerCase().includes(searchTerm);
            });

            personalFiltrado.sort((a,b) => `${a.nombre} ${a.apellido}`.localeCompare(`${b.nombre} ${b.apellido}`)).forEach(persona => {
                const tarifas = state.tarifarios[persona.id] || {};
                const row = tabla.insertRow();
                row.className = "border-b dark:border-slate-700";
                row.innerHTML = `
                    <td class="p-3 font-medium">${persona.nombre} ${persona.apellido}</td>
                    <td class="p-2"><input type="number" min="0" class="w-full p-1 border rounded text-center" value="${tarifas.Terno || 50}" data-person-id="${persona.id}" data-rate-key="Terno"></td>
                    <td class="p-2"><input type="number" min="0" class="w-full p-1 border rounded text-center" value="${tarifas.Tactica || 50}" data-person-id="${persona.id}" data-rate-key="Tactica"></td>
                    <td class="p-2"><input type="number" min="0" class="w-full p-1 border rounded text-center" value="${tarifas.Apoyo || 0}" data-person-id="${persona.id}" data-rate-key="Apoyo"></td>
                `;
            });
        }
        
        async function renderizarPlanillas() {
            const week = semanaInputPlanillas.value;
            const container = document.getElementById('planillas-container');
            container.innerHTML = '';

            if (!week) {
                container.innerHTML = '<p class="text-center p-8 text-slate-500">Seleccione una semana para calcular la planilla.</p>';
                return;
            }

            if (!state.asignaciones[week]) {
                container.innerHTML = '<p class="text-center p-8 text-slate-500">Cargando datos de la semana...</p>';
                return;
            }
            
            const { payrollByLocal, paucarReservas } = calculatePayrollData(week);

            if (Object.keys(payrollByLocal).length === 0 && paucarReservas.length === 0) {
                 container.innerHTML = `<p class="text-center p-8 text-slate-500">No hay personal con turnos asignados en la semana ${week}.</p>`;
                return;
            }

            let granTotalBruto = 0;
            let granTotalExtra = 0;
            let granTotalDescuento = 0;

            Object.keys(payrollByLocal).sort().forEach(localNombre => {
                const localData = payrollByLocal[localNombre];
                const localDiv = document.createElement('div');
                
                let tableHTML = `
                    <h3 class="text-xl font-bold mb-4">${localNombre.toUpperCase()}</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left mb-8">
                             <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-3 font-semibold">Nombre Completo</th>
                                    <th class="p-3 font-semibold text-center">D√≠as Trabajados</th>
                                    <th class="p-3 font-semibold text-right">Pago Bruto</th>
                                    <th class="p-3 font-semibold text-right w-32">Extras</th>
                                    <th class="p-3 font-semibold text-right w-32">Descuento</th>
                                    <th class="p-3 font-semibold text-right">Pago Neto</th>
                                    <th class="p-3 font-semibold text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                Object.values(localData).sort((a,b) => `${a.nombre} ${a.apellido}`.localeCompare(`${b.nombre} ${b.apellido}`)).forEach(data => {
                    const { pagoBruto, extra, descuento, pagoNeto } = calculatePagos(data);
                    
                    granTotalBruto += pagoBruto;
                    granTotalExtra += extra;
                    granTotalDescuento += descuento;
                    
                    const cacheoIcon = data.hizoCacheo ? '<span>üïµüèº‚Äç‚ôÇÔ∏è</span>' : '';
                    const turnoLargoIcon = data.tuvoTurnoLargo ? '<span>üëÅÔ∏è</span>' : '';
                    const apoyoActivo = state.planillaConfig[`apoyo_${data.id}`];

                    tableHTML += `
                        <tr class="border-b">
                            <td class="p-3">
                                <div class="flex items-center gap-2">
                                    <span>${data.nombre} ${data.apellido}</span>
                                    ${cacheoIcon} ${turnoLargoIcon}
                                    <button title="Pago de Apoyo" class="pago-btn btn-pago-apoyo ${apoyoActivo ? 'active' : ''}" data-person-id="${data.id}" data-type="Apoyo">ü§ù</button>
                                </div>
                            </td>
                            <td class="p-3 text-center">${createWorkdayBar(data.workedDays)}</td>
                            <td class="p-3 text-right">S/ ${pagoBruto.toFixed(2)}</td>
                            <td class="p-3 text-right"><input type="number" min="0" step="1" value="${extra.toFixed(2)}" data-planilla-key="extra_${data.id}" class="extra-input w-full p-1 border rounded text-right"></td>
                            <td class="p-3 text-right"><input type="number" min="0" step="1" value="${descuento.toFixed(2)}" data-planilla-key="descuento_${data.id}" class="descuento-input w-full p-1 border rounded text-right"></td>
                            <td class="p-3 text-right font-bold text-lg">S/ ${pagoNeto.toFixed(2)}</td>
                            <td class="p-3 text-center"><button class="btn-ver-detalle bg-sky-100 text-sky-700 text-xs font-bold py-1 px-2 rounded hover:bg-sky-200">Ver Detalles</button></td>
                        </tr>
                        <tr><td colspan="7"><div class="planilla-detalle bg-slate-50 dark:bg-slate-800 p-4"><ul class="list-disc list-inside text-sm space-y-1">${data.turnosDetalle.map(t => `<li><span class="font-semibold">${t.dia}</span> en ${t.local} (${t.tipo})</li>`).join('')}</ul></div></td></tr>
                    `;
                });
                tableHTML += `</tbody></table></div>`;
                localDiv.innerHTML = tableHTML;
                container.appendChild(localDiv);
            });

            if (paucarReservas.length > 0) {
                 let tableHTML = `
                    <h3 class="text-xl font-bold mb-4">APOYOS (RESERVA)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left mb-8">
                             <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-3 font-semibold">Nombre</th>
                                    <th class="p-3 font-semibold">Local</th>
                                    <th class="p-3 font-semibold text-right w-32">Pago (Extras)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                paucarReservas.forEach((data, index) => {
                     const extraKey = `extra_${data.id}`;
                     const extra = parseFloat(state.planillaConfig[extraKey] || 0);
                     granTotalExtra += extra;

                    tableHTML += `
                         <tr class="border-b">
                            <td class="p-3">${index + 1}. ${data.nombre}</td>
                            <td class="p-3">${data.locales.join(', ')}</td>
                            <td class="p-3 text-right"><input type="number" min="0" step="1" value="${extra.toFixed(2)}" data-planilla-key="${extraKey}" class="extra-input w-full p-1 border rounded text-right bg-yellow-100 dark:bg-yellow-900"></td>
                        </tr>
                    `;
                });
                tableHTML += `</tbody></table></div>`;
                container.innerHTML += tableHTML;
            }

            let totalsHTML = `
                <div class="mt-8 pt-4 border-t-2">
                    <h3 class="text-xl font-bold mb-4">TOTALES DE LA SEMANA</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="p-4 bg-slate-100 rounded-lg">
                            <p class="text-sm text-slate-500">PAGO BRUTO</p>
                            <p class="text-2xl font-bold" id="total-pago-bruto">S/ ${granTotalBruto.toFixed(2)}</p>
                        </div>
                        <div class="p-4 bg-green-100 rounded-lg">
                            <p class="text-sm text-green-700">EXTRAS</p>
                            <p class="text-2xl font-bold text-green-800" id="total-extra">S/ ${granTotalExtra.toFixed(2)}</p>
                        </div>
                        <div class="p-4 bg-red-100 rounded-lg">
                            <p class="text-sm text-red-700">DESCUENTOS</p>
                            <p class="text-2xl font-bold text-red-800" id="total-descuento">S/ ${granTotalDescuento.toFixed(2)}</p>
                        </div>
                         <div class="p-4 bg-blue-100 rounded-lg">
                            <p class="text-sm text-blue-700">PAGO NETO</p>
                            <p class="text-2xl font-bold text-blue-800" id="total-pago-neto">S/ ${(granTotalBruto + granTotalExtra - granTotalDescuento).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += totalsHTML;
        }


        // --- L√ìGICA DE EVENTOS ---
        document.getElementById('btn-abrir-modal-personal').addEventListener('click', () => {
            document.getElementById('personal-modal-title').textContent = 'Agregar Personal';
            formPersonal.reset();
            formPersonal['personal-id'].value = '';
            renderizarSelectsLocales(personalModal);
            const employeeNumbers = state.personal.map(p => parseInt(String(p.numero_empleado).replace(/\D/g, ''), 10)).filter(n => !isNaN(n));
            const maxNumber = employeeNumbers.length > 0 ? Math.max(...employeeNumbers) : 0;
            formPersonal.numero_empleado.value = maxNumber + 1;
            formPersonal.numero_empleado.readOnly = true;
            personalModal.style.display = 'block';
        });

        formPersonal.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = formPersonal['personal-id'].value;
            const newNombre = formPersonal.nombre.value.trim();
            const newApellido = formPersonal.apellido.value.trim();
            const newNumEmpleado = formPersonal.numero_empleado.value.trim();

            const isDuplicate = state.personal.some(p => {
                if(id && p.id === id) return false;
                const fullNameMatch = p.nombre.trim().toLowerCase() === newNombre.toLowerCase() && p.apellido.trim().toLowerCase() === newApellido.toLowerCase();
                const employeeNumberMatch = p.numero_empleado && String(p.numero_empleado).trim() === newNumEmpleado;
                return fullNameMatch || employeeNumberMatch;
            });

            if(isDuplicate) {
                showStatusMessage('Ya existe un empleado con el mismo nombre y apellido o n√∫mero de empleado.', 'error');
                return;
            }
            
            const nuevaPersona = {
                numero_empleado: newNumEmpleado,
                fecha_ingreso: formPersonal.fecha_ingreso.value,
                nombre: newNombre,
                apellido: newApellido,
                fecha_nacimiento: formPersonal.fecha_nacimiento.value,
                seguridad_social: formPersonal.seguridad_social.value,
                direccion: formPersonal.direccion.value,
                email: formPersonal.email.value,
                telefono: formPersonal.telefono.value,
                contacto_emergencia: formPersonal.contacto_emergencia.value,
                disponibilidad: formPersonal.disponibilidad.value,
                local1: formPersonal.local1.value,
                local2: formPersonal.local2.value,
                local3: formPersonal.local3.value,
            };

            try {
                if (id) {
                    await setDoc(doc(db, personalCol.path, id), nuevaPersona);
                    showStatusMessage('Personal actualizado');
                } else {
                    await addDoc(personalCol, nuevaPersona);
                    showStatusMessage('Personal agregado');
                }
                personalModal.style.display = 'none';
            } catch (error) {
                console.error("Error saving personal:", error);
                showStatusMessage('Error al guardar datos.', 'error');
            }
        });

        formLocales.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = e.target['nuevo-local'].value.trim().toLowerCase();
            const colorPalette = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'];
            const randomColor = colorPalette[Math.floor(Math.random() * colorPalette.length)];
            if (nombre && !state.locales.some(l => l.nombre === nombre)) {
                try {
                    await addDoc(localesCol, { nombre, color: randomColor });
                    showStatusMessage('Local agregado');
                    formLocales.reset();
                } catch (error) {
                    console.error("Error adding local:", error);
                    showStatusMessage('No se pudo agregar el local.', 'error');
                }
            } else {
                showStatusMessage('El local ya existe o el nombre es inv√°lido.', 'error');
            }
        });

        
        formEditLocal.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = e.target['edit-local-id'].value;
            const nombre = e.target['edit-local-name'].value.trim().toLowerCase();
            const color = e.target['edit-local-color'].value;
            if (nombre) {
                try {
                    await setDoc(doc(db, localesCol.path, id), { nombre, color }, { merge: true });
                    showStatusMessage('Local actualizado');
                    editLocalModal.style.display = 'none';
                } catch (error) {
                    console.error("Error updating local:", error);
                    showStatusMessage('No se pudo actualizar el local.', 'error');
                }
            }
        });
        
        document.getElementById('tabla-personal').addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.id) {
                populateViewPersonalModal(row.dataset.id);
            }
        });

        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            // --- L√≥gica de Botones ---
            try {
                 if (button.matches('.btn-pago-apoyo')) {
                    const personId = button.dataset.personId;
                    const type = button.dataset.type;
                    const week = state.selectedWeek;
                    if (!personId || !type || !week) return;

                    const key = `${type.toLowerCase()}_${personId}`;
                    const currentState = !!state.planillaConfig[key];
                    await setDoc(doc(db, planillaConfigCol.path, week), { [key]: !currentState }, { merge: true });
                }
                else if (button.matches('.btn-ver-detalle')) {
                    const detailDiv = button.closest('tr').nextElementSibling.querySelector('.planilla-detalle');
                    detailDiv.classList.toggle('open');
                }
                else if (button.matches('.btn-download-pdf')) {
                    downloadLocalAsPDF(button.dataset.localNombre);
                } else if (button.matches('#btn-download-all-pdf')) {
                    downloadAllLocalsAsPDF();
                }
                else if (button.matches('.vestimenta-btn')) {
                    const week = state.selectedWeek;
                    const slotId = button.dataset.slotId;
                    const personaId = state.asignaciones[week]?.[slotId];
                    if (!personaId) return;

                    saveUndoState();
                    const docRef = doc(db, asignacionesCol.path, week);
                    const currentVestimenta = state.asignaciones[week]?.[`${slotId}-vestimenta`] || vestimentaOptions[0];
                    const nextIndex = (vestimentaOptions.indexOf(currentVestimenta) + 1) % vestimentaOptions.length;
                    const nextVestimenta = vestimentaOptions[nextIndex];
                    await setDoc(docRef, { [`${slotId}-vestimenta`]: nextVestimenta }, { merge: true });

                } else if (button.matches('.btn-send-whatsapp')) {
                    sendWhatsappMessage(button.dataset.personId);
                } else if (button.matches('.btn-analizar-historial')) {
                    const week = button.dataset.week;
                    analizarSemanaConIA(week);
                } else if (button.matches('.btn-confirmar-persona')) {
                    const personId = button.dataset.personId;
                    const persona = state.personal.find(p => p.id === personId);
                    const week = state.selectedWeek;
                    if (!persona || !week) return;

                    const confirmed = await showConfirmationModal(`¬øConfirmar la asistencia de ${persona.nombre} ${persona.apellido} para toda la semana?`);
                    if (confirmed) {
                        const updates = {};
                        Object.entries(state.asignaciones[week] || {}).forEach(([slotId, pId]) => {
                            if (pId === personId && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed')) {
                                updates[`${slotId}-confirmed`] = true;
                                updates[`${slotId}-changeTimestamp`] = deleteField();
                            }
                        });

                        if (Object.keys(updates).length > 0) {
                            saveUndoState();
                            await setDoc(doc(db, asignacionesCol.path, week), updates, { merge: true });
                            showStatusMessage(`Asistencia confirmada para ${persona.nombre} ${persona.apellido}`);
                        } else {
                            showStatusMessage(`${persona.nombre} no tiene asignaciones para confirmar.`, 'error');
                        }
                    }
                } else if (button.matches('.btn-cambiar-vestimenta-local')) {
                    const localNombre = button.dataset.localNombre;
                    const week = state.selectedWeek;
                    if (!week || !localNombre) return;
                    
                    const asignacionesSemana = state.asignaciones[week] || {};
                    const firstSlotId = Object.keys(asignacionesSemana).find(slotId => slotId.startsWith(localNombre + '-') && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed') && asignacionesSemana[slotId]);
                    const currentVestimenta = (firstSlotId && asignacionesSemana[`${firstSlotId}-vestimenta`]) || vestimentaOptions[0];
                    const nextVestimenta = currentVestimenta === vestimentaOptions[0] ? vestimentaOptions[1] : vestimentaOptions[0];
                    const updates = {};
                    let hasAssignments = false;
                    Object.keys(asignacionesSemana).forEach(slotId => {
                        if (slotId.startsWith(localNombre + '-') && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed') && asignacionesSemana[slotId]) {
                            updates[`${slotId}-vestimenta`] = nextVestimenta;
                            hasAssignments = true;
                        }
                    });

                    if (hasAssignments) {
                        const confirmed = await showConfirmationModal(`¬øCambiar vestimenta a ${nextVestimenta} para TODO el personal de ${localNombre.toUpperCase()}?`);
                        if(confirmed) {
                            saveUndoState();
                            await setDoc(doc(db, asignacionesCol.path, week), updates, { merge: true });
                            showStatusMessage(`Vestimenta cambiada para ${localNombre.toUpperCase()}`);
                        }
                    } else if (!hasAssignments) {
                        showStatusMessage(`No hay personal asignado en ${localNombre.toUpperCase()} para cambiar vestimenta.`, 'error');
                    }
                } else if (button.matches('#btn-editar-personal-view')) {
                    populateEditPersonalModal(button.dataset.id);
                } else if (button.matches('#btn-eliminar-personal-view')) {
                    const confirmed = await showConfirmationModal('¬øSeguro que quieres eliminar a esta persona?');
                    if (confirmed) {
                        await deleteDoc(doc(db, personalCol.path, button.dataset.id));
                        viewPersonalModal.style.display = 'none';
                        showStatusMessage('Personal eliminado');
                    }
                } else if (button.matches('.btn-editar-local')) {
                    formEditLocal['edit-local-id'].value = button.dataset.id;
                    formEditLocal['edit-local-name'].value = button.dataset.nombre;
                    formEditLocal['edit-local-color'].value = button.dataset.color;
                    editLocalModal.style.display = 'block';
                } else if (button.matches('.btn-configurar-horarios')) {
                    // INICIO: L√≥gica para abrir modal de horarios
                    currentlyEditingLocal = button.dataset.nombre;
                    tempScheduleConfig = JSON.parse(JSON.stringify(state.mapeoConfig[currentlyEditingLocal] || {}));
                    document.getElementById('schedule-config-local-name').textContent = currentlyEditingLocal.toUpperCase();
                    document.getElementById('btn-limpiar-horarios-local').dataset.localNombre = currentlyEditingLocal;
                    renderizarMapeoConfig(currentlyEditingLocal, document.getElementById('schedule-config-container'));
                    scheduleConfigModal.style.display = 'block';
                    // FIN: L√≥gica para abrir modal
                } else if (button.matches('#btn-limpiar-horarios-local')) {
                     // INICIO: L√≥gica para limpiar horarios en el modal
                    const localNombre = button.dataset.localNombre;
                    const confirmed = await showConfirmationModal(`¬øEst√°s seguro de que quieres poner en 0 todos los puestos para ${localNombre.toUpperCase()}? Esta acci√≥n no se guardar√° hasta que hagas clic en "Guardar Cambios".`);
                    if (localNombre && confirmed) {
                        diasSemana.forEach(dia => {
                            if (!tempScheduleConfig[dia]) tempScheduleConfig[dia] = {};
                            ['puestos', 'cacheos', 'cacheoIngreso', 'cacheoSalida', 'turno1', 'turno2', 'turno3'].forEach(tipo => tempScheduleConfig[dia][tipo] = 0);
                        });
                        renderizarMapeoConfig(localNombre, document.getElementById('schedule-config-container'));
                        showStatusMessage(`Puestos limpiados para ${localNombre.toUpperCase()}. Haz clic en Guardar para confirmar.`);
                    }
                    // FIN: L√≥gica para limpiar horarios
                } else if (button.matches('#btn-guardar-horarios')) {
                    const localNombre = currentlyEditingLocal;
                    const originalConfig = state.mapeoConfig[localNombre] || {};
                    const newConfig = tempScheduleConfig;
                    let hasReductions = false;
                    diasSemana.forEach(dia => {
                        ['puestos', 'cacheos', 'cacheoIngreso', 'cacheoSalida', 'turno1', 'turno2', 'turno3'].forEach(tipo => {
                            const oldCount = originalConfig[dia]?.[tipo] || 0;
                            const newCount = newConfig[dia]?.[tipo] || 0;
                            if (newCount < oldCount) hasReductions = true;
                        });
                    });

                    if (hasReductions) {
                        const confirmed = await showConfirmationModal('Reducir el n√∫mero de puestos eliminar√° las asignaciones existentes para los puestos eliminados. ¬øDesea continuar?');
                        if (!confirmed) return;
                    }

                    saveUndoState();
                    await setDoc(doc(db, mapeoConfigCol.path, localNombre), newConfig);

                    const updates = {};
                    diasSemana.forEach(dia => {
                         ['puestos', 'cacheos', 'cacheoIngreso', 'cacheoSalida', 'turno1', 'turno2', 'turno3'].forEach(tipo => {
                            const oldCount = originalConfig[dia]?.[tipo] || 0;
                            const newCount = newConfig[dia]?.[tipo] || 0;
                            if (newCount < oldCount) {
                                for (let i = newCount + 1; i <= oldCount; i++) {
                                    const slotId = `${localNombre}-${dia}-${tipo}-${i}`;
                                    updates[slotId] = deleteField();
                                    updates[`${slotId}-vestimenta`] = deleteField();
                                    updates[`${slotId}-confirmed`] = deleteField();
                                    updates[`${slotId}-changeTimestamp`] = deleteField();
                                }
                            }
                        });
                    });

                    if (Object.keys(updates).length > 0 && state.selectedWeek) {
                         const weekDocRef = doc(db, asignacionesCol.path, state.selectedWeek);
                         await setDoc(weekDocRef, updates, { merge: true });
                    }
                    showStatusMessage('Horarios guardados correctamente.');
                    scheduleConfigModal.style.display = 'none';
                } else if (button.matches('.btn-eliminar-local')) {
                    const confirmed = await showConfirmationModal('¬øSeguro que quieres eliminar este local?');
                    if (confirmed) {
                        await deleteDoc(doc(db, localesCol.path, button.dataset.id));
                        showStatusMessage('Local eliminado');
                    }
                } else if (button.matches('.btn-copy-schedule')) {
                    copyPersonalSchedule(button.dataset.personId);
                } else if (button.matches('.btn-copy-local-schedule')) {
                    copyLocalSchedule(button.dataset.localNombre);
                } else if (button.matches('.btn-cargar-historial')) {
                    const week = button.dataset.week;
                    const confirmed = await showConfirmationModal(`¬øCargar la programaci√≥n de la semana ${week}? Esto sobreescribir√° la configuraci√≥n actual.`);
                    if (confirmed) {
                        const dataHistorial = state.historial[week];
                        if (dataHistorial) {
                            saveUndoState();
                            if (dataHistorial.asignaciones) await setDoc(doc(db, asignacionesCol.path, week), dataHistorial.asignaciones);
                            if (dataHistorial.mapeoConfig) {
                                for (const local in dataHistorial.mapeoConfig) {
                                    await setDoc(doc(db, mapeoConfigCol.path, local), dataHistorial.mapeoConfig[local]);
                                }
                            }
                             if (dataHistorial.planillaConfig) {
                                await setDoc(doc(db, planillaConfigCol.path, week), dataHistorial.planillaConfig);
                            }
                            state.selectedWeek = week;
                            semanaInputMapeo.value = week;
                            semanaInputProgramacion.value = week;
                            semanaInputPlanillas.value = week;
                            cambiarVista('mapeo');
                            showStatusMessage(`Programaci√≥n cargada.`);
                        }
                    }
                } else if (button.matches('.btn-eliminar-historial')) {
                    const week = button.dataset.week;
                    const confirmed = await showConfirmationModal(`¬øEliminar el historial de la semana ${week}?`);
                    if (confirmed) {
                        await deleteDoc(doc(db, historialCol.path, week));
                        showStatusMessage('Historial eliminado');
                    }
                } else if (button.matches('.btn-descargar-historial')) {
                    const week = button.dataset.week;
                    const scheduleData = state.historial[week];
                    if (scheduleData) {
                        descargarExcel(week, scheduleData);
                    } else {
                        showStatusMessage(`No se encontraron datos hist√≥ricos para la semana ${week}.`, 'error');
                    }
                } else if (button.matches('#btn-guardar-programacion')) {
                    const week = state.selectedWeek;
                    if (week) {
                        const { payrollByLocal, paucarReservas } = calculatePayrollData(week);
                        let pagoNetoTotal = 0;
                        Object.values(payrollByLocal).forEach(localData => {
                            Object.values(localData).forEach(data => {
                                const { pagoNeto } = calculatePagos(data);
                                pagoNetoTotal += pagoNeto;
                            });
                        });
                         paucarReservas.forEach(data => {
                            const extra = parseFloat(state.planillaConfig[`extra_${data.id}`] || 0);
                            pagoNetoTotal += extra;
                        });

                        await setDoc(doc(db, historialCol.path, week), {
                            asignaciones: state.asignaciones[week] || {},
                            mapeoConfig: state.mapeoConfig,
                            planillaConfig: state.planillaConfig || {},
                            payrollSummary: { pagoNetoTotal }
                        });
                        showStatusMessage('Programaci√≥n y planilla guardada en el historial.');
                    } else {
                        showStatusMessage('Selecciona una semana para poder guardarla.', 'error');
                    }
                } else if (button.matches('#btn-limpiar-mapeo')) {
                    const confirmed = await showConfirmationModal('¬øEst√° seguro de que desea limpiar todas las asignaciones de la semana actual?');
                    if (confirmed) {
                        saveUndoState();
                        await setDoc(doc(db, asignacionesCol.path, state.selectedWeek), {});
                        showStatusMessage('Mapeo de la semana limpiado.');
                    }
                } else if (button.matches('#btn-descargar-excel')) {
                    descargarExcel(state.selectedWeek, { asignaciones: state.asignaciones[state.selectedWeek], mapeoConfig: state.mapeoConfig });
                } else if (button.matches('#btn-reemplazar-personal')) {
                    importPersonalInput.click();
                } else if (button.matches('#btn-exportar-bd-personal')) {
                    exportarBaseDatosPersonal();
                } else if (button.matches('#btn-exportar-planilla')) {
                    exportarPlanillaExcel();
                }
            } catch (error) {
                console.error("Button click error:", error);
                showStatusMessage("La operaci√≥n fall√≥. Revisa la consola para m√°s detalles.", "error");
            }
        });

        document.getElementById('section-tarifario').addEventListener('input', debounce(async (e) => {
            const target = e.target;
            if (target.matches('input[type="number"]')) {
                const personId = target.dataset.personId;
                const rateKey = target.dataset.rateKey;
                const value = parseFloat(target.value) || 0;
                if (personId && rateKey) {
                    try {
                        await setDoc(doc(db, tarifariosCol.path, personId), { [rateKey]: value }, { merge: true });
                    } catch (error) {
                         console.error("Error updating tarifario: ", error);
                         showStatusMessage("No se pudo guardar la tarifa.", "error");
                    }
                }
            }
        }, 500));


        document.getElementById('section-planillas').addEventListener('input', debounce(async (e) => {
            const target = e.target;
            const week = semanaInputPlanillas.value;
            if (!week) return;

            const update = {};
            if (target.matches('.extra-input, .descuento-input')) {
                const key = target.dataset.planillaKey;
                const value = parseFloat(target.value) || 0;
                update[key] = value;
            }

            if (Object.keys(update).length > 0) {
                try {
                    await setDoc(doc(db, planillaConfigCol.path, week), update, { merge: true });
                } catch (error) {
                    console.error("Error updating planilla config: ", error);
                    showStatusMessage("No se pudo guardar el cambio en la planilla.", "error");
                }
            }
        }, 500));

        document.body.addEventListener('change', async (e) => {
            const target = e.target;
            try {
                if (target.matches('.mapeo-config-input')) {
                    const { local, dia, type, part, sufijo } = target.dataset;
                    
                    const config = tempScheduleConfig;
                    if (!config[dia]) config[dia] = {};
                    
                    if (part === 'count') {
                        config[dia][type] = parseInt(target.value, 10) || 0;
                    } else {
                        const horaKey = `hora${type.charAt(0).toUpperCase() + tipo.slice(1)}${sufijo}`;
                        const parent = target.closest('div');
                        config[dia][horaKey] = `${parent.querySelector(`[data-part="hour"][data-sufijo="${sufijo}"]`).value}:${parent.querySelector(`[data-part="minute"][data-sufijo="${sufijo}"]`).value} ${parent.querySelector(`[data-part="ampm"][data-sufijo="${sufijo}"]`).value}`;
                    }
                } else if (target.matches('.mapeo-select')) {
                    // --- INICIO: L√≥gica de Notificaci√≥n Inteligente ---
                    const week = state.selectedWeek;
                    const slotId = target.dataset.slotId;
                    const newPersonaId = target.value;
                    const oldPersonaId = state.asignaciones[week]?.[slotId] || '';

                    if (oldPersonaId === newPersonaId) return;

                    saveUndoState();

                    const updates = {
                        [slotId]: newPersonaId,
                        [`${slotId}-confirmed`]: false 
                    };

                    let isSignificantChange = false;

                    if (newPersonaId) { // Solo evaluar si se est√° asignando a alguien.
                        const [currentLocal, currentDia, currentTipo] = slotId.split('-');
                        const otherAssignmentsToday = Object.entries(state.asignaciones[week] || {})
                            .filter(([sId, pId]) => pId === newPersonaId && sId.includes(`-${currentDia}-`) && sId !== slotId);

                        if (otherAssignmentsToday.length === 0) {
                            // Es significativo porque es el primer turno del d√≠a para esta persona.
                            isSignificantChange = true;
                        } else {
                            // Es significativo si cambia de local o de tipo de rol (puesto vs cacheo).
                            isSignificantChange = otherAssignmentsToday.some(([sId, pId]) => {
                                const [otherLocal, , otherTipo] = sId.split('-');
                                if (currentLocal !== otherLocal) return true;
                                const isCurrentRoleCacheo = currentTipo.toLowerCase().includes('cacheo');
                                const isOtherRoleCacheo = otherTipo.toLowerCase().includes('cacheo');
                                return isCurrentRoleCacheo !== isOtherRoleCacheo;
                            });
                        }
                    }

                    if (isSignificantChange) {
                        updates[`${slotId}-changeTimestamp`] = serverTimestamp();
                    } else {
                        updates[`${slotId}-changeTimestamp`] = deleteField();
                    }

                    await setDoc(doc(db, asignacionesCol.path, week), updates, { merge: true });
                     // --- FIN: L√≥gica de Notificaci√≥n Inteligente ---
                    
                } else if (target.matches('.confirmation-checkbox')) {
                    const week = state.selectedWeek;
                    const slotId = target.dataset.slotId;
                    const isChecked = target.checked;
                    
                    const updates = { [`${slotId}-confirmed`]: isChecked };
                    if (isChecked) {
                        updates[`${slotId}-changeTimestamp`] = deleteField();
                    }
                    saveUndoState();
                    await setDoc(doc(db, asignacionesCol.path, week), updates, { merge: true });
                }
            } catch (error) {
                console.error("Change event error:", error);
                showStatusMessage("No se pudo guardar el cambio.", "error");
            }
        });
        
        importPersonalInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            reemplazarBaseDatosDesdeExcel(file);
        });

        document.getElementById('close-personal-modal').onclick = () => personalModal.style.display = 'none';
        document.getElementById('close-view-personal-modal').onclick = () => viewPersonalModal.style.display = 'none';
        document.getElementById('close-local-modal').onclick = () => editLocalModal.style.display = 'none';
        document.getElementById('close-schedule-config-modal').onclick = () => scheduleConfigModal.style.display = 'none';
        document.getElementById('btn-cancelar-horarios').onclick = () => scheduleConfigModal.style.display = 'none';
        document.getElementById('close-ai-analysis-modal').onclick = () => document.getElementById('ai-analysis-modal').style.display = 'none';
        
        document.getElementById('copy-ai-analysis').onclick = () => {
            const content = document.getElementById('ai-analysis-content');
            const textArea = document.createElement("textarea");
            textArea.value = content.innerText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showStatusMessage('An√°lisis copiado al portapapeles.');
            } catch (err) {
                showStatusMessage('No se pudo copiar el an√°lisis.', 'error');
            }
            document.body.removeChild(textArea);
        };
        
        semanaInputMapeo.addEventListener('change', (e) => { 
            const week = e.target.value;
            state.selectedWeek = week;
            semanaInputProgramacion.value = week; 
            semanaInputPlanillas.value = week;
            listenToWeekData(week);
        });
        semanaInputProgramacion.addEventListener('change', (e) => { 
            const week = e.target.value;
            state.selectedWeek = week; 
            semanaInputMapeo.value = week; 
            semanaInputPlanillas.value = week;
            listenToWeekData(week);
        });
        semanaInputPlanillas.addEventListener('change', (e) => { 
             const week = e.target.value;
             state.selectedWeek = week;
             semanaInputMapeo.value = week;
             semanaInputProgramacion.value = week;
             listenToWeekData(week);
        });
        
        busquedaProgramacionInput.addEventListener('input', debounce(e => { state.searchTermProgramacion = e.target.value.toLowerCase().trim(); renderizarProgramacionPersonal(); }));
        busquedaTarifarioInput.addEventListener('input', debounce(e => { state.searchTermTarifario = e.target.value.toLowerCase().trim(); renderizarTarifario(); }));
        filtroLocalBusquedaInput.addEventListener('input', debounce(e => { state.searchTermMapeo = e.target.value.toLowerCase().trim(); renderizarMapeo(); }));
        
        // --- Funciones de Utilidad ---
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                confirmationModalText.textContent = message;
                confirmationModal.style.display = 'block';

                const confirmHandler = () => {
                    confirmationModal.style.display = 'none';
                    resolve(true);
                };

                const cancelHandler = () => {
                    confirmationModal.style.display = 'none';
                    resolve(false);
                };

                confirmationModalConfirm.addEventListener('click', confirmHandler, { once: true });
                confirmationModalCancel.addEventListener('click', cancelHandler, { once: true });
            });
        }
        
        function obtenerSugerenciaInteligente(local, dia) {
            const week = state.selectedWeek;
            const asignacionesSemana = state.asignaciones[week] || {};

            const assignedToday = new Set();
            Object.keys(asignacionesSemana).forEach(slotId => {
                if (slotId.includes(`-${dia}-`)) {
                    const personId = asignacionesSemana[slotId];
                    if (personId) {
                        assignedToday.add(personId);
                    }
                }
            });

            const availablePersonnel = state.personal.filter(p => 
                p.disponibilidad === 'disponible' && !assignedToday.has(p.id)
            );

            if (availablePersonnel.length === 0) return [];

            const scores = {};
            availablePersonnel.forEach(p => {
                scores[p.id] = 0;
                if (p.local1 === local) scores[p.id] += 10;
                if (p.local2 === local) scores[p.id] += 7;
                if (p.local3 === local) scores[p.id] += 4;
            });
            
            Object.values(state.historial).forEach(pastWeek => {
                if (pastWeek.asignaciones) {
                    Object.entries(pastWeek.asignaciones).forEach(([slotId, personId]) => {
                        if (slotId.startsWith(local + '-') && scores[personId] !== undefined) {
                            scores[personId] += 5;
                        }
                    });
                }
            });

            const sortedSuggestions = Object.entries(scores)
                .filter(([, score]) => score > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([personId]) => state.personal.find(p => p.id === personId));

            return sortedSuggestions.slice(0, 3).filter(p => p);
        }

        function populateViewPersonalModal(id) {
            const p = state.personal.find(p => p.id === id);
            if (!p) return;
            document.getElementById('view-personal-name').textContent = `${p.nombre} ${p.apellido}`;
            document.getElementById('view-personal-details').innerHTML = `
                <span class="detail-label">N¬∫ Empleado:</span><span>${p.numero_empleado || 'N/A'}</span>
                <span class="detail-label">F. Ingreso:</span><span>${p.fecha_ingreso || 'N/A'}</span>
                <span class="detail-label">F. Nacimiento:</span><span>${p.fecha_nacimiento || 'N/A'}</span>
                <span class="detail-label">Seg. Social:</span><span>${p.seguridad_social || 'N/A'}</span>
                <span class="detail-label">Direcci√≥n:</span><span>${p.direccion || 'N/A'}</span>
                <span class="detail-label">E-mail:</span><span>${p.email || 'N/A'}</span>
                <span class="detail-label">Tel√©fono:</span><span>${p.telefono || 'N/A'}</span>
                <span class="detail-label">Contacto Emergencia:</span><span>${p.contacto_emergencia || 'N/A'}</span>
                <span class="detail-label">Disponibilidad:</span><span>${p.disponibilidad || 'N/A'}</span>
                <span class="detail-label">Locales Pref.:</span><span>${[p.local1, p.local2, p.local3].filter(Boolean).join(', ') || 'N/a'}</span>
            `;
            document.getElementById('btn-editar-personal-view').dataset.id = id;
            document.getElementById('btn-eliminar-personal-view').dataset.id = id;
            viewPersonalModal.style.display = 'block';
        }

        function populateEditPersonalModal(id) {
            const persona = state.personal.find(p => p.id === id);
            if (!persona) return;
            viewPersonalModal.style.display = 'none';
            document.getElementById('personal-modal-title').textContent = 'Editar Personal';
            formPersonal.reset();
            formPersonal['personal-id'].value = id;
            renderizarSelectsLocales(personalModal);
            Object.keys(persona).forEach(key => {
                if (formPersonal.elements[key]) {
                    formPersonal.elements[key].value = persona[key];
                }
            });
            formPersonal.numero_empleado.readOnly = false;
            personalModal.style.display = 'block';
        }

        function exportarBaseDatosPersonal() {
            if (state.personal.length === 0) return showStatusMessage('No hay personal para exportar.', 'error');
            const worksheet = XLSX.utils.json_to_sheet(state.personal);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Personal');
            XLSX.writeFile(workbook, `Base_Datos_Personal_SwattMapee.xlsx`);
        }

        async function reemplazarBaseDatosDesdeExcel(file) {
            if (!file) return;

            const confirmed = await showConfirmationModal(
                "¬øEst√°s seguro de que deseas reemplazar TODA la base de datos del personal con este archivo? El personal que no est√© en el Excel ser√° eliminado. Esta acci√≥n no se puede deshacer."
            );
            if (!confirmed) {
                importPersonalInput.value = ''; 
                return;
            }
            
            loader.style.display = 'flex';
            const reader = new FileReader();

            reader.onload = async (event) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    if (jsonData.length > 0 && jsonData[0].id === undefined) {
                        throw new Error("El archivo Excel no es v√°lido. Debe ser uno exportado desde esta aplicaci√≥n y contener la columna 'id'.");
                    }
                    
                    const newPersonalData = jsonData;
                    const oldPersonalData = state.personal;

                    const newIds = new Set(newPersonalData.map(p => p.id).filter(Boolean));
                    const oldIds = new Set(oldPersonalData.map(p => p.id));

                    const toAdd = newPersonalData.filter(p => !p.id);
                    const toUpdate = newPersonalData.filter(p => p.id && oldIds.has(p.id));
                    const toDelete = oldPersonalData.filter(p => !newIds.has(p.id));

                    const batch = writeBatch(db);

                    toDelete.forEach(p => {
                        batch.delete(doc(personalCol, p.id));
                    });

                    toUpdate.forEach(p => {
                        const { id, ...data } = p;
                        batch.set(doc(personalCol, id), data);
                    });

                    toAdd.forEach(p => {
                        const { id, ...data } = p;
                        const newDocRef = doc(personalCol);
                        batch.set(newDocRef, data);
                    });

                    await batch.commit();

                    showStatusMessage(`Base de datos actualizada: ${toUpdate.length} actualizados, ${toAdd.length} agregados, ${toDelete.length} eliminados.`, 'success');

                } catch (error) {
                    console.error("Error al reemplazar la base de datos:", error);
                    showStatusMessage(error.message || 'Error al procesar el archivo Excel.', 'error');
                } finally {
                    loader.style.display = 'none';
                    importPersonalInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        const debouncedRender = debounce(renderCurrentView, 100);

        function debounce(func, delay = 250) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        Date.prototype.getWeek = function() {
            const date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getWeekDates(weekString) {
            if (!weekString) return {};
            const [year, weekNum] = weekString.split('-W').map(Number);
            const firstDayOfYear = new Date(year, 0, 1);
            const dayOfWeek = (firstDayOfYear.getDay() + 6) % 7; // Monday is 0
            const date = new Date(year, 0, 1 + (weekNum - 1) * 7 - dayOfWeek);
            const dates = {};
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(date);
                currentDay.setDate(date.getDate() + i);
                dates[diasSemana[i]] = currentDay.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            }
            return dates;
        }

        function inicializarApp() {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }
            
            semanaInputMapeo.value = state.selectedWeek;
            semanaInputProgramacion.value = state.selectedWeek;
            semanaInputPlanillas.value = state.selectedWeek;
            cambiarVista('mapeo');
            loader.style.display = 'none';
            // Inicia el actualizador peri√≥dico para las alertas de tiempo
            setInterval(() => {
                if ((state.currentView === 'mapeo' || state.currentView === 'programacion') && listenersAreActive) {
                    renderCurrentView();
                }
            }, 30 * 1000); // Se actualiza cada 30 segundos
        }

        function cambiarVista(vista) {
            state.currentView = vista;
            const searchFab = document.getElementById('search-fab');
            if (vista === 'mapeo') {
                searchFab.style.display = 'block';
            } else {
                searchFab.style.display = 'none';
            }
            allSections.forEach(s => s.classList.add('hidden'));
            navButtons.forEach(b => b.classList.remove('active'));
            document.getElementById(`section-${vista}`).classList.remove('hidden');
            const activeButton = document.getElementById(`btn-${vista}`);
            activeButton.classList.add('active');
            mainTitle.textContent = activeButton.textContent;
            renderCurrentView();
        }
        
        // --- Eventos de Nueva Navegaci√≥n ---
        const menuToggle = document.getElementById('menu-toggle');
        const sideNav = document.getElementById('side-nav');
        menuToggle.addEventListener('click', () => sideNav.classList.toggle('open'));
        sideNav.addEventListener('mouseleave', () => sideNav.classList.remove('open'));
        navButtons.forEach(btn => btn.addEventListener('click', () => {
            cambiarVista(btn.id.split('-')[1]);
            sideNav.classList.remove('open');
        }));

        // --- Eventos de B√∫squeda Flotante ---
        const searchFab = document.getElementById('search-fab');
        const searchPanel = document.getElementById('search-panel');
        searchFab.addEventListener('click', (e) => {
            e.stopPropagation();
            searchPanel.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
            if (!searchPanel.contains(e.target) && !searchFab.contains(e.target)) {
                searchPanel.classList.remove('open');
            }
        });


        themeToggleBtn.addEventListener('click', function() {
            darkIcon.classList.toggle('hidden');
            lightIcon.classList.toggle('hidden');
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            if(state.currentView === 'historial') {
                renderizarHistorial();
            }
        });

        // --- SISTEMA DE NOTIFICACIONES Y CONFLICTOS ---
        function triggerDelayedNotificationAlert(slotId, week) {
            const notificationKey = `${week}-${slotId}`;
            if (state.notifiedChanges.has(notificationKey)) {
                return;
            }
            
            const [local] = slotId.split('-');
            showStatusMessage(`Alerta: Cambio en ${local.toUpperCase()} no ha sido confirmado.`, 'error');

            state.notifiedChanges.add(notificationKey);
        }

        function recalculateConflicts() {
            const week = state.selectedWeek;
            if (!week || !state.asignaciones[week]) return;
            const asignacionesSemana = state.asignaciones[week];

            state.redConflicts.clear();
            state.yellowConflicts.clear();
            state.celesteConflicts.clear();
            
            const assignmentsByPerson = {};
            Object.entries(asignacionesSemana).forEach(([slotId, personaId]) => {
                if (!personaId || typeof personaId !== 'string' || !slotId.includes('-') || slotId.includes('-vestimenta') || slotId.includes('-confirmed')) return;
                if (!assignmentsByPerson[personaId]) assignmentsByPerson[personaId] = [];
                const [local, dia, tipo] = slotId.split('-');
                if(!tipo) return;
                const config = state.mapeoConfig[local]?.[dia];
                if (!config) return;

                const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                
                const startMinutes = diasSemana.indexOf(dia) * 1440 + timeToMinutes(horaEntrada);
                let endMinutes = diasSemana.indexOf(dia) * 1440 + timeToMinutes(horaSalida);

                if (endMinutes < startMinutes) { // Overnight shift
                    endMinutes += 1440;
                }

                assignmentsByPerson[personaId].push({
                    weekSlotId: `${week}-${slotId}`, dia, local, tipo,
                    startMinutes,
                    endMinutes
                });
            });

            for (const personaId in assignmentsByPerson) {
                const personAssignments = assignmentsByPerson[personaId].sort((a, b) => a.startMinutes - b.startMinutes);

                for (let i = 0; i < personAssignments.length; i++) {
                     for (let j = i + 1; j < personAssignments.length; j++) {
                        const first = personAssignments[i];
                        const second = personAssignments[j];

                        // Check for direct overlap (Red Conflict)
                        if (first.startMinutes < second.endMinutes && second.startMinutes < first.endMinutes) {
                            state.redConflicts.add(first.weekSlotId);
                            state.redConflicts.add(second.weekSlotId);
                        }
                        // Check for insufficient rest (Yellow Conflict)
                        else if (second.startMinutes - first.endMinutes < 480 && second.startMinutes > first.endMinutes) { // Less than 8 hours
                            state.yellowConflicts.add(first.weekSlotId);
                            state.yellowConflicts.add(second.weekSlotId);
                        }
                     }
                }
                
                // Group assignments by day and local to check for role conflicts
                const assignmentsByDayAndLocal = personAssignments.reduce((acc, a) => {
                    const key = `${a.dia}|${a.local}`;
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(a);
                    return acc;
                }, {});

                // For each group (same person, day, and local), check for conflicting roles
                Object.values(assignmentsByDayAndLocal).forEach(group => {
                    if (group.length < 2) return; // A conflict requires at least two different roles

                    const rolesInGroup = new Set(group.map(a => a.tipo));
                    const hasPuesto = rolesInGroup.has('puestos');
                    // Check for any type of "Cacheo" role
                    const hasCacheo = rolesInGroup.has('cacheos') || rolesInGroup.has('cacheoIngreso') || rolesInGroup.has('cacheoSalida');
                    
                    // If a person is both a regular "Puesto" and a "Cacheo" on the same day/local, flag it.
                    if (hasPuesto && hasCacheo) {
                        group.forEach(assignment => state.celesteConflicts.add(assignment.weekSlotId));
                    }
                });
            }
            
            // Conflict Priority: Red > Celeste > Yellow
            state.redConflicts.forEach(id => { state.yellowConflicts.delete(id); state.celesteConflicts.delete(id); });
            state.celesteConflicts.forEach(id => state.yellowConflicts.delete(id));
        }
        
        // --- FUNCIONES DE COPIADO, MENSAJER√çA E IA ---
        async function callGeminiAPI(systemPrompt, userQuery) {
            const apiKey = ""; // Dejar como est√°, manejado por el entorno
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error('Respuesta inesperada de la API de Gemini.');
                        }
                    } else {
                        throw new Error(`Error de red: ${response.statusText}`);
                    }
                } catch (error) {
                    retries--;
                    if (retries === 0) {
                        console.error("Error al llamar a la API de Gemini despu√©s de varios intentos:", error);
                        return `Error: No se pudo obtener el an√°lisis de la IA. Por favor, int√©ntelo de nuevo m√°s tarde. Detalles: ${error.message}`;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Backoff exponencial
                }
            }
        }
        
        async function analizarSemanaConIA(week) {
            const data = state.historial[week];
            if (!data || !data.asignaciones) {
                showStatusMessage('No hay suficientes datos hist√≥ricos para analizar esta semana.', 'error');
                return;
            }

            loader.style.display = 'flex';
            document.getElementById('ai-analysis-content').innerHTML = '<p>Analizando datos con IA, por favor espere...</p>';
            document.getElementById('ai-analysis-modal').style.display = 'block';

            const asignaciones = data.asignaciones;
            const personalCount = {};
            const localCount = {};
            let totalAsignaciones = 0;

            Object.keys(asignaciones).forEach(slotId => {
                if (slotId.includes('-vestimenta') || slotId.includes('-confirmed')) return;
                const personaId = asignaciones[slotId];
                if (personaId && typeof personaId === 'string') {
                    totalAsignaciones++;
                    const [localNombre] = slotId.split('-');
                    personalCount[personaId] = (personalCount[personaId] || 0) + 1;
                    localCount[localNombre] = (localCount[localNombre] || 0) + 1;
                }
            });
            
            const uniquePersonal = Object.keys(personalCount).length;

            const topPersonal = Object.entries(personalCount)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3)
                .map(([id, count]) => {
                    const p = state.personal.find(p => p.id === id);
                    return `${p ? p.nombre + ' ' + p.apellido : 'Desconocido'} (${count} turnos)`;
                }).join(', ');

            const topLocales = Object.entries(localCount)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3)
                .map(([nombre, count]) => `${nombre.toUpperCase()} (${count} turnos)`).join(', ');
                
            const pagoNetoTotal = data.payrollSummary?.pagoNetoTotal || 0;

            const promptData = `
                - Semana: ${week}
                - Total de asignaciones (turnos cubiertos): ${totalAsignaciones}
                - Total de personal √∫nico involucrado: ${uniquePersonal}
                - Personal m√°s activo: ${topPersonal}
                - Locales con mayor actividad: ${topLocales}
                - Costo total de planilla (pago neto): S/ ${pagoNetoTotal.toFixed(2)}
            `;

            const systemPrompt = `Eres un analista de operaciones para una empresa de seguridad llamada SWAT. Tu tarea es analizar el resumen de la programaci√≥n semanal y proporcionar un informe conciso y profesional en espa√±ol.`;

            const userQuery = `Basado en los siguientes datos, genera un resumen de 3 a 4 p√°rrafos que incluya:
                1. Una visi√≥n general del volumen de trabajo de la semana.
                2. Un reconocimiento especial al personal m√°s activo.
                3. Identifica los locales con mayor demanda.
                4. Menciona el costo total de la planilla como un indicador de la operaci√≥n.
                5. Proporciona una conclusi√≥n breve sobre la eficiencia operativa de la semana.
                El tono debe ser profesional pero alentador.
                Aqu√≠ est√°n los datos:
                ${promptData}
            `;
            
            const analysisResult = await callGeminiAPI(systemPrompt, userQuery);

            loader.style.display = 'none';
            
            let formattedResult = analysisResult
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\* (.*?)(<br>|$)/g, '<li>$1</li>');
            if(formattedResult.includes('<li>')){
                formattedResult = `<ul>${formattedResult.replace(/<br><li>/g, '<li>')}</ul>`.replace(/<\/li><br>/g, '</li>');
            }
            
            document.getElementById('ai-analysis-content').innerHTML = formattedResult;
        }

        async function clearPendingNotificationsForPerson(personId) {
            const week = state.selectedWeek;
            if (!week || !personId) return;

            const updates = {};
            const asignacionesSemana = state.asignaciones[week] || {};

            Object.keys(asignacionesSemana).forEach(slotId => {
                // Clear timestamp if the person matches and a timestamp exists
                if (asignacionesSemana[slotId] === personId && asignacionesSemana[`${slotId}-changeTimestamp`]) {
                    updates[`${slotId}-changeTimestamp`] = deleteField();
                }
            });

            if (Object.keys(updates).length > 0) {
                try {
                    await updateDoc(doc(db, asignacionesCol.path, week), updates);
                    showStatusMessage('Recordatorios de notificaci√≥n limpiados para este trabajador.');
                } catch (error) {
                    console.error("Error clearing pending notifications:", error);
                }
            }
        }


        function getPersonalScheduleMessage(personId) {
            const persona = state.personal.find(p => p.id === personId);
            if (!persona) return { error: 'Persona no encontrada.' };
            
            const week = state.selectedWeek;
            const asignacionesSemana = state.asignaciones[week] || {};

            const assignments = Object.entries(asignacionesSemana)
                .filter(([slotId, pId]) => pId === personId && slotId.includes('-') && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed'))
                .map(([slotId, _]) => {
                    const [local, dia, tipo] = slotId.split('-');
                    const config = state.mapeoConfig[local]?.[dia] || {};
                    const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                    return { dia, local, raw_tipo: tipo, vestimenta: asignacionesSemana[`${slotId}-vestimenta`] || vestimentaOptions[0], hora: horaEntrada || 'N/A' };
                });

            if (assignments.length === 0) {
                return { error: 'Esta persona no tiene asignaciones para esta semana.' };
            }

            const groupedByDay = assignments.reduce((acc, a) => {
                if (!acc[a.dia]) acc[a.dia] = [];
                acc[a.dia].push(a);
                return acc;
            }, {});
            
            let message = `¬°Hola ${persona.nombre}! Tu programaci√≥n es la siguiente:\n\n`;
            const sortedDays = Object.keys(groupedByDay).sort((a, b) => diasSemana.indexOf(a) - diasSemana.indexOf(b));

            sortedDays.forEach(dia => {
                const dailyAssignments = groupedByDay[dia];
                let mainAssignment = dailyAssignments.find(a => a.raw_tipo.includes('puesto') || a.raw_tipo.includes('turno'));
                if (!mainAssignment) {
                    dailyAssignments.sort((a, b) => timeToMinutes(a.hora) - timeToMinutes(b.hora));
                    mainAssignment = dailyAssignments[0];
                }
                const ingresoCacheo = dailyAssignments.find(a => a.raw_tipo === 'cacheoIngreso');
                const displayTime = ingresoCacheo ? ingresoCacheo.hora : mainAssignment.hora;
                const allCacheos = dailyAssignments.filter(a => a.raw_tipo.toLowerCase().includes('cacheo'));
                const local = mainAssignment.local.toUpperCase();
                const diaSemana = diasSemanaFull[diasSemana.indexOf(dia)];
                const vestimenta = mainAssignment.vestimenta;

                let cacheoInfo = '';
                if (allCacheos.length > 0) {
                    allCacheos.sort((a, b) => {
                        const order = { 'cacheoIngreso': 1, 'cacheos': 2, 'cacheoSalida': 3 };
                        return (order[a.raw_tipo] || 99) - (order[b.raw_tipo] || 99);
                    });
                    cacheoInfo = ` + (${allCacheos.map(c => tipoPuestoNombres[c.raw_tipo] || c.raw_tipo).join(', ')})`;
                }
                message += `‚Ä¢ ${diaSemana} en ${local}: ${displayTime} Vestimenta: ${vestimenta}.${cacheoInfo}\n`;
            });
            message += `\nMANDAME TU CONFIRMACI√ìN ‚úÖ`;
            return { message };
        }

        function copyPersonalSchedule(personId) {
            const { message, error } = getPersonalScheduleMessage(personId);
            if (error) {
                showStatusMessage(error, 'error');
                return;
            }
            const textArea = document.createElement("textarea");
            textArea.value = message.trim();
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showStatusMessage('Programaci√≥n copiada');
                clearPendingNotificationsForPerson(personId);
            } catch (err) {
                showStatusMessage('No se pudo copiar el texto.', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function sendWhatsappMessage(personId) {
            const persona = state.personal.find(p => p.id === personId);
            if (!persona || !persona.telefono) {
                showStatusMessage('Esta persona no tiene un n√∫mero de tel√©fono guardado.', 'error');
                return;
            }
            const { message, error } = getPersonalScheduleMessage(personId);
            if (error) {
                showStatusMessage(error, 'error');
                return;
            }
            let phone = String(persona.telefono).replace(/\D/g, '');
            if (!phone.startsWith('51')) {
                phone = '51' + phone;
            }
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            clearPendingNotificationsForPerson(personId);
        }

        function copyLocalSchedule(localNombre) {
            const week = state.selectedWeek;
            if (!week) return showStatusMessage('Por favor, selecciona una semana.', 'error');
            const asignacionesSemana = state.asignaciones[week] || {};
            
            const assignedPersonnelByDay = {};

            Object.entries(asignacionesSemana).forEach(([slotId, pId]) => {
                if (slotId.startsWith(localNombre + '-') && pId && typeof pId === 'string' && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed')) {
                    const [local, dia, tipo, i] = slotId.split('-');
                    if (!assignedPersonnelByDay[dia]) {
                        assignedPersonnelByDay[dia] = [];
                    }
                    const persona = state.personal.find(p => p.id === pId);
                    const config = state.mapeoConfig[local]?.[dia] || {};
                    const horaKey = `hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                    if (persona) {
                        assignedPersonnelByDay[dia].push({
                            persona,
                            puesto: `${tipoPuestoNombres[tipo] || tipo} ${i}`,
                            hora: config[horaKey] || 'N/A'
                        });
                    }
                }
            });

            if (Object.keys(assignedPersonnelByDay).length === 0) {
                return showStatusMessage('Este local no tiene personal asignado para copiar.', 'error');
            }
            
            let message = `Programaci√≥n ${localNombre.toUpperCase()}\n\n`;

            diasSemana.forEach((dia, index) => {
                const personnel = assignedPersonnelByDay[dia];
                if (personnel && personnel.length > 0) {
                    message += `${diasSemanaFull[index]}\n`;
                    personnel.forEach(p => {
                         message += `- ${p.persona.nombre} ${p.persona.apellido}\n`;
                    });
                    message += '\n'; 
                }
            });
            
            const textArea = document.createElement("textarea");
            textArea.value = message.trim();
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showStatusMessage('Programaci√≥n del local copiada');
            } catch (err) {
                showStatusMessage('No se pudo copiar el texto.', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function descargarExcel(week, scheduleData) {
            if (!scheduleData?.asignaciones) return showStatusMessage(`No hay datos para la semana ${week}.`, 'error'); 
            const data = Object.entries(scheduleData.asignaciones)
                .filter(([slotId, pId]) => pId && typeof pId === 'string' && slotId.includes('-') && !slotId.includes('-vestimenta') && !slotId.includes('-confirmed'))
                .map(([slotId, pId]) => {
                    const [local, dia, tipo] = slotId.split('-');
                    const persona = state.personal.find(p => p.id === pId);
                    const config = (scheduleData.mapeoConfig?.[local]?.[dia]) || state.mapeoConfig[local]?.[dia] || {};
                    const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                    const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                    return {
                        'Fecha': getWeekDates(week)[dia] || 'N/A', 'D√≠a': diasSemanaFull[diasSemana.indexOf(dia)],
                        'Local': local.toUpperCase(), 'Puesto': tipoPuestoNombres[tipo] || tipo,
                        'Nombre': persona ? `${persona.nombre} ${persona.apellido}` : 'N/A',
                        'Hora Entrada': horaEntrada,
                        'Hora Salida': horaSalida,
                        'Vestimenta': scheduleData.asignaciones[`${slotId}-vestimenta`] || vestimentaOptions[0]
                    };
                });
            if (data.length === 0) return showStatusMessage('No hay asignaciones v√°lidas para descargar.', 'error');
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Programacion');
            XLSX.writeFile(workbook, `Programacion_${week}.xlsx`);
        }
        function showStatusMessage(message, type = 'success') {
            const container = document.getElementById('status-message-container');
            const div = document.createElement('div');
            div.className = `${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white font-bold rounded-lg shadow-lg py-3 px-5 transition-all duration-300 transform translate-x-full`;
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => div.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                div.classList.add('translate-x-full');
                setTimeout(() => div.remove(), 3000);
            }, 3000);
        }
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const match = timeStr.match(/(\d+):(\d+) (AM|PM)/);
            if (!match) return 0;
            let [, hours, minutes, ampm] = match;
            hours = parseInt(hours, 10);
            if (ampm === 'PM' && hours !== 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            return hours * 60 + parseInt(minutes, 10);
        }
        
        function calculateShiftDuration(startStr, endStr) {
            if (!startStr || !endStr) return 0;
            let startMinutes = timeToMinutes(startStr);
            let endMinutes = timeToMinutes(endStr);
            if (endMinutes < startMinutes) {
                endMinutes += 1440; // Add 24 hours for overnight shifts
            }
            return (endMinutes - startMinutes) / 60;
        }

        // --- NEW PDF GENERATION LOGIC ---
        const PDF_LINE_HEIGHT = 6;

        function addLocalDataToPdf(doc, localNombre) {
            const week = state.selectedWeek;
            if (!week) {
                showStatusMessage('Por favor, selecciona una semana.', 'error');
                return;
            }

            const asignacionesSemana = state.asignaciones[week] || {};
            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = margin + 15; // Start position

            // Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(localNombre.toUpperCase(), pageWidth / 2, margin, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Semana ${week}`, pageWidth / 2, margin + 7, { align: 'center' });

            const orderedDays = diasSemana.filter(dia =>
                Object.keys(asignacionesSemana).some(slotId => slotId.startsWith(`${localNombre}-${dia}-`) && asignacionesSemana[slotId])
            );

            if (orderedDays.length === 0) {
                doc.text("No hay personal asignado para esta semana.", margin, y + 10);
                return;
            }

            orderedDays.forEach(dia => {
                if (y > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(diasSemanaFull[diasSemana.indexOf(dia)], margin, y);
                y += 7;

                const dailyAssignments = Object.entries(asignacionesSemana)
                    .filter(([slotId, pId]) => slotId.startsWith(`${localNombre}-${dia}-`) && pId && typeof pId === 'string' && !slotId.endsWith('-vestimenta') && !slotId.endsWith('-confirmed'))
                    .map(([slotId, pId]) => {
                        const [, , tipo] = slotId.split('-');
                        const persona = state.personal.find(p => p.id === pId);
                        const config = state.mapeoConfig[localNombre]?.[dia] || {};
                        const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                        const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                        const horario = (horaEntrada && horaSalida) ? `${horaEntrada} - ${horaSalida}` : horaEntrada;
                        return {
                            puesto: tipoPuestoNombres[tipo] || tipo,
                            nombre: persona ? `${persona.nombre} ${persona.apellido}` : 'N/A',
                            hora: horario || 'N/A'
                        };
                    }).sort((a,b) => timeToMinutes(a.hora) - timeToMinutes(b.hora));

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                dailyAssignments.forEach((asig, index) => {
                    if (y > doc.internal.pageSize.getHeight() - 10) {
                        doc.addPage();
                        y = margin;
                    }
                    const text = `${index + 1}. ${asig.puesto}: ${asig.nombre} (${asig.hora})`;
                    doc.text(text, margin + 5, y);
                    y += PDF_LINE_HEIGHT;
                });
                y += 4; // Space between days
            });
        }
        
        function drawLocalBox(doc, localData, x, y, width) {
            const margin = 5;
            const lineHeight = PDF_LINE_HEIGHT;
            const headerHeight = 10;
            const contentWidth = width - (margin * 2);
            let currentY = y;
            const originalTextColor = doc.getTextColor();
            const originalFillColor = doc.getFillColor();
            const originalDrawColor = doc.getDrawColor();
            const boxHeight = getBoxHeight(doc, localData, width);

            // Box border and header
            doc.setDrawColor(200);
            doc.rect(x, y, width, boxHeight);
            doc.setFillColor(localData.color || '#cccccc');
            doc.rect(x, y, width, headerHeight, 'F');

            // Header text
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text(localData.nombre.toUpperCase(), x + width / 2, y + headerHeight / 2 + 2, { align: 'center' });
            currentY += headerHeight + margin;

            // Content
            doc.setTextColor(0, 0, 0);
            const orderedDays = diasSemana.filter(dia => localData.assignmentsByDay[dia]);

            if (orderedDays.length === 0) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.text("No hay asignaciones", x + margin, currentY);
            } else {
                orderedDays.forEach(dia => {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(diasSemanaFull[diasSemana.indexOf(dia)], x + margin, currentY);
                    currentY += lineHeight;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    localData.assignmentsByDay[dia].forEach((asig, index) => {
                        const text = `${index + 1}. ${asig.puesto}: ${asig.nombre} (${asig.hora})`;
                        const lines = doc.splitTextToSize(text, contentWidth - 3);
                        if (currentY + (lines.length * lineHeight) > y + boxHeight - margin) return;
                        doc.text(lines, x + margin + 3, currentY);
                        currentY += lines.length * lineHeight;
                    });
                    currentY += 2; // Space between days
                });
            }

            // Reset colors
            doc.setTextColor(originalTextColor);
            doc.setFillColor(originalFillColor);
            doc.setDrawColor(originalDrawColor);
            return y + boxHeight;
        }

        function downloadLocalAsPDF(localNombre) {
            loader.style.display = 'flex';
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                addLocalDataToPdf(doc, localNombre);
                doc.save(`Programacion_${localNombre.replace(/\s+/g, '_')}_${state.selectedWeek}.pdf`);
                showStatusMessage('PDF generado correctamente.', 'success');
            } catch (e) {
                console.error("Error al generar PDF:", e);
                showStatusMessage('Error al generar el PDF.', 'error');
            } finally {
                loader.style.display = 'none';
            }
        }

        async function downloadAllLocalsAsPDF() {
            const visibleLocales = Array.from(document.querySelectorAll('#mapeo-container .local-card'))
                                        .map(card => card.id.replace('local-card-', '').replace(/-/g, ' '));
            if (visibleLocales.length === 0) {
                showStatusMessage('No hay locales visibles para descargar.', 'error');
                return;
            }

            showStatusMessage('Generando PDF de todos los locales...', 'success');
            loader.style.display = 'flex';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const week = state.selectedWeek;
                const margin = 10;
                const gap = 5;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const boxWidth = (pageWidth - (margin * 2) - gap) / 2;
                let pageNum = 1;

                const addPageHeader = (pNum) => {
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Programaci√≥n de Locales`, pageWidth / 2, margin, { align: 'center' });
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Semana ${week}`, pageWidth / 2, margin + 7, { align: 'center' });
                    if (pNum > 1) {
                         doc.setFontSize(8);
                         doc.text(`P√°gina ${pNum}`, pageWidth - margin, pageHeight - 5, { align: 'right' });
                    }
                    return margin + 20;
                };
                
                let startY = addPageHeader(pageNum);
                let colHeights = [startY, startY];

                for (const localNombre of visibleLocales) {
                    const local = state.locales.find(l => l.nombre === localNombre);
                    const asignacionesSemana = state.asignaciones[week] || {};
                    const assignmentsByDay = {};
                     diasSemana.forEach(dia => {
                        const dailyAssignments = Object.entries(asignacionesSemana)
                            .filter(([slotId, pId]) => slotId.startsWith(`${localNombre}-${dia}-`) && pId && typeof pId === 'string' && !slotId.endsWith('-vestimenta') && !slotId.endsWith('-confirmed'))
                            .map(([slotId, pId]) => {
                                const [, , tipo] = slotId.split('-');
                                const persona = state.personal.find(p => p.id === pId);
                                const config = state.mapeoConfig[localNombre]?.[dia] || {};
                                const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                                const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                                const horario = (horaEntrada && horaSalida) ? `${horaEntrada} - ${horaSalida}` : horaEntrada;
                                return {
                                    puesto: tipoPuestoNombres[tipo] || tipo,
                                    nombre: persona ? `${persona.nombre} ${persona.apellido}` : 'N/A',
                                    hora: horario || 'N/A'
                                };
                            }).sort((a,b) => timeToMinutes(a.hora) - timeToMinutes(b.hora));
                        if (dailyAssignments.length > 0) assignmentsByDay[dia] = dailyAssignments;
                    });

                    const localData = { nombre: localNombre, color: local?.color, assignmentsByDay };
                    const boxHeight = getBoxHeight(new jsPDF(), localData, boxWidth);

                    let targetColumn = colHeights[0] <= colHeights[1] ? 0 : 1;
                    
                    if (colHeights[targetColumn] + boxHeight + gap > pageHeight - margin) {
                        targetColumn = (targetColumn + 1) % 2;
                    }
                    
                    if (colHeights[targetColumn] + boxHeight + gap > pageHeight - margin) {
                        doc.addPage();
                        pageNum++;
                        startY = addPageHeader(pageNum);
                        colHeights = [startY, startY];
                        targetColumn = 0;
                    }

                    const cursorX = margin + (targetColumn * (boxWidth + gap));
                    const cursorY = colHeights[targetColumn];
                    
                    drawLocalBox(doc, localData, cursorX, cursorY, boxWidth);
                    colHeights[targetColumn] += boxHeight + gap;
                }

                doc.save(`Programacion_Completa_${week}.pdf`);
            } catch (e) {
                console.error("Error al generar PDF:", e);
                showStatusMessage('Error al generar el PDF.', 'error');
            } finally {
                loader.style.display = 'none';
            }
        }

        function getBoxHeight(doc, localData, boxWidth) {
            const margin = 5;
            const headerHeight = 10;
            const lineHeight = PDF_LINE_HEIGHT;
            let totalHeight = headerHeight + margin * 2;
            const contentWidth = boxWidth - (margin * 2);
            
            const orderedDays = diasSemana.filter(dia => localData.assignmentsByDay[dia]);

            if (orderedDays.length > 0) {
                orderedDays.forEach(dia => {
                    totalHeight += lineHeight;
                    localData.assignmentsByDay[dia].forEach((asig, index) => {
                        const text = `${index + 1}. ${asig.puesto}: ${asig.nombre} (${asig.hora})`;
                        const lines = doc.splitTextToSize(text, contentWidth - 3);
                        totalHeight += lines.length * lineHeight;
                    });
                    totalHeight += 2;
                });
            } else {
                totalHeight += lineHeight;
            }
            return Math.max(totalHeight, 30);
        }

        function createCompletionCircle(percentage) {
            const size = 28;
            const strokeWidth = 3;
            const radius = (size / 2) - strokeWidth;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            let color = '#4ade80'; // green-400
            if (percentage < 50) color = '#f87171'; // red-400
            else if (percentage < 100) color = '#facc15'; // yellow-400

            return `
                <div class="relative" title="Completado al ${percentage.toFixed(0)}%">
                    <svg class="w-7 h-7 transform -rotate-90">
                        <circle class="text-slate-200 dark:text-slate-700" stroke-width="${strokeWidth}" stroke="currentColor" fill="transparent" r="${radius}" cx="${size/2}" cy="${size/2}"/>
                        <circle style="stroke: ${color}; transition: stroke-dashoffset 0.5s ease 0s;"
                            stroke-width="${strokeWidth}"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"
                            stroke-linecap="round"
                            fill="transparent"
                            r="${radius}"
                            cx="${size/2}"
                            cy="${size/2}"/>
                    </svg>
                    <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-slate-600 dark:text-slate-300">${Math.round(percentage)}</span>
                </div>
            `;
        }
        
        function exportarPlanillaExcel() {
            const week = semanaInputPlanillas.value;
            if (!week) {
                showStatusMessage('Por favor, seleccione una semana para exportar.', 'error');
                return;
            }

            const { payrollByLocal, paucarReservas } = calculatePayrollData(week);
             if (Object.keys(payrollByLocal).length === 0 && paucarReservas.length === 0) {
                showStatusMessage('No hay datos de planilla para exportar.', 'error');
                return;
            }

            const resumenData = [];
            const detalleData = [];

            Object.keys(payrollByLocal).sort().forEach(localNombre => {
                Object.values(payrollByLocal[localNombre]).forEach(data => {
                    const { pagoBruto, extra, descuento, pagoNeto } = calculatePagos(data);
                    resumenData.push({
                        'Local': localNombre.toUpperCase(),
                        'Nombre Completo': `${data.nombre} ${data.apellido}`,
                        'Turnos': data.turnosDetalle.length,
                        'Pago Bruto (S/)': pagoBruto,
                        'Extras (S/)': extra,
                        'Descuento (S/)': descuento,
                        'Pago Neto (S/)': pagoNeto,
                    });

                    data.turnosDetalle.forEach(detalle => {
                        detalleData.push({
                            'Local': localNombre.toUpperCase(),
                            'Nombre Completo': `${data.nombre} ${data.apellido}`,
                            'D√≠a': detalle.dia,
                            'Puesto': detalle.tipo,
                        });
                    });
                });
            });

            paucarReservas.forEach((data, index) => {
                const extra = parseFloat(state.planillaConfig[`extra_${data.id}`] || 0);
                resumenData.push({
                    'Local': 'APOYO',
                    'Nombre Completo': `${index + 1}. ${data.nombre}`,
                    'Turnos': data.turnos,
                    'Pago Bruto (S/)': 0,
                    'Extras (S/)': extra,
                    'Descuento (S/)': 0,
                    'Pago Neto (S/)': extra,
                });
            });

            const wsResumen = XLSX.utils.json_to_sheet(resumenData);
            const wsDetalle = XLSX.utils.json_to_sheet(detalleData);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsResumen, "Resumen de Pagos");
            XLSX.utils.book_append_sheet(wb, wsDetalle, "Detalle de Turnos");

            XLSX.writeFile(wb, `Planilla_Semana_${week}.xlsx`);
            showStatusMessage('Planilla exportada a Excel.', 'success');
        }

        function calculatePayrollData(week) {
            const asignacionesSemana = state.asignaciones[week];
            if (!asignacionesSemana) return { payrollByLocal: {}, paucarReservas: [] };

            const payrollByLocal = {};
            const paucarReservasData = {};

            for (const slotId in asignacionesSemana) {
                const personaId = asignacionesSemana[slotId];
                if (!personaId || typeof personaId !== 'string' || !slotId.includes('-')) continue;

                const [local, dia, tipo] = slotId.split('-');
                
                const isReserva = personaId.toLowerCase().includes('paucar reserva');

                if (!isReserva) {
                    const persona = state.personal.find(p => p.id === personaId);
                    if (!persona) continue;
                    
                    if (!payrollByLocal[local]) {
                        payrollByLocal[local] = {};
                    }
                    if (!payrollByLocal[local][personaId]) {
                        payrollByLocal[local][personaId] = { ...persona, turnos: [], turnosDetalle: [], workedDays: new Set(), hizoCacheo: false, tuvoTurnoLargo: false };
                    }
                    
                    const data = payrollByLocal[local][personaId];
                    const config = state.mapeoConfig[local]?.[dia];
                    if (!config) continue;

                    const horaEntrada = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Entrada`];
                    const horaSalida = config[`hora${tipo.charAt(0).toUpperCase() + tipo.slice(1)}Salida`];
                    
                    const duracionHoras = calculateShiftDuration(horaEntrada, horaSalida);
                    const isLongShift = duracionHoras >= 12;
                    const vestimenta = asignacionesSemana[`${slotId}-vestimenta`] || vestimentaOptions[0];
                    const vestimentaKey = vestimenta === 'Terno' ? 'Terno' : 'Tactica';
                    const hizoCacheo = tipo.toLowerCase().includes('cacheo');
                    
                    data.turnos.push({ 
                        vestimenta: vestimentaKey, 
                        isLong: isLongShift
                    });
                    data.turnosDetalle.push({
                        dia: diasSemanaFull[diasSemana.indexOf(dia)],
                        local: local.toUpperCase(),
                        tipo: `${tipoPuestoNombres[tipo] || tipo} (${duracionHoras.toFixed(1)}h)`
                    });
                    data.workedDays.add(diasSemana.indexOf(dia));
                    if(hizoCacheo) data.hizoCacheo = true;
                    if(isLongShift) data.tuvoTurnoLargo = true;

                } else { 
                     if (!paucarReservasData[personaId]) {
                        paucarReservasData[personaId] = { id: personaId, nombre: personaId, locales: new Set(), turnos: 1 };
                    } else {
                        paucarReservasData[personaId].turnos++;
                    }
                    paucarReservasData[personaId].locales.add(local.toUpperCase());
                }
            }

            const paucarReservas = Object.values(paucarReservasData).map(reserva => ({
                ...reserva,
                locales: Array.from(reserva.locales)
            }));

            return { payrollByLocal, paucarReservas };
        }
        
        function calculatePagos(data) {
            const tarifasPersona = state.tarifarios[data.id] || {};
            const isReserva = data.nombre.toLowerCase().includes('reserva');
            
            let pagoBruto = isReserva ? 0 : data.turnos.reduce((acc, turno) => {
                const rateKey = `${turno.vestimenta}`;
                const rate = parseFloat(tarifasPersona[rateKey] || 0);
                return acc + rate;
            }, 0);

            if (state.planillaConfig[`apoyo_${data.id}`]) {
                pagoBruto += parseFloat(tarifasPersona['Apoyo'] || 0);
            }

            const extraKey = `extra_${data.id}`;
            const descuentoKey = `descuento_${data.id}`;
            const extra = parseFloat(state.planillaConfig[extraKey] || 0);
            const descuento = parseFloat(state.planillaConfig[descuentoKey] || 0);
            const pagoNeto = pagoBruto + extra - descuento;

            return { pagoBruto, extra, descuento, pagoNeto };
        }

        function createWorkdayBar(workedDaysSet) {
            let barHTML = '<div class="work-day-bar">';
            for(let i=0; i < 7; i++) {
                const isWorked = workedDaysSet.has(i);
                barHTML += `<div class="work-day ${isWorked ? 'worked' : ''}" title="${diasSemanaFull[i]}">${diasSemanaShort[i]}</div>`;
            }
            barHTML += '</div>';
            return barHTML;
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            const fourHours = 4 * 60 * 60 * 1000;
            inactivityTimer = setTimeout(() => {
                showStatusMessage('Sesi√≥n cerrada por inactividad.', 'error');
                loginOverlay.style.display = 'flex';
            }, fourHours);
        }

        function setupSystemStatus() {
            // --- Firestore for Latency Check ---
            const statusRef = doc(db, statusCol.path, 'ping');
             onSnapshot(statusRef, (doc) => {
                const data = doc.data();
                if (data && data.timestamp && typeof data.timestamp.toMillis === 'function') {
                    const latency = Date.now() - data.timestamp.toMillis();
                    updateSystemStatus(latency);
                }
            });
            setInterval(async () => {
                try {
                    await setDoc(statusRef, { timestamp: serverTimestamp() });
                } catch(e) {
                     updateSystemStatus(9999); // Error state
                }
            }, 10000);
        }

        function updateSystemStatus(latency) {
            const icon = document.getElementById('system-status-icon');
            icon.classList.remove('status-green', 'status-yellow', 'status-red');
            if (latency < 800) {
                icon.classList.add('status-green');
                icon.parentElement.title = `Sistema fluido (latencia: ${latency}ms)`;
            } else if (latency < 2000) {
                icon.classList.add('status-yellow');
                icon.parentElement.title = `Sistema con lentitud (latencia: ${latency}ms)`;
            } else {
                icon.classList.add('status-red');
                icon.parentElement.title = `Sistema lento o con problemas (latencia: ${latency}ms)`;
            }
        }

        ['mousemove', 'mousedown', 'keydown'].forEach(evt => {
            window.addEventListener(evt, resetInactivityTimer, false);
        });


    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>



